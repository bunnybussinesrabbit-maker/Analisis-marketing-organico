<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#38bdf8">
<meta name="description" content="Plataforma Estrat√©gica Inteligente de An√°lisis de Marketing Org√°nico para Canc√∫n">
<meta name="keywords" content="Canc√∫n, an√°lisis, marketing, geo-suite, inteligencia de negocios">
<!-- Retain for iOS compatibility (until mobile-web-app-capable is fully adopted by Safari) -->
<meta name="apple-mobile-web-app-capable" content="yes">
<!-- Add this for broader compatibility, including Android and other Chromium-based browsers -->
<meta name="mobile-web-app-capable" content="yes">

<title>Geo-Suite Canc√∫n PRO - Plataforma Estrat√©gica</title>

<!-- Manifest y PWA -->
<link rel="manifest" href="./manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">
<link rel="apple-touch-icon" href="./icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Geo-Suite">

<!-- Librer√≠as -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

<!-- Mapbox -->
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>

<!-- Turf.js para c√°lculos geogr√°ficos -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<!-- M√≥dulos de an√°lisis avanzado (NO son m√≥dulos ES6 a√∫n) -->
<script src="./analytics_module/bayesian_analytics.js"></script>
<script src="./analytics_module/montecarlo_logistics.js"></script>
<script src="./analytics_module/timeseries_forecast.js"></script>
<script src="./analytics_module/genetic_algorithm.js"></script>
<script src="./analytics_module/markov_decisions.js"></script>
<script src="./analytics_module/market_saturation.js"></script>

<!-- Base de conocimiento -->
<script src="./knowledgebase.js"></script>

<!-- Utilidades de mapeo de campos -->
<script src="./utils/fieldMapper.js"></script>

<!-- Herramienta de debugging -->
<script src="./DEBUG_HELPER.js"></script>

<!-- M√≥dulo de an√°lisis cruzado -->
<script src="./analytics_module/cross_analysis.js"></script>

<!-- M√ìDULOS ES6 (Se cargan con type="module") -->
<script type="module">
  // Importar e inicializar m√≥dulos principales
  import { AnalyticsOrchestrator } from './modules_integration.js';
  import { SalesStrategiesCancun } from './openai_strategies.js';
  import { GroqSalesCoach } from './groq_cliente.js';

  // Exponer globalmente para acceso desde HTML
  window.AnalyticsOrchestrator = AnalyticsOrchestrator;
  window.SalesStrategiesCancun = SalesStrategiesCancun;
  window.GroqSalesCoach = GroqSalesCoach;

  // Inicializar orquestador global
  window.analyticsOrchestrator = null;

  console.log('‚úÖ M√≥dulos ES6 cargados y expuestos globalmente');
</script>

<!-- INICIALIZACI√ìN DE ANALYTICS WRAPPER -->
<script>
  // Crear namespace global para funciones anal√≠ticas
  window.Analytics = {
    bayesian: typeof bayesianConversionProbability !== 'undefined' ? bayesianConversionProbability : null,
    monteCarlo: typeof monteCarloLogisticSimulation !== 'undefined' ? monteCarloLogisticSimulation : null,
    timeSeries: typeof timeSeriesAnalysis !== 'undefined' ? timeSeriesAnalysis : null,
    genetic: typeof geneticAlgorithmRouteOptimization !== 'undefined' ? geneticAlgorithmRouteOptimization : null,
    markov: typeof markovDecisionProcess !== 'undefined' ? markovDecisionProcess : null,
    saturation: typeof marketSaturationModel !== 'undefined' ? marketSaturationModel : null,
    cannibalization: typeof cannibalizationAnalysis !== 'undefined' ? cannibalizationAnalysis : null,
    empirical: typeof empiricalProbabilityDistribution !== 'undefined' ? empiricalProbabilityDistribution : null,
    crossAnalysis: typeof CrossDimensionalAnalyzer !== 'undefined' ? new CrossDimensionalAnalyzer() : null
  };

  // Verificar disponibilidad de m√≥dulos anal√≠ticos
  console.log('üìä Analytics wrapper inicializado:', {
    bayesian: window.Analytics.bayesian ? '‚úÖ' : '‚ùå',
    monteCarlo: window.Analytics.monteCarlo ? '‚úÖ' : '‚ùå',
    timeSeries: window.Analytics.timeSeries ? '‚úÖ' : '‚ùå',
    genetic: window.Analytics.genetic ? '‚úÖ' : '‚ùå',
    markov: window.Analytics.markov ? '‚úÖ' : '‚ùå',
    saturation: window.Analytics.saturation ? '‚úÖ' : '‚ùå',
    cannibalization: window.Analytics.cannibalization ? '‚úÖ' : '‚ùå',
    empirical: window.Analytics.empirical ? '‚úÖ' : '‚ùå',
    crossAnalysis: window.Analytics.crossAnalysis ? '‚úÖ' : '‚ùå'
  });
</script>

<style>
/* ============================================
   VARIABLES Y RESET
   ============================================ */
:root {
  --bg-dark: #020617;
  --bg-panel: #0f172a;
  --bg-card: #1e293b;
  --accent-blue: #38bdf8;
  --accent-green: #22c55e;
  --accent-purple: #8b5cf6;
  --accent-pink: #ec4899;
  --danger: #ef4444;
  --warning: #f59e0b;
  --text-primary: #f8fafc;
  --text-secondary: #cbd5e1;
  --border: #334155;
  --success: #10b981;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
  background: var(--bg-dark);
  color: var(--text-primary);
  line-height: 1.6;
  height: 100vh;
  overflow: hidden;
}

/* ============================================
   LAYOUT PRINCIPAL
   ============================================ */
.app-container {
  display: grid;
  grid-template-columns: 280px 1fr;
  min-height: 100vh;
  max-width: 100vw;
  overflow-x: hidden;
}

/* ============================================
   SIDEBAR / PANEL LATERAL
   ============================================ */
.sidebar {
  background: var(--bg-panel);
  border-right: 1px solid var(--border);
  padding: 20px 15px;
  overflow-y: auto;
  position: sticky;
  top: 0;
  height: 100vh;
}

.header {
  padding-bottom: 20px;
  margin-bottom: 20px;
  border-bottom: 1px solid var(--border);
}

.header h1 {
  font-size: 1.4rem;
  color: var(--accent-blue);
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 5px;
}

.header p {
  font-size: 0.9rem;
  color: var(--text-secondary);
}

/* ============================================
   NAVEGACI√ìN
   ============================================ */
.nav-menu {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.nav-btn {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
  background: transparent;
  border: 1px solid transparent;
  color: var(--text-secondary);
  border-radius: 12px;
  cursor: pointer;
  font-size: 0.95rem;
  font-weight: 500;
  transition: all 0.3s ease;
  text-align: left;
  width: 100%;
}

.nav-btn:hover {
  background: rgba(56, 189, 248, 0.1);
  color: var(--accent-blue);
  border-color: var(--accent-blue);
}

.nav-btn.active {
  background: linear-gradient(135deg, rgba(56, 189, 248, 0.25) 0%, rgba(139, 92, 246, 0.25) 100%);
  color: var(--accent-blue);
  border-left: 4px solid var(--accent-blue);
  border-color: var(--accent-blue);
  font-weight: 600;
  box-shadow: inset 0 0 10px rgba(56, 189, 248, 0.1);
}

.nav-btn i {
  width: 20px;
  font-size: 1.1rem;
}

/* ============================================
   CONTENIDO PRINCIPAL
   ============================================ */
.main-content {
  padding: 20px;
  overflow-y: hidden;
  max-width: 100%;
  display: flex;
  flex-direction: column;
}

.view-section {
  display: none;
  animation: fadeIn 0.3s ease;
  overflow-y: auto;
  flex: 1;
  min-height: 0;
}

.view-section.active {
  display: block;
}

/* ============================================
   KPI CARDS
   ============================================ */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.kpi-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  transition: transform 0.3s ease;
}

.kpi-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.4);
}

.kpi-card h3 {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.kpi-card .value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--text-primary);
  line-height: 1.2;
}

.kpi-card .change {
  font-size: 0.85rem;
  margin-top: 8px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.change.positive {
  color: var(--accent-green);
}

.change.negative {
  color: var(--danger);
}

/* ============================================
   CHART CONTAINERS
   ============================================ */
.chart-container {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 24px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.chart-container h3 {
  margin-bottom: 20px;
  color: var(--text-primary);
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.chart-wrapper {
  position: relative;
  height: 300px;
  width: 100%;
}

/* ============================================
   FORM CONTROLS
   ============================================ */
.control-group {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}

.control-group h3 {
  margin-bottom: 16px;
  color: var(--text-primary);
  font-size: 1.1rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: var(--text-secondary);
  font-size: 0.9rem;
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-primary);
  font-size: 0.95rem;
  transition: all 0.3s ease;
}

.form-control:focus {
  outline: none;
  border-color: var(--accent-blue);
  box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
}

.file-drop-area {
  border: 2px dashed var(--border);
  border-radius: 10px;
  padding: 40px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background: var(--bg-panel);
}

.file-drop-area:hover {
  border-color: var(--accent-blue);
  background: rgba(56, 189, 248, 0.05);
}

.file-drop-area i {
  font-size: 2.5rem;
  color: var(--text-secondary);
  margin-bottom: 15px;
}

/* ============================================
   BUTTONS
   ============================================ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 14px 24px;
  border: none;
  border-radius: 12px;
  font-size: 0.95rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-align: center;
  width: 100%;
}

.btn-primary {
  background: linear-gradient(135deg, var(--accent-blue), #0ea5e9);
  color: white;
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(56, 189, 248, 0.3);
}

.btn-success {
  background: linear-gradient(135deg, var(--accent-green), #10b981);
  color: white;
}

.btn-warning {
  background: linear-gradient(135deg, var(--warning), #f59e0b);
  color: white;
}

.btn-danger {
  background: linear-gradient(135deg, var(--danger), #ef4444);
  color: white;
}

.btn-secondary {
  background: var(--bg-card);
  border: 1px solid var(--border);
  color: var(--text-primary);
}

.btn-group {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 12px;
  margin-top: 16px;
}

/* ============================================
   TABLAS
   ============================================ */
.data-table-container {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  overflow-x: auto;
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  min-width: 600px;
}

.data-table th {
  background: var(--bg-panel);
  padding: 16px;
  text-align: left;
  color: var(--text-secondary);
  font-weight: 600;
  font-size: 0.9rem;
  border-bottom: 2px solid var(--border);
}

.data-table td {
  padding: 16px;
  border-bottom: 1px solid var(--border);
  color: var(--text-primary);
}

.data-table tr:hover {
  background: rgba(56, 189, 248, 0.05);
}

/* ============================================
   MAPA
   ============================================ */
.map-container {
  height: 600px;
  min-height: 400px;
  border-radius: 16px;
  overflow: hidden;
  border: 1px solid var(--border);
  margin-bottom: 24px;
  position: relative;
}

#map {
  width: 100%;
  height: 100%;
}

/* Map overlay positioned absolutely within section#map */
.map-overlay {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  width: 280px;
  backdrop-filter: blur(10px);
  z-index: 10;
  transition: all 0.3s ease;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
  pointer-events: auto;
}

/* Estado minimizado */
.map-overlay.minimized {
  width: 50px;
  height: 50px;
  overflow: hidden;
  padding: 12px;
}

.map-overlay.minimized .overlay-content {
  display: none;
}

.map-overlay.minimized .overlay-header h4 {
  display: none;
}

/* Header del overlay */
.overlay-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  cursor: pointer;
}

.overlay-header h4 {
  margin: 0;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.95rem;
}

.toggle-overlay {
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.toggle-overlay:hover {
  background: rgba(56, 189, 248, 0.1);
  color: var(--accent-blue);
}

/* Contenido del overlay */
.overlay-content {
  transition: opacity 0.3s ease;
}

.map-overlay.minimized .overlay-content {
  opacity: 0;
}

/* Bot√≥n flotante para mostrar overlay */
.overlay-toggle-minimized {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid var(--border);
  border-radius: 50%;
  width: 50px;
  height: 50px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 1;
  color: var(--text-secondary);
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.overlay-toggle-minimized:hover {
  background: rgba(56, 189, 248, 0.1);
  color: var(--accent-blue);
  transform: scale(1.1);
}

/* ============================================
   BREADCRUMB NAVIGATION
   ============================================ */
.view-breadcrumb {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 25px;
  padding: 12px 18px;
  background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
  border-radius: 8px;
  box-shadow: 0 2px 12px rgba(56, 189, 248, 0.3);
}

.btn-back {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 14px;
  background: rgba(255, 255, 255, 0.15);
  color: white;
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  white-space: nowrap;
}

.btn-back:hover {
  background: rgba(255, 255, 255, 0.25);
  border-color: rgba(255, 255, 255, 0.5);
  transform: translateX(-2px);
}

.breadcrumb-path {
  color: white;
  font-weight: 600;
  font-size: 16px;
  flex: 1;
}

/* ============================================
   ZONAS BADGES
   ============================================ */
.zone-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  margin-right: 8px;
  margin-bottom: 8px;
}

.zone-237 { background: #3b82f6; color: white; }
.zone-233 { background: #10b981; color: white; }
.zone-91 { background: #8b5cf6; color: white; }
.zone-77 { background: #ef4444; color: white; }
.zone-centro { background: #f59e0b; color: white; }
.zone-hotelera { background: #ec4899; color: white; }

/* ============================================
   PITCH GENERATOR
   ============================================ */
.pitch-input {
  width: 100%;
  min-height: 150px;
  padding: 16px;
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-primary);
  font-size: 1rem;
  resize: vertical;
  margin-bottom: 16px;
}

.pitch-output {
  background: var(--bg-panel);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 20px;
  margin-top: 20px;
  white-space: pre-wrap;
  max-height: 400px;
  overflow-y: auto;
  border-left: 4px solid var(--accent-blue);
}

/* ============================================
   REPORTES
   ============================================ */
.reports-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.report-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  transition: transform 0.3s ease;
}

.tools-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}

.tool-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  text-align: center;
  transition: all 0.3s ease;
  cursor: pointer;
}

.tool-card:hover {
  transform: translateY(-4px);
  border-color: var(--accent-blue);
  box-shadow: 0 8px 24px rgba(56, 189, 248, 0.15);
}

.tool-icon {
  font-size: 2.5rem;
  color: var(--accent-blue);
  margin-bottom: 16px;
}

.tool-card h3 {
  font-size: 1.1rem;
  margin-bottom: 12px;
  color: var(--text-primary);
}

.tool-card p {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 16px;
  line-height: 1.5;
  min-height: 60px;
}

.mt-30 {
  margin-top: 30px;
}

.report-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

/* ============================================
   NOTIFICACIONES
   ============================================ */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 16px 20px;
  border-radius: 12px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 12px;
  transform: translateX(400px);
  transition: transform 0.3s ease;
  max-width: 400px;
}

.notification.show {
  transform: translateX(0);
}

.notification.success {
  border-left: 4px solid var(--accent-green);
}

.notification.warning {
  border-left: 4px solid var(--warning);
}

.notification.error {
  border-left: 4px solid var(--danger);
}

/* ============================================
   NAVEGACI√ìN M√ìVIL
   ============================================ */
.mobile-nav {
  display: none;
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: var(--bg-panel);
  border-top: 1px solid var(--border);
  padding: 12px 0;
  z-index: 100;
  backdrop-filter: blur(10px);
}

.mobile-nav-buttons {
  display: flex;
  justify-content: space-around;
  max-width: 600px;
  margin: 0 auto;
}

.mobile-nav-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 6px;
  background: none;
  border: none;
  color: var(--text-secondary);
  padding: 10px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
  flex: 1;
  max-width: 80px;
}

.mobile-nav-btn.active {
  color: var(--accent-blue);
  background: rgba(56, 189, 248, 0.1);
}

.mobile-nav-btn i {
  font-size: 1.2rem;
}

.mobile-nav-btn span {
  font-size: 0.75rem;
  font-weight: 500;
}

/* ============================================
   TABLAS DE AN√ÅLISIS
   ============================================ */
.analysis-table {
  width: 100%;
  border-collapse: collapse;
  margin: 16px 0;
  background: rgba(56, 189, 248, 0.05);
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
}

.analysis-table th {
  background: rgba(56, 189, 248, 0.1);
  padding: 12px;
  text-align: left;
  font-weight: 600;
  border-bottom: 2px solid var(--accent-blue);
  color: var(--accent-blue);
}

.analysis-table td {
  padding: 12px;
  border-bottom: 1px solid var(--border);
}

.analysis-table tr:last-child td {
  border-bottom: none;
}

.analysis-table tr:hover {
  background: rgba(56, 189, 248, 0.08);
}

/* ============================================
   RESPONSIVE DESIGN
   ============================================ */
@media (max-width: 1024px) {
  .app-container {
    grid-template-columns: 1fr;
  }
  
  .sidebar {
    display: none;
  }
  
  .mobile-nav {
    display: block;
  }
  
  .main-content {
    padding-bottom: 80px;
  }
}

@media (max-width: 768px) {
  .kpi-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .btn-group {
    grid-template-columns: 1fr;
  }
  
  .reports-grid {
    grid-template-columns: 1fr;
  }
  
  .chart-wrapper {
    height: 250px;
  }
  
  .map-container {
    height: 400px;
  }
  
  .map-overlay {
    position: fixed;
    bottom: 20px;
    right: 20px;
    top: auto;
    width: 280px;
    max-height: 60vh;
    overflow-y: auto;
  }
}

@media (max-width: 480px) {
  .kpi-grid {
    grid-template-columns: 1fr;
  }
  
  .main-content {
    padding: 16px;
  }
  
  .kpi-card .value {
    font-size: 1.8rem;
  }
  
  .mobile-nav-btn span {
    font-size: 0.7rem;
  }
}

/* ============================================
   AN√ÅLISIS COMPLETO DETALLADO
   ============================================ */
.analysis-header {
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid var(--accent-blue);
}

.analysis-header h2 {
  font-size: 2rem;
  margin-bottom: 10px;
  color: var(--accent-blue);
}

.analysis-toolbar {
  display: flex;
  gap: 15px;
  align-items: center;
  margin-bottom: 30px;
  padding: 15px;
  background: rgba(56, 189, 248, 0.05);
  border-radius: 12px;
  flex-wrap: wrap;
}

.analysis-toolbar .pagination-info {
  margin-left: auto;
  display: flex;
  gap: 10px;
  align-items: center;
  font-weight: 600;
  color: var(--text-secondary);
}

.btn-icon {
  background: var(--bg-card);
  border: 1px solid var(--border);
  color: var(--text-primary);
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 16px;
}

.btn-icon:hover {
  background: var(--accent-blue);
  color: white;
  border-color: var(--accent-blue);
}

.analysis-tabs {
  display: flex;
  gap: 15px;
  margin-bottom: 30px;
  border-bottom: 2px solid var(--border);
  flex-wrap: wrap;
}

.analysis-tab {
  padding: 12px 24px;
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-weight: 600;
  border-bottom: 3px solid transparent;
  transition: all 0.3s ease;
}

.analysis-tab:hover {
  color: var(--accent-blue);
}

.analysis-tab.active {
  color: var(--accent-blue);
  border-bottom-color: var(--accent-blue);
}

.analysis-content {
  display: none;
  animation: fadeIn 0.3s ease;
}

.analysis-content.active {
  display: block;
}

.filters-panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 30px;
}

.filters-panel h3 {
  margin-bottom: 20px;
  color: var(--accent-blue);
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.filter-group {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.filter-group label {
  font-weight: 600;
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.filter-control {
  padding: 10px 12px;
  border: 1px solid var(--border);
  background: var(--bg-panel);
  color: var(--text-primary);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 14px;
}

.filter-control:focus {
  outline: none;
  border-color: var(--accent-blue);
  box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.1);
}

.visualization-controls {
  display: flex;
  gap: 15px;
  align-items: center;
  margin-bottom: 30px;
  padding: 15px;
  background: rgba(56, 189, 248, 0.05);
  border-radius: 8px;
  flex-wrap: wrap;
}

.visualization-controls label {
  font-weight: 600;
  color: var(--text-secondary);
}

.toggle-group {
  display: flex;
  gap: 8px;
  background: var(--bg-card);
  padding: 4px;
  border-radius: 6px;
  border: 1px solid var(--border);
}

.toggle-btn {
  padding: 8px 16px;
  background: transparent;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.3s ease;
  font-weight: 500;
  font-size: 14px;
}

.toggle-btn:hover {
  color: var(--accent-blue);
}

.toggle-btn.active {
  background: var(--accent-blue);
  color: white;
}

.analysis-visualization {
  position: relative;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 30px;
  min-height: 500px;
}

.heatmap-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
  gap: 8px;
}

.heatmap-cell {
  aspect-ratio: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
  color: white;
  transition: all 0.3s ease;
  text-align: center;
  padding: 8px;
}

.heatmap-cell:hover {
  transform: scale(1.15);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
  z-index: 10;
}

.heatmap-cell.intensity-1 { background: linear-gradient(135deg, #dc2626, #991b1b); }
.heatmap-cell.intensity-2 { background: linear-gradient(135deg, #ea580c, #c2410c); }
.heatmap-cell.intensity-3 { background: linear-gradient(135deg, #f59e0b, #d97706); }
.heatmap-cell.intensity-4 { background: linear-gradient(135deg, #3b82f6, #2563eb); }
.heatmap-cell.intensity-5 { background: linear-gradient(135deg, #10b981, #059669); }

.table-container {
  overflow-x: auto;
}

.analysis-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.analysis-table thead {
  background: linear-gradient(135deg, #38bdf8, #0ea5e9);
  color: white;
}

.analysis-table th,
.analysis-table td {
  padding: 12px;
  text-align: center;
  border-bottom: 1px solid var(--border);
}

.analysis-table tbody tr:hover {
  background: rgba(56, 189, 248, 0.1);
}

.analysis-table th {
  font-weight: 600;
  cursor: pointer;
  user-select: none;
}

.analysis-table td.numeric {
  font-family: 'Courier New', monospace;
}

.insights-panel {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  margin-top: 30px;
}

.insights-panel h3 {
  margin-bottom: 20px;
  color: var(--accent-blue);
}

.insights-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 16px;
}

.insight-card {
  background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(16, 185, 129, 0.1));
  border: 1px solid rgba(56, 189, 248, 0.3);
  border-radius: 8px;
  padding: 16px;
  transition: all 0.3s ease;
}

.insight-card:hover {
  border-color: var(--accent-blue);
  box-shadow: 0 4px 12px rgba(56, 189, 248, 0.2);
  transform: translateY(-2px);
}

.insight-card .rank {
  display: inline-block;
  background: var(--accent-blue);
  color: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-weight: bold;
  font-size: 12px;
  margin-bottom: 8px;
}

.insight-card .title {
  font-weight: 600;
  color: var(--text-primary);
  margin: 8px 0;
  font-size: 14px;
}

.insight-card .metric {
  font-size: 24px;
  font-weight: bold;
  color: var(--accent-green);
  margin: 12px 0;
}

.insight-card .description {
  font-size: 13px;
  color: var(--text-secondary);
  line-height: 1.4;
}

.btn-ghost {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-secondary);
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.btn-ghost:hover {
  background: var(--bg-card);
  border-color: var(--accent-blue);
  color: var(--accent-blue);
}

/* ============================================
   ANIMACIONES
   ============================================ */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.05); }
  100% { transform: scale(1); }
}

.pulse {
  animation: pulse 2s infinite;
}

/* ============================================
   LOADING STATES
   ============================================ */
.loading {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: white;
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(2, 6, 23, 0.8);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  backdrop-filter: blur(5px);
}

.loading-content {
  background: var(--bg-card);
  padding: 30px;
  border-radius: 16px;
  text-align: center;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
}

/* ============================================
   UTILITY CLASSES
   ============================================ */
.hidden {
  display: none !important;
}

.text-center {
  text-align: center;
}

.text-success {
  color: var(--accent-green);
}

.text-danger {
  color: var(--danger);
}

.text-warning {
  color: var(--warning);
}

.mt-20 {
  margin-top: 20px;
}

.mb-20 {
  margin-bottom: 20px;
}

.mb-30 {
  margin-bottom: 30px;
}
</style>
</head>
<body>

<!-- NOTIFICACIONES -->
<div id="notification" class="notification">
  <i id="notification-icon"></i>
  <span id="notification-text"></span>
</div>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay" class="loading-overlay hidden">
  <div class="loading-content">
    <div class="loading" style="margin: 0 auto 20px;"></div>
    <p id="loadingText">Procesando...</p>
  </div>
</div>

<div class="app-container">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="header">
      <h1><i class="fas fa-satellite-dish"></i> Geo-Suite Canc√∫n</h1>
      <p>Plataforma Estrat√©gica Inteligente</p>
    </div>

    <!-- Navegaci√≥n -->
    <nav class="nav-menu">
      <button class="nav-btn active" data-view="dashboard">
        <i class="fas fa-chart-pie"></i> Dashboard
      </button>
      <button class="nav-btn" data-view="map-section">
        <i class="fas fa-map"></i> Mapa Interactivo
      </button>
      <button class="nav-btn" data-view="data">
        <i class="fas fa-database"></i> Datos y CSV
      </button>
      <button class="nav-btn" data-view="analysis">
        <i class="fas fa-chart-line"></i> An√°lisis Avanzado
      </button>
      <button class="nav-btn" data-view="capture">
        <i class="fas fa-camera"></i> Captura en Vivo
      </button>
      <button class="nav-btn" data-view="zones">
        <i class="fas fa-map-marker-alt"></i> Zonas Estrat√©gicas
      </button>
      <button class="nav-btn" data-view="pitch">
        <i class="fas fa-bullhorn"></i> Recomendaciones Mercadot√©cnicas
      </button>
      <button class="nav-btn" data-view="routes">
        <i class="fas fa-route"></i> Optimizaci√≥n de Rutas
      </button>
      <button class="nav-btn" data-view="tools">
        <i class="fas fa-tools"></i> Herramientas de An√°lisis
      </button>
      <button class="nav-btn" data-view="complete-analysis">
        <i class="fas fa-chart-bar"></i> An√°lisis Detallado
      </button>
      <button class="nav-btn" data-view="reports">
        <i class="fas fa-file-alt"></i> Reportes
      </button>
      <button class="nav-btn" data-view="settings">
        <i class="fas fa-cog"></i> Configuraci√≥n
      </button>
	  <button class="btn btn-primary" id="runCompleteAnalysisBtn">
  <i class="fas fa-cogs"></i> An√°lisis Completo
</button>
    </nav>

    <!-- Estado del sistema -->
    <div class="control-group mt-20">
      <h3><i class="fas fa-info-circle"></i> Estado</h3>
      <div class="form-group">
        <label>Datos Cargados:</label>
        <div id="dataStatus" class="text-warning">Sin datos</div>
      </div>
      <div class="form-group">
        <label>Knowledgebase:</label>
        <div id="kbStatus" class="text-success">Disponible</div>
      </div>
    </div>
  </aside>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="main-content">
    
    <!-- ================= DASHBOARD ================= -->
    <section id="dashboard" class="view-section active">
      <h2 class="mb-30"><i class="fas fa-chart-pie"></i> Dashboard Principal</h2>
      
      <div class="kpi-grid">
        <div class="kpi-card">
          <h3>Ventas Totales</h3>
          <div class="value" id="kpiSalesTotal">$0.00</div>
          <div class="change positive">
            <i class="fas fa-arrow-up"></i> <span>0% vs √∫ltimo mes</span>
          </div>
        </div>
        
        <div class="kpi-card">
          <h3>Transacciones</h3>
          <div class="value" id="kpiTransactions">0</div>
          <div class="change negative">
            <i class="fas fa-arrow-down"></i> <span>0%</span>
          </div>
        </div>
        
        <div class="kpi-card">
          <h3>Ticket Promedio</h3>
          <div class="value" id="kpiAvgTicket">$0.00</div>
          <div class="change positive">
            <i class="fas fa-arrow-up"></i> <span>0%</span>
          </div>
        </div>
        
        <div class="kpi-card">
          <h3>Mejor Zona</h3>
          <div class="value" id="kpiBestZone">‚Äî</div>
          <div class="change">
            <span id="kpiZonePerformance">‚Äî</span>
          </div>
        </div>
      </div>
      
      <div class="chart-container">
        <h3><i class="fas fa-chart-bar"></i> Ventas por Zona</h3>
        <div class="chart-wrapper">
          <canvas id="zonesChart"></canvas>
        </div>
      </div>

      <div class="chart-container">
        <h3><i class="fas fa-chart-line"></i> Tendencia por Hora</h3>
        <div class="chart-wrapper">
          <canvas id="hoursChart"></canvas>
        </div>
      </div>
    </section>
    
    <!-- ================= MAPA INTERACTIVO ================= -->
    <section id="map-section" class="view-section">
      <h2 class="mb-30"><i class="fas fa-map"></i> Mapa de Distribuci√≥n</h2>
      
      <div class="map-container" id="mapContainer">
        <div id="map"></div>
      </div>
      
      <!-- Map Overlay - FUERA del mapa para evitar interferencia con Mapbox -->
      <div class="map-overlay" id="mapOverlay">
        <div class="overlay-header" onclick="toggleMapOverlay()">
          <h4><i class="fas fa-layer-group"></i> Capas</h4>
          <button class="toggle-overlay" id="toggleOverlayBtn">
            <i class="fas fa-chevron-up"></i>
          </button>
        </div>
        <div class="overlay-content" id="overlayContent">
          <div class="form-group">
            <label>
              <input type="checkbox" id="layerPoints" checked> Puntos de Venta
            </label>
          </div>
          <div class="form-group">
            <label>
              <input type="radio" name="heatmap" id="heatIntensity"> Heatmap por Monto
            </label>
          </div>
          <div class="form-group">
            <label>
              <input type="radio" name="heatmap" id="heatDensity"> Heatmap por Densidad
            </label>
          </div>
          <div class="form-group">
            <label>
              <input type="radio" name="heatmap" id="heatNone" checked> Sin Heatmap
            </label>
          </div>
        </div>
      </div>
      
      <!-- REMOVIDO: Panel de Zonas geoestad√≠sticas ahora est√° en la secci√≥n dedicada -->
      <!--
      <div class="control-group">
        <h3><i class="fas fa-map-marked-alt"></i> Zonas Geoestad√≠sticas</h3>
        <div id="zonesInfo">
          <!-- Info de zonas se cargar√° din√°micamente -->
        </div>
      </div>
      -->
    </section>
    
    <!-- ================= DATOS Y CSV ================= -->
    <section id="data" class="view-section">
      <h2 class="mb-30"><i class="fas fa-database"></i> Carga y Gesti√≥n de Datos</h2>
      
      <div class="control-group">
        <h3><i class="fas fa-file-upload"></i> Cargar Archivo CSV</h3>
        <p>Carga tus datos de ventas en formato CSV. El sistema detectar√° autom√°ticamente las columnas.</p>
        
        <div class="file-drop-area" id="dropArea">
          <i class="fas fa-cloud-upload-alt"></i>
          <h4>Arrastra tu archivo CSV aqu√≠</h4>
          <p>o haz clic para seleccionar</p>
          <input type="file" id="csvFile" accept=".csv" class="hidden">
        </div>
        
        <div id="fileInfo" class="text-center mt-20 hidden">
          <p><i class="fas fa-check-circle text-success"></i> <span id="fileStatus">Archivo cargado</span></p>
        </div>
      </div>
      
      <div class="control-group">
        <h3><i class="fas fa-filter"></i> Filtros de Datos</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Fecha Desde:</label>
            <input type="date" id="dateFrom" class="form-control">
          </div>
          <div class="form-group">
            <label>Fecha Hasta:</label>
            <input type="date" id="dateTo" class="form-control">
          </div>
          <div class="form-group">
            <label>Zona:</label>
            <select id="zoneFilter" class="form-control">
              <option value="">Todas las zonas</option>
              <option value="237">Regi√≥n 237</option>
              <option value="233">Regi√≥n 233</option>
              <option value="91">Supermanzana 91</option>
              <option value="77">Supermanzana 77 (Corales)</option>
              <option value="centro">Centro</option>
              <option value="hotelera">Zona Hotelera</option>
            </select>
          </div>
          <div class="form-group">
            <label>Rango Horario:</label>
            <select id="timeFilter" class="form-control">
              <option value="">Todo el d√≠a</option>
              <option value="6-12">Ma√±ana (6:00-12:00)</option>
              <option value="12-18">Tarde (12:00-18:00)</option>
              <option value="18-24">Noche (18:00-24:00)</option>
            </select>
          </div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-primary" id="applyFiltersBtn">
            <i class="fas fa-filter"></i> Aplicar Filtros
          </button>
          <button class="btn btn-secondary" id="resetFiltersBtn">
            <i class="fas fa-redo"></i> Restablecer
          </button>
        </div>
      </div>
      
      <div class="data-table-container">
        <h3><i class="fas fa-table"></i> Datos de Ventas</h3>
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Monto</th>
                <th>Zona</th>
                <th>Hora</th>
                <th>Coordenadas</th>
              </tr>
            </thead>
            <tbody id="dataTableBody">
              <tr>
                <td colspan="6" class="text-center" style="padding: 40px;">
                  <i class="fas fa-database fa-2x mb-20" style="display: block; color: var(--text-secondary);"></i>
                  Carga un archivo CSV para ver los datos
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
    
    <!-- ================= CAPTURA DE DATOS EN VIVO ================= -->
    <section id="capture" class="view-section">
      <h2 class="mb-30"><i class="fas fa-location-crosshairs"></i> Captura de Datos en Vivo</h2>
      <p class="mb-20">Registra interacciones de ventas con ubicaci√≥n autom√°tica y coordenadas GPS</p>
      
      <!-- ‚úÖ PASO 3: INFORMACI√ìN SOBRE FORMATOS SOPORTADOS -->
      <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border-left: 4px solid #0284c7; margin-bottom: 20px; font-size: 13px;">
        <p><strong>‚ÑπÔ∏è Formatos de CSV soportados:</strong></p>
        <ul style="margin: 8px 0 0 0; padding-left: 20px;">
          <li>‚úÖ Headers en espa√±ol: <code style="background: #e0f2fe; padding: 2px 4px; border-radius: 3px;">tipo_pitch, resultado, monto, zona</code></li>
          <li>‚úÖ Headers en ingl√©s: <code style="background: #e0f2fe; padding: 2px 4px; border-radius: 3px;">pitch_type, result, amount, zone</code></li>
          <li>‚úÖ Fechas ISO: <code style="background: #e0f2fe; padding: 2px 4px; border-radius: 3px;">2026-01-10T14:30:00.000Z</code></li>
          <li>‚úÖ Zonas v√°lidas: zona_hotelera, centro, region_237, region_233, sm_91, sm_77</li>
        </ul>
        <p style="margin-top: 10px; margin-bottom: 0;">
          <a href="data/PLANTILLA_CSV_ESTANDAR.csv" target="_blank" style="color: #0284c7; text-decoration: none; font-weight: 600;">
            <i class="fas fa-download"></i> Descargar plantilla CSV de ejemplo
          </a>
        </p>
      </div>
      
      <!-- Bot√≥n para capturar ubicaci√≥n -->
      <div class="control-group">
        <h3><i class="fas fa-map-pin"></i> Ubicaci√≥n Actual</h3>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <button class="btn btn-primary" id="captureLocationBtn">
            <i class="fas fa-location-arrow"></i> Obtener Ubicaci√≥n GPS
          </button>
          <button class="btn btn-secondary" id="autoDetectZoneBtn">
            <i class="fas fa-map-marked-alt"></i> Detectar Zona
          </button>
          <button class="btn btn-warning" id="generateCSVBtn">
            <i class="fas fa-file-download"></i> Generar CSV con Coordenadas
          </button>
        </div>
        <div id="locationStatus" style="margin-top: 15px; padding: 10px; background: var(--bg-card); border-radius: 5px; display: none;">
          <p><strong>Ubicaci√≥n:</strong> <span id="coordsDisplay">‚Äî</span></p>
          <p><strong>Zona Detectada:</strong> <span id="zoneDetected">‚Äî</span></p>
          <p><strong>Precisi√≥n:</strong> <span id="accuracyDisplay">‚Äî</span></p>
        </div>
      </div>
      
      <!-- Formulario de captura -->
      <div class="control-group">
        <h3><i class="fas fa-pencil-alt"></i> Registrar Interacci√≥n</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Origen del Cliente:</label>
            <select id="captureOrigin" class="form-control">
              <option value="">Selecciona origen...</option>
              <option value="cdmx">CDMX</option>
              <option value="cancun_local">Canc√∫n Local</option>
              <option value="quintana_roo">Quintana Roo</option>
              <option value="yucatan">Yucat√°n</option>
              <option value="international">Internacional</option>
              <option value="migrant">Migrante</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Tipo de Pitch:</label>
            <select id="capturePitch" class="form-control">
              <option value="">Selecciona pitch...</option>
              <option value="autoridad">Autoridad</option>
              <option value="nostalgia">Nostalgia</option>
              <option value="escasez">Escasez</option>
              <option value="comunidad">Comunidad</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Resultado:</label>
            <select id="captureResult" class="form-control">
              <option value="">Selecciona resultado...</option>
              <option value="successful">Exitoso</option>
              <option value="failed">Fallido</option>
              <option value="pending">Pendiente</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Monto (MXN):</label>
            <input type="number" id="captureAmount" class="form-control" placeholder="0.00" min="0" step="0.01">
          </div>
          
          <div class="form-group">
            <label>Edad del Cliente:</label>
            <select id="captureAge" class="form-control">
              <option value="">Selecciona rango...</option>
              <option value="18-25">18-25</option>
              <option value="26-35">26-35</option>
              <option value="36-45">36-45</option>
              <option value="46-55">46-55</option>
              <option value="56-65">56-65</option>
              <option value="65+">65+</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Ocupaci√≥n:</label>
            <select id="captureOccupation" class="form-control">
              <option value="">Selecciona ocupaci√≥n...</option>
              <option value="professional">Professional</option>
              <option value="entrepreneur">Entrepreneur</option>
              <option value="artisan">Artisan</option>
              <option value="construction">Construction</option>
              <option value="commerce">Commerce</option>
              <option value="service">Service</option>
              <option value="student">Student</option>
              <option value="retired">Retired</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Nivel de Ingreso:</label>
            <select id="captureIncome" class="form-control">
              <option value="">Selecciona nivel...</option>
              <option value="bajo">Bajo</option>
              <option value="lower_middle">Bajo-Medio</option>
              <option value="middle">Medio</option>
              <option value="upper_middle">Medio-Alto</option>
              <option value="high">Alto</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Zona/Regi√≥n <span style="color: red;">*</span>:</label>
            <select id="captureZone" class="form-control" required>
              <option value="">Selecciona zona...</option>
              <option value="zona_hotelera">Zona Hotelera</option>
              <option value="centro">Centro</option>
              <option value="region_237">Regi√≥n 237</option>
              <option value="region_233">Regi√≥n 233</option>
              <option value="sm_77">Supermanzana 77</option>
              <option value="sm_91">Supermanzana 91</option>
            </select>
          </div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-success" id="saveRecordBtn">
            <i class="fas fa-save"></i> Guardar Registro
          </button>
          <button class="btn btn-secondary" id="clearRecordBtn">
            <i class="fas fa-eraser"></i> Limpiar
          </button>
        </div>
      </div>
      
      <!-- Tabla de registros capturados -->
      <div class="control-group">
        <h3><i class="fas fa-list"></i> Registros Capturados</h3>
        <p id="recordsCount" style="color: var(--text-secondary); margin-bottom: 10px;">0 registros</p>
        <div style="overflow-x: auto;">
          <table class="analysis-table">
            <thead>
              <tr>
                <th>Fecha/Hora</th>
                <th>Origen</th>
                <th>Pitch</th>
                <th>Resultado</th>
                <th>Monto</th>
                <th>Zona</th>
                <th>Lat/Lng</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="capturedRecordsBody">
              <tr>
                <td colspan="8" style="text-align: center; padding: 20px; color: var(--text-secondary);">
                  No hay registros capturados a√∫n
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="btn-group" style="margin-top: 15px;">
          <button class="btn btn-primary" id="exportCapturedCSVBtn">
            <i class="fas fa-file-csv"></i> Exportar Registros a CSV
          </button>
          <button class="btn btn-secondary" id="clearAllRecordsBtn">
            <i class="fas fa-trash"></i> Borrar Todos
          </button>
        </div>
      </div>
    </section>
    
    <!-- ================= AN√ÅLISIS AVANZADO ================= -->
    <section id="analysis" class="view-section">
      <h2 class="mb-30"><i class="fas fa-chart-line"></i> An√°lisis Avanzado</h2>
      
      <div class="control-group">
        <h3><i class="fas fa-brain"></i> Herramientas de An√°lisis</h3>
        <p>Utiliza las funciones avanzadas del knowledgebase para an√°lisis estrat√©gicos.</p>
        
        <div class="btn-group">
          <button class="btn btn-primary" id="runMonteCarloBtn">
            <i class="fas fa-dice"></i> Simulaci√≥n Monte Carlo
          </button>
          <button class="btn btn-success" id="calculateOptimalRouteBtn">
            <i class="fas fa-route"></i> Ruta √ìptima
          </button>
          <button class="btn btn-warning" id="calculateLogisticRiskBtn">
            <i class="fas fa-exclamation-triangle"></i> An√°lisis de Riesgo
          </button>
          <button class="btn btn-secondary" id="runSeasonalAnalysisBtn">
            <i class="fas fa-calendar-alt"></i> An√°lisis Estacional
          </button>
        </div>
      </div>
      
      <div id="analysisResults" class="control-group hidden">
        <h3><i class="fas fa-clipboard-check"></i> Resultados del An√°lisis</h3>
        <div id="analysisOutput">
          <!-- Los resultados se mostrar√°n aqu√≠ -->
        </div>
      </div>
      
      <div class="control-group">
        <h3><i class="fas fa-robot"></i> An√°lisis con IA</h3>
        <div class="form-group">
          <label>API Key de Groq (opcional):</label>
          <input type="text" id="apiKey" class="form-control" placeholder="gsk_...">
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" id="runStrategicAIBtn">
            <i class="fas fa-robot"></i> An√°lisis Estrat√©gico IA
          </button>
        </div>
      </div>
    </section>
    
    <!-- ================= ZONAS ESTRAT√âGICAS ================= -->
    <section id="zones" class="view-section">
      <h2 class="mb-30"><i class="fas fa-map-marker-alt"></i> Zonas Geoestad√≠sticas de Canc√∫n</h2>
      
      <!-- Resumen din√°mico de datos por zona -->
      <div id="zonesSummary" class="kpi-grid mb-30" style="display: none;">
        <!-- Se llena din√°micamente con datos de ventas -->
      </div>
      
      <div class="reports-grid">
        <div class="report-card">
          <h4><span class="zone-badge zone-237">Regi√≥n 237</span></h4>
          <p><strong>Perfil:</strong> Zona norte, alta densidad poblacional, procesos de regularizaci√≥n.</p>
          <p><strong>Segmento:</strong> Clase trabajadora, ingresos medios-bajos.</p>
          <p><strong>Estrategia:</strong> Ventas de productos b√°sicos, pagos flexibles.</p>
        </div>
        
        <div class="report-card">
          <h4><span class="zone-badge zone-233">Regi√≥n 233</span></h4>
          <p><strong>Perfil:</strong> Poblaci√≥n joven, mejor conectividad, inversi√≥n p√∫blica reciente.</p>
          <p><strong>Segmento:</strong> Familias j√≥venes, estudiantes universitarios.</p>
          <p><strong>Estrategia:</strong> Productos tecnol√≥gicos, financiamiento educativo.</p>
        </div>
        
        <div class="report-card">
          <h4><span class="zone-badge zone-91">Supermanzana 91</span></h4>
          <p><strong>Perfil:</strong> Zona c√©ntrica en transici√≥n, propiedades en remate.</p>
          <p><strong>Segmento:</strong> Clase media en transici√≥n, propietarios.</p>
          <p><strong>Estrategia:</strong> Productos de renovaci√≥n hogar, seguros.</p>
        </div>
        
        <div class="report-card">
          <h4><span class="zone-badge zone-77">Supermanzana 77 (Corales)</span></h4>
          <p><strong>Perfil:</strong> Crisis habitacional, alta vulnerabilidad, necesidades b√°sicas.</p>
          <p><strong>Segmento:</strong> Poblaci√≥n en extrema necesidad.</p>
          <p><strong>Estrategia:</strong> Productos esenciales, precios m√≠nimos, ayuda social.</p>
        </div>
        
        <div class="report-card">
          <h4><span class="zone-badge zone-centro">Centro (Distrito 1)</span></h4>
          <p><strong>Perfil:</strong> Renovaci√≥n urbana, comercio consolidado, turismo local.</p>
          <p><strong>Segmento:</strong> Comerciantes, turistas, residentes con poder adquisitivo.</p>
          <p><strong>Estrategia:</strong> Productos premium, experiencias, servicios especializados.</p>
        </div>
        
        <div class="report-card">
          <h4><span class="zone-badge zone-hotelera">Zona Hotelera</span></h4>
          <p><strong>Perfil:</strong> Turismo internacional, alta rotaci√≥n, precios premium.</p>
          <p><strong>Segmento:</strong> Turistas internacionales, ejecutivos.</p>
          <p><strong>Estrategia:</strong> Productos de lujo, souvenirs, servicios exclusivos.</p>
        </div>
      </div>
    </section>
    
    <!-- ================= RECOMENDACIONES MERCADOT√âCNICAS ================= -->
    <section id="pitch" class="view-section">
      <h2 class="mb-30"><i class="fas fa-bullhorn"></i> Recomendaciones Mercadot√©cnicas</h2>
      
      <div class="control-group">
        <h3><i class="fas fa-magic"></i> Crea tu Pitch</h3>
        <p>Describe tu producto o servicio para generar un pitch personalizado basado en las zonas de Canc√∫n:</p>
        
        <textarea id="pitchInput" class="pitch-input" placeholder="Ejemplo: Vender paquetes de comida saludable a domicilio en Canc√∫n"></textarea>
        
        <div class="btn-group">
          <button class="btn btn-primary" id="generatePitchBtn">
            <i class="fas fa-magic"></i> Generar Pitch
          </button>
          <button class="btn btn-secondary" id="clearPitchBtn">
            <i class="fas fa-eraser"></i> Limpiar
          </button>
          <button class="btn btn-success" id="savePitchBtn">
            <i class="fas fa-save"></i> Guardar
          </button>
        </div>
      </div>
      
      <div id="pitchOutput" class="hidden">
        <div class="control-group">
          <h3><i class="fas fa-bullhorn"></i> Pitch Generado</h3>
          <div class="pitch-output" id="pitchContent">
            <!-- El pitch se mostrar√° aqu√≠ -->
          </div>
          <div class="btn-group mt-20">
            <button class="btn btn-primary" id="copyPitchBtn">
              <i class="fas fa-copy"></i> Copiar
            </button>
            <button class="btn btn-success" id="savePitchAsReportBtn">
              <i class="fas fa-file-pdf"></i> Guardar como Reporte
            </button>
          </div>
        </div>
      </div>
    </section>
    
    <!-- ================= OPTIMIZACI√ìN DE RUTAS ================= -->
    <section id="routes" class="view-section">
      <h2 class="mb-30"><i class="fas fa-route"></i> Optimizaci√≥n de Rutas</h2>
      
      <div class="control-group">
        <h3><i class="fas fa-route"></i> Calculadora de Rutas √ìptimas</h3>
        <p>Utiliza el algoritmo de optimizaci√≥n del knowledgebase para calcular la ruta m√°s eficiente.</p>
        
        <div class="form-grid">
          <div class="form-group">
            <label>Punto de Inicio:</label>
            <select id="routeStart" class="form-control">
              <option value="centro">Centro</option>
              <option value="hotel_zone">Zona Hotelera</option>
              <option value="region_247">Regi√≥n 247</option>
              <option value="supermanzana">Supermanzana</option>
              <option value="puerto_juares">Puerto Ju√°rez</option>
            </select>
          </div>
          <div class="form-group">
            <label>N√∫mero de Paradas:</label>
            <input type="number" id="routeStops" class="form-control" min="2" max="20" value="5">
          </div>
          <div class="form-group">
            <label>Prioridad:</label>
            <select id="routePriority" class="form-control">
              <option value="distance">Distancia m√≠nima</option>
              <option value="revenue">M√°ximo ingreso</option>
              <option value="efficiency">Eficiencia log√≠stica</option>
            </select>
          </div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-primary" id="calculateRouteBtn">
            <i class="fas fa-calculator"></i> Calcular Ruta
          </button>
          <button class="btn btn-success" id="visualizeRouteBtn">
            <i class="fas fa-map"></i> Visualizar en Mapa
          </button>
        </div>
      </div>
      
      <div id="routeResults" class="control-group hidden">
        <h3><i class="fas fa-clipboard-list"></i> Resultados de la Ruta</h3>
        <div id="routeOutput">
          <!-- Los resultados de la ruta se mostrar√°n aqu√≠ -->
        </div>
      </div>
    </section>
    
    <!-- ================= HERRAMIENTAS DE AN√ÅLISIS ================= -->
    <section id="tools" class="view-section">
      <h2 class="mb-30"><i class="fas fa-tools"></i> Herramientas Avanzadas de An√°lisis</h2>
      <p class="mb-20">Accede a modelos predictivos y herramientas anal√≠ticas para optimizar tu estrategia de marketing.</p>
      
      <div class="tools-grid">
        <!-- Bayesian Analysis -->
        <div class="tool-card">
          <div class="tool-icon"><i class="fas fa-brain"></i></div>
          <h3>An√°lisis Bayesiano</h3>
          <p>Probabilidades de conversi√≥n basadas en zona y horario hist√≥rico. Utiliza el Teorema de Bayes para predicciones precisas.</p>
          <button class="btn btn-secondary" onclick="activateTool('bayesian')">Ejecutar An√°lisis</button>
        </div>
        
        <!-- Time Series Forecast -->
        <div class="tool-card">
          <div class="tool-icon"><i class="fas fa-chart-line"></i></div>
          <h3>Series Temporales</h3>
          <p>Suavizado exponencial (Holt-Winters) para detectar picos de demanda y patrones horarios √≥ptimos.</p>
          <button class="btn btn-secondary" onclick="activateTool('timeseries')">Ejecutar An√°lisis</button>
        </div>
        
        <!-- Monte Carlo Logistics -->
        <div class="tool-card">
          <div class="tool-icon"><i class="fas fa-dice"></i></div>
          <h3>Simulaci√≥n Monte Carlo</h3>
          <p>Simula 10,000 iteraciones de log√≠stica de rutas para estimar probabilidades de √©xito y confiabilidad.</p>
          <button class="btn btn-secondary" onclick="activateTool('montecarlo')">Ejecutar Simulaci√≥n</button>
        </div>
        
        <!-- Genetic Algorithm -->
        <div class="tool-card">
          <div class="tool-icon"><i class="fas fa-dna"></i></div>
          <h3>Optimizaci√≥n Gen√©tica</h3>
          <p>Resuelve el problema del viajante (TSP) usando algoritmo gen√©tico para rutas √≥ptimas en 100+ generaciones.</p>
          <button class="btn btn-secondary" onclick="activateTool('genetic')">Ejecutar Optimizaci√≥n</button>
        </div>
        
        <!-- Markov Decisions -->
        <div class="tool-card">
          <div class="tool-icon"><i class="fas fa-sitemap"></i></div>
          <h3>Procesos Markov</h3>
          <p>Recomendaciones de pr√≥xima mejor acci√≥n basadas en estados actuales y decisiones pasadas.</p>
          <button class="btn btn-secondary" onclick="activateTool('markov')">Calcular Recomendaci√≥n</button>
        </div>
        
        <!-- Market Saturation -->
        <div class="tool-card">
          <div class="tool-icon"><i class="fas fa-chart-area"></i></div>
          <h3>Saturaci√≥n de Mercado</h3>
          <p>Modelado de rendimientos decrecientes para identificar cu√°ndo una zona ha alcanzado su potencial m√°ximo.</p>
          <button class="btn btn-secondary" onclick="activateTool('saturation')">Analizar Saturaci√≥n</button>
        </div>
        
        <!-- Cannibalization Analysis -->
        <div class="tool-card">
          <div class="tool-icon"><i class="fas fa-cut"></i></div>
          <h3>An√°lisis de Canibalizaci√≥n</h3>
          <p>Mide c√≥mo una zona o pitch reduce la demanda de otros. Identifica efectos negativos de estrategias cruzadas.</p>
          <button class="btn btn-secondary" onclick="activateTool('cannibalization')">Analizar Efectos</button>
        </div>
        
        <!-- Decision Tree -->
        <div class="tool-card">
          <div class="tool-icon"><i class="fas fa-tree"></i></div>
          <h3>√Årbol de Decisiones</h3>
          <p>Segmentaci√≥n jer√°rquica de clientes por perfil socioecon√≥mico para estrategias personalizadas.</p>
          <button class="btn btn-secondary" onclick="activateTool('decisiontree')">Generar √Årbol</button>
        </div>
      </div>
      
      <!-- Resultados de herramientas -->
      <div id="toolResults" class="control-group hidden mt-30">
        <h3><i class="fas fa-clipboard"></i> Resultados del An√°lisis</h3>
        <div id="toolOutput" style="background: var(--bg-card); padding: 20px; border-radius: 12px; border: 1px solid var(--border);">
          <!-- Los resultados se mostrar√°n aqu√≠ -->
        </div>
      </div>
    </section>
    
    <!-- ================= REPORTES ================= -->
    <section id="reports" class="view-section">
      <h2 class="mb-30"><i class="fas fa-file-alt"></i> Reportes y An√°lisis</h2>
      
      <div class="control-group">
        <h3><i class="fas fa-plus-circle"></i> Generar Nuevo Reporte</h3>
        <p>Selecciona el tipo de reporte que deseas generar:</p>
        
        <div class="btn-group">
          <button class="btn btn-primary" id="generateSalesReportBtn">
            <i class="fas fa-chart-line"></i> Reporte de Ventas
          </button>
          <button class="btn btn-success" id="generateStrategicReportBtn">
            <i class="fas fa-chess"></i> Reporte Estrat√©gico
          </button>
          <button class="btn btn-warning" id="generateRiskReportBtn">
            <i class="fas fa-exclamation-triangle"></i> Reporte de Riesgo
          </button>
        </div>
      </div>
      
      <div class="control-group">
        <h3><i class="fas fa-history"></i> Reportes Generados</h3>
        <div id="reportsContainer" class="reports-grid">
          <div class="report-card">
            <h4>No hay reportes a√∫n</h4>
            <p>Genera tu primer reporte usando los botones de arriba.</p>
          </div>
        </div>
      </div>
    </section>
    
    <!-- ================= AN√ÅLISIS COMPLETO DETALLADO ================= -->
    <section id="complete-analysis" class="view-section">
      <div class="analysis-header">
        <h2><i class="fas fa-microscope"></i> An√°lisis Completo - Resultados Detallados</h2>
        <p>Exploraci√≥n interactiva de patrones y cruces de datos: Demogr√°fico √ó Pitch √ó Zona | Origen √ó Pitch √ó Resultado</p>
      </div>

      <!-- TOOLBAR -->
      <div class="analysis-toolbar">
        <button class="btn btn-secondary" id="refreshAnalysis">
          <i class="fas fa-sync-alt"></i> Actualizar
        </button>
        <button class="btn btn-secondary" id="exportAnalysis">
          <i class="fas fa-download"></i> Exportar JSON
        </button>
        <button class="btn btn-secondary" id="printAnalysis">
          <i class="fas fa-print"></i> Imprimir
        </button>
        <div class="pagination-info">
          <button id="prevAnalysis" class="btn-icon">‚èÆÔ∏è</button>
          <span id="pageInfo">1 de 5</span>
          <button id="nextAnalysis" class="btn-icon">‚è≠Ô∏è</button>
        </div>
      </div>

      <!-- TAB NAVIGATION -->
      <div class="analysis-tabs">
        <button class="analysis-tab active" data-tab="demographic-analysis">
          <i class="fas fa-users"></i> Demogr√°fico √ó Pitch √ó Zona
        </button>
        <button class="analysis-tab" data-tab="origin-analysis">
          <i class="fas fa-globe"></i> Origen √ó Pitch √ó Resultado
        </button>
      </div>

      <!-- TAB 1: DEMOGR√ÅFICO √ó PITCH √ó ZONA -->
      <div class="analysis-content active" data-content="demographic-analysis">
        
        <!-- Filtros -->
        <div class="filters-panel">
          <h3><i class="fas fa-filter"></i> Filtros Avanzados</h3>
          <div class="filters-grid">
            <div class="filter-group">
              <label>Grupo de Edad</label>
              <select id="demFilterAge" class="filter-control">
                <option value="">Todos</option>
                <option value="18-25">18-25</option>
                <option value="26-35">26-35</option>
                <option value="36-45">36-45</option>
                <option value="46-55">46-55</option>
                <option value="56+">56+</option>
              </select>
            </div>

            <div class="filter-group">
              <label>Ocupaci√≥n</label>
              <select id="demFilterOccupation" class="filter-control">
                <option value="">Todos</option>
              </select>
            </div>

            <div class="filter-group">
              <label>Nivel de Ingreso</label>
              <select id="demFilterIncome" class="filter-control">
                <option value="">Todos</option>
                <option value="bajo">Bajo</option>
                <option value="medio">Medio</option>
                <option value="alto">Alto</option>
              </select>
            </div>

            <div class="filter-group">
              <label>Zona</label>
              <select id="demFilterZone" class="filter-control">
                <option value="">Todas</option>
              </select>
            </div>

            <div class="filter-group">
              <label>Tipo de Pitch</label>
              <select id="demFilterPitch" class="filter-control">
                <option value="">Todos</option>
                <option value="autoridad">Autoridad</option>
                <option value="nostalgia">Nostalgia</option>
                <option value="escasez">Escasez</option>
                <option value="comunidad">Comunidad</option>
              </select>
            </div>

            <div class="filter-group" style="align-self: flex-end;">
              <button class="btn btn-primary" id="applyDemFilters">
                <i class="fas fa-search"></i> Aplicar Filtros
              </button>
              <button class="btn btn-ghost" id="clearDemFilters">
                <i class="fas fa-times"></i> Limpiar
              </button>
            </div>
          </div>
        </div>

        <!-- Visualizaci√≥n Toggle -->
        <div class="visualization-controls">
          <label>Modo de Visualizaci√≥n:</label>
          <div class="toggle-group">
            <button class="toggle-btn active" data-viz="heatmap">
              <i class="fas fa-fire"></i> Heatmap
            </button>
            <button class="toggle-btn" data-viz="table">
              <i class="fas fa-table"></i> Tabla
            </button>
          </div>
        </div>

        <!-- Contenedor de Visualizaci√≥n -->
        <div class="analysis-visualization">
          <div id="demographicHeatmap" class="heatmap-container"></div>
          <div id="demographicTable" class="table-container hidden"></div>
        </div>

        <!-- Insights -->
        <div class="insights-panel">
          <h3><i class="fas fa-lightbulb"></i> Insights y Recomendaciones</h3>
          <div id="demographicInsights" class="insights-grid"></div>
        </div>
      </div>

      <!-- TAB 2: ORIGEN √ó PITCH √ó RESULTADO -->
      <div class="analysis-content" data-content="origin-analysis">
        
        <!-- Filtros -->
        <div class="filters-panel">
          <h3><i class="fas fa-filter"></i> Filtros Avanzados</h3>
          <div class="filters-grid">
            <div class="filter-group">
              <label>Origen del Cliente</label>
              <select id="origFilterOrigin" class="filter-control">
                <option value="">Todos</option>
              </select>
            </div>

            <div class="filter-group">
              <label>Tipo de Pitch</label>
              <select id="origFilterPitch" class="filter-control">
                <option value="">Todos</option>
                <option value="autoridad">Autoridad</option>
                <option value="nostalgia">Nostalgia</option>
                <option value="escasez">Escasez</option>
                <option value="comunidad">Comunidad</option>
              </select>
            </div>

            <div class="filter-group">
              <label>Resultado</label>
              <select id="origFilterResult" class="filter-control">
                <option value="">Todos</option>
                <option value="successful">Exitoso</option>
                <option value="failed">Fallido</option>
                <option value="pending">Pendiente</option>
              </select>
            </div>

            <div class="filter-group" style="align-self: flex-end;">
              <button class="btn btn-primary" id="applyOrigFilters">
                <i class="fas fa-search"></i> Aplicar Filtros
              </button>
              <button class="btn btn-ghost" id="clearOrigFilters">
                <i class="fas fa-times"></i> Limpiar
              </button>
            </div>
          </div>
        </div>

        <!-- Visualizaci√≥n Toggle -->
        <div class="visualization-controls">
          <label>Modo de Visualizaci√≥n:</label>
          <div class="toggle-group">
            <button class="toggle-btn active" data-viz="heatmap">
              <i class="fas fa-fire"></i> Heatmap
            </button>
            <button class="toggle-btn" data-viz="table">
              <i class="fas fa-table"></i> Tabla
            </button>
          </div>
        </div>

        <!-- Contenedor de Visualizaci√≥n -->
        <div class="analysis-visualization">
          <div id="originHeatmap" class="heatmap-container"></div>
          <div id="originTable" class="table-container hidden"></div>
        </div>

        <!-- Insights -->
        <div class="insights-panel">
          <h3><i class="fas fa-lightbulb"></i> Insights y Recomendaciones</h3>
          <div id="originInsights" class="insights-grid"></div>
        </div>
      </div>
    </section>
    
    <!-- ================= CONFIGURACI√ìN ================= -->
    <section id="settings" class="view-section">
      <h2 class="mb-30"><i class="fas fa-cog"></i> Configuraci√≥n</h2>
      
      <div class="control-group">
        <h3><i class="fas fa-key"></i> Configuraci√≥n de API</h3>
        <div class="form-group">
          <label>API Key de Groq (para an√°lisis con IA):</label>
          <input type="password" id="apiKeyConfig" class="form-control" placeholder="gsk_...">
          <small class="text-secondary">Obtenla en <a href="https://console.groq.com" target="_blank">console.groq.com</a></small>
        </div>
        <div class="form-group">
          <label>Token de Mapbox:</label>
          <input type="text" id="mapboxToken" class="form-control" value="pk.eyJ1IjoiZG9ubmF6YXZhbGEiLCJhIjoiY21rMjRvOHA4MGRpZDNlcHhidnp3MmFuaCJ9.EaxKYFP3unsYAeGT_8eK-A">
          <small class="text-secondary">Token incluido para desarrollo</small>
        </div>
        <button class="btn btn-primary" id="saveSettingsBtn">
          <i class="fas fa-save"></i> Guardar Configuraci√≥n
        </button>
      </div>
      
      <div class="control-group">
        <h3><i class="fas fa-database"></i> Gesti√≥n de Datos</h3>
        <div class="btn-group">
          <button class="btn btn-secondary" id="exportDataBtn">
            <i class="fas fa-download"></i> Exportar Datos
          </button>
          <button class="btn btn-danger" id="clearAllDataBtn">
            <i class="fas fa-trash"></i> Limpiar Todos los Datos
          </button>
        </div>
      </div>
      
      <div class="control-group">
        <h3><i class="fas fa-info-circle"></i> Informaci√≥n del Sistema</h3>
        <div class="form-group">
          <label>Versi√≥n:</label>
          <div>Geo-Suite Canc√∫n PRO v2.0</div>
        </div>
        <div class="form-group">
          <label>Knowledgebase:</label>
          <div id="kbInfo">Cargando...</div>
        </div>
        <div class="form-group">
          <label>Datos Cargados:</label>
          <div id="dataInfo">0 registros</div>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- NAVEGACI√ìN M√ìVIL -->
<div class="mobile-nav">
  <!-- ‚úÖ PASO 6: BADGE DE CONTADOR CAPTURA (M√ìVIL) -->
  <div id="mobileCaptureWidget" style="padding: 12px; background: linear-gradient(90deg, #0284c7, #0369a1); color: white; border-bottom: 2px solid #0369a1; display: none; font-weight: 600; text-align: center; font-size: 13px;">
    <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
      <i class="fas fa-inbox"></i>
      <span id="mobileCaptureCount">0</span>
      <span>registros</span>
    </div>
  </div>
  
  <div class="mobile-nav-buttons">
    <button class="mobile-nav-btn active" data-view="dashboard">
      <i class="fas fa-chart-pie"></i>
      <span>Dashboard</span>
    </button>
    <button class="mobile-nav-btn" data-view="map-section">
      <i class="fas fa-map"></i>
      <span>Mapa</span>
    </button>
    <button class="mobile-nav-btn" data-view="data">
      <i class="fas fa-database"></i>
      <span>Datos</span>
    </button>
    <button class="mobile-nav-btn" data-view="analysis">
      <i class="fas fa-chart-line"></i>
      <span>An√°lisis</span>
    </button>
    <button class="mobile-nav-btn" data-view="more">
      <i class="fas fa-ellipsis-h"></i>
      <span>M√°s</span>
    </button>
  </div>
</div>

<!-- MODAL PARA M√ÅS OPCIONES (M√ìVIL) -->
<div id="moreModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(2, 6, 23, 0.9); z-index: 101; display: flex; align-items: center; justify-content: center;">
  <div style="background: var(--bg-card); border-radius: 20px; padding: 30px; width: 90%; max-width: 400px;">
    <h3 style="margin-bottom: 20px;">Opciones</h3>
    <div style="display: grid; gap: 10px;">
      <button class="mobile-nav-btn" onclick="showView('zones'); closeMoreModal();">
        <i class="fas fa-map-marker-alt"></i> Zonas
      </button>
      <button class="mobile-nav-btn" onclick="showView('pitch'); closeMoreModal();">
        <i class="fas fa-bullhorn"></i> Pitch
      </button>
      <button class="mobile-nav-btn" onclick="showView('routes'); closeMoreModal();">
        <i class="fas fa-route"></i> Rutas
      </button>
      <button class="mobile-nav-btn" onclick="showView('reports'); closeMoreModal();">
        <i class="fas fa-file-alt"></i> Reportes
      </button>
      <button class="mobile-nav-btn" onclick="showView('settings'); closeMoreModal();">
        <i class="fas fa-cog"></i> Configuraci√≥n
      </button>
    </div>
    <button class="btn btn-secondary mt-20" onclick="closeMoreModal()">
      <i class="fas fa-times"></i> Cerrar
    </button>
  </div>
</div>

<script>
// ============================================
// CONFIGURACI√ìN INICIAL
// ============================================

// Token de Mapbox (incluido)
mapboxgl.accessToken = 'pk.eyJ1IjoiZG9ubmF6YXZhbGEiLCJhIjoiY21rMjRvOHA4MGRpZDNlcHhidnp3MmFuaCJ9.EaxKYFP3unsYAeGT_8eK-A';

// Variables globales
let salesData = [];
let filteredData = [];
let map = null;
let markers = [];
let routeLayer = null;
let charts = {};
let generatedReports = [];
let knowledgeBase = null;
let currentCalculatedRoute = null;
let analyticsOrchestrator = null;

// ============================================
// IMPORTACI√ìN DIN√ÅMICA DEL KNOWLEDGEBASE
// ============================================

async function loadKnowledgeBase() {
  try {
    // Intentar cargar el knowledgebase como m√≥dulo ES6
    const module = await import('./knowledgebase.js');
    knowledgeBase = module;
    
    console.log('‚úÖ Knowledgebase cargado correctamente');
    document.getElementById('kbInfo').textContent = 'Cargado correctamente';
    document.getElementById('kbInfo').className = 'text-success';
    // Mostrar ejemplo de uso
    showNotification('Knowledgebase cargado. Funciones avanzadas disponibles.', 'success');
    
    // Probar funciones b√°sicas
    testKnowledgeBase();
    
  } catch (error) {
    console.error('‚ùå Error cargando knowledgebase:', error);
    document.getElementById('kbInfo').textContent = 'Error al cargar: ' + error.message;
    document.getElementById('kbInfo').className = 'text-danger';
    
    // Crear un knowledgebase de respaldo
    createFallbackKnowledgeBase();
  }
}

function testKnowledgeBase() {
  if (!knowledgeBase) return;
  
  try {
    // Probar funci√≥n de zonas √≥ptimas
    const zonas = knowledgeBase.CancunSpecificAnalytics?.getOptimalZonesByHour(14);
    console.log('Zonas √≥ptimas a las 14:00:', zonas);
    
    // Probar c√°lculo de riesgo
    const riesgo = knowledgeBase.CancunSpecificAnalytics?.calculateLogisticRisk('centro', 18);
    console.log('Riesgo en centro a las 18:00:', riesgo);
    
  } catch (error) {
    console.error('Error probando knowledgebase:', error);
  }
}

function createFallbackKnowledgeBase() {
  // Knowledgebase de respaldo con funciones b√°sicas
  knowledgeBase = {
    cancunKnowledgeBase: {
      zonas: [
        { id: 'centro', nombre: 'Centro', pesoComercial: 0.9 },
        { id: 'hotel_zone', nombre: 'Zona Hotelera', pesoComercial: 0.8 },
        { id: 'region_247', nombre: 'Regi√≥n 247', pesoComercial: 0.7 },
        { id: 'supermanzana', nombre: 'Supermanzana', pesoComercial: 0.6 },
        { id: 'puerto_juares', nombre: 'Puerto Ju√°rez', pesoComercial: 0.4 }
      ]
    },
    
    CancunSpecificAnalytics: {
      getOptimalZonesByHour: function(hora) {
        if (hora >= 8 && hora <= 12) return ['Centro', 'Zona Hotelera'];
        if (hora >= 13 && hora <= 18) return ['Regi√≥n 247', 'Supermanzana'];
        return ['Centro', 'Puerto Ju√°rez'];
      },
      
      calculateLogisticRisk: function(zonaId, hora) {
        return {
          riskScore: hora >= 17 && hora <= 20 ? 7 : 3,
          recommendation: hora >= 17 && hora <= 20 ? 
            'Tr√°fico pesado. Considerar rutas alternativas.' : 
            'Condiciones normales.'
        };
      },
      
      getSeasonFactor: function(mes) {
        if ([12, 1, 2, 3].includes(mes)) return 1.5;
        if ([7, 8].includes(mes)) return 1.3;
        return 1.0;
      }
    },
    
    AdvancedAnalytics: {
      monteCarloSimulation: function(datos, iteraciones = 5000) {
        const media = datos.reduce((a, b) => a + b) / datos.length;
        const desviacion = Math.sqrt(
          datos.reduce((sq, n) => sq + Math.pow(n - media, 2), 0) / datos.length
        );
        
        // Simulaci√≥n Monte Carlo simple
        let resultados = [];
        for (let i = 0; i < iteraciones; i++) {
          const muestra = media + (Math.random() - 0.5) * 2 * desviacion;
          resultados.push(muestra);
        }
        
        const resultadosOrdenados = resultados.sort((a, b) => a - b);
        const percentil95 = resultadosOrdenados[Math.floor(iteraciones * 0.95)];
        const percentil5 = resultadosOrdenados[Math.floor(iteraciones * 0.05)];
        
        return {
          media: media.toFixed(2),
          desviacion: desviacion.toFixed(2),
          confidenceInterval: {
            lower: percentil5.toFixed(2),
            upper: percentil95.toFixed(2)
          },
          forecast: media.toFixed(2)
        };
      },
      
      optimizarRuta: function(puntos, origen) {
        // Algoritmo simple del vecino m√°s cercano
        const ruta = [];
        let puntoActual = origen;
        const puntosRestantes = [...puntos];
        
        while (puntosRestantes.length > 0) {
          let indiceMasCercano = 0;
          let distanciaMasCercana = Infinity;
          
          for (let i = 0; i < puntosRestantes.length; i++) {
            const distancia = Math.sqrt(
              Math.pow(puntosRestantes[i].x - puntoActual.x, 2) +
              Math.pow(puntosRestantes[i].y - puntoActual.y, 2)
            );
            
            if (distancia < distanciaMasCercana) {
              distanciaMasCercana = distancia;
              indiceMasCercano = i;
            }
          }
          
          ruta.push(`Punto ${puntosRestantes[indiceMasCercano].id}`);
          puntoActual = puntosRestantes[indiceMasCercano];
          puntosRestantes.splice(indiceMasCercano, 1);
        }
        
        return ruta;
      },
      
      calcularEficiencia: function(distancia, tiempo, paradas) {
        const eficiencia = (paradas * 100) / (distancia * tiempo / 60);
        return Math.min(100, Math.round(eficiencia));
      }
    },
    
    Utils: {
      isValidZone: function(zoneId) {
        return ['centro', 'hotel_zone', 'region_247', 'supermanzana', 'puerto_juares'].includes(zoneId);
      }
    }
  };
  
  console.log('‚ö†Ô∏è Knowledgebase de respaldo cargado');
}
function exportAnalysisResults() {
  if (!analyticsOrchestrator || !analyticsOrchestrator.results) {
    showNotification('No hay resultados para exportar', 'warning');
    return;
  }
  
  const dataStr = analyticsOrchestrator.exportResults('json');
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  
  const exportFileDefaultName = `analisis-completo-${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  
  showNotification('An√°lisis exportado como JSON', 'success');
}
// ============================================
// MANEJO DE INTERFAZ
// ============================================
// Inicializar m√≥dulos cuando haya datos
// Esto se puede hacer autom√°ticamente despu√©s de cargar datos
 
function onDataLoaded() {
  console.log('üîÑ [onDataLoaded] Iniciando reinicializaci√≥n de m√≥dulos...');
  console.log('üìä salesData:', salesData?.length || 0, 'registros');
  console.log('üîç filteredData:', filteredData?.length || 0, 'registros');
  
  // PASO 1: Validar estructura de datos
  if (!salesData || salesData.length === 0) {
    console.warn('‚ùå [onDataLoaded] No hay datos en salesData');
    showNotification('No hay datos cargados para analizar', 'warning');
    return;
  }
  
  // PASO 2: Validar propiedades requeridas
  const requiredFields = ['zona', 'timestamp', 'pitchType', 'result'];
  const firstRecord = salesData[0];
  const missingFields = requiredFields.filter(field => !(field in firstRecord));
  
  if (missingFields.length > 0) {
    console.error('‚ùå [onDataLoaded] Campos faltantes:', missingFields);
    console.error('üìã Estructura encontrada:', Object.keys(firstRecord));
    showNotification(`Estructura de datos inv√°lida. Faltan: ${missingFields.join(', ')}`, 'error');
    return;
  }
  
  console.log('‚úÖ [onDataLoaded] Estructura de datos validada');
  
  // PASO 3: Resetear orquestador anterior si existe
  if (window.analyticsOrchestrator) {
    console.log('üßπ [onDataLoaded] Limpiando orquestador anterior...');
    window.analyticsOrchestrator = null;
  }
  
  // PASO 4: Inicializar m√≥dulos avanzados
  console.log('üöÄ [onDataLoaded] Llamando initAdvancedModules()...');
  setTimeout(() => {
    initAdvancedModules();
    console.log('‚úÖ [onDataLoaded] initAdvancedModules() completado');
  }, 500);
}

// ============================================
// COMANDOS DE DEBUGGING PARA SINCRONIZACI√ìN CSV
// ============================================

function verifyDataSync() {
  console.clear();
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('         ‚úÖ VERIFICACI√ìN DE SINCRONIZACI√ìN DE DATOS');
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
  
  // 1. Verificar datos cargados
  if (!window.salesData || window.salesData.length === 0) {
    console.log('‚ùå No hay datos cargados');
    return;
  }
  
  console.log(`üìä TOTAL REGISTROS: ${window.salesData.length}\n`);
  
  // 2. Mostrar primer registro
  const firstRecord = window.salesData[0];
  console.log('üìã ESTRUCTURA DE DATOS (Primer Registro):');
  console.log(firstRecord);
  console.log('');
  
  // 3. Verificar campos cr√≠ticos
  console.log('‚úÖ CAMPOS REQUERIDOS:');
  const requiredFields = ['zona', 'timestamp', 'pitchType', 'result', 'clientOrigin'];
  requiredFields.forEach(field => {
    const hasField = field in firstRecord;
    const value = firstRecord[field];
    console.log(`   ${hasField ? '‚úÖ' : '‚ùå'} ${field}: ${value}`);
  });
  console.log('');
  
  // 4. Verificar valores "unknown"
  console.log('üîç VERIFICACI√ìN DE "UNKNOWN":');
  const unknownCount = window.salesData.filter(r => 
    Object.values(r).some(v => String(v).toLowerCase() === 'unknown')
  ).length;
  
  if (unknownCount === 0) {
    console.log('   ‚úÖ No hay valores "unknown"');
  } else {
    console.log(`   ‚ùå ${unknownCount} registros con "unknown"`);
    const examples = window.salesData.filter(r => 
      Object.values(r).some(v => String(v).toLowerCase() === 'unknown')
    ).slice(0, 3);
    examples.forEach((r, idx) => {
      console.log(`      Registro ${idx + 1}:`, r);
    });
  }
  console.log('');
  
  // 5. Verificar UTF-8
  console.log('üî§ VERIFICACI√ìN UTF-8:');
  const hasInvalidUTF = window.salesData.some(r => 
    JSON.stringify(r).match(/√É[√°-√∫]/g)
  );
  
  if (!hasInvalidUTF) {
    console.log('   ‚úÖ Todos los caracteres UTF-8 est√°n limpios');
  } else {
    console.log('   ‚ö†Ô∏è Algunos registros pueden tener encoding corrupto');
  }
  console.log('');
  
  // 6. Resumen
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  if (unknownCount === 0 && !hasInvalidUTF) {
    console.log('‚úÖ SINCRONIZACI√ìN COMPLETADA');
    console.log('   Todos los datos est√°n listos para an√°lisis');
  } else {
    console.log('‚ö†Ô∏è REVISAR DATOS');
    console.log('   Hay problemas que corregir');
  }
  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
}

function showDataSample(count = 5) {
  if (!window.salesData || window.salesData.length === 0) {
    console.log('‚ùå No hay datos cargados');
    return;
  }
  
  console.log(`üìã Primeros ${count} registros:`);
  window.salesData.slice(0, count).forEach((record, idx) => {
    console.log(`\nRegistro ${idx + 1}:`);
    console.log(record);
  });
}

function showDataIssues() {
  if (!window.salesData || window.salesData.length === 0) {
    console.log('‚ùå No hay datos cargados');
    return;
  }
  
  console.log('üîç PROBLEMAS ENCONTRADOS:\n');
  
  // Registros con "unknown"
  const unknownRecords = window.salesData.filter(r => 
    Object.values(r).some(v => String(v).toLowerCase() === 'unknown')
  );
  
  if (unknownRecords.length > 0) {
    console.log(`‚ùå ${unknownRecords.length} registros con valores "unknown":`);
    unknownRecords.slice(0, 5).forEach((r, idx) => {
      const unknownFields = Object.entries(r)
        .filter(([k, v]) => String(v).toLowerCase() === 'unknown')
        .map(([k]) => k);
      console.log(`   Registro ${idx + 1}: Campos [${unknownFields.join(', ')}]`, r);
    });
    console.log('');
  }
  
  // Campos vac√≠os
  const emptyRecords = window.salesData.filter(r =>
    Object.values(r).some(v => !v || String(v).trim() === '')
  );
  
  if (emptyRecords.length > 0) {
    console.log(`‚ö†Ô∏è ${emptyRecords.length} registros con campos vac√≠os`);
    console.log('');
  }
  
  if (unknownRecords.length === 0 && emptyRecords.length === 0) {
    console.log('‚úÖ No hay problemas encontrados');
  }
}

// Exponer en ventana global
window.verifyDataSync = verifyDataSync;
window.showDataSample = showDataSample;
window.showDataIssues = showDataIssues;

console.log('‚úÖ Comandos de debugging cargados:');
console.log('   - verifyDataSync()    ‚Üí Verificaci√≥n completa');
console.log('   - showDataSample(n)   ‚Üí Ver primeros n registros');
console.log('   - showDataIssues()    ‚Üí Ver problemas');

function showView(viewId) {
  // Ocultar todas las secciones
  document.querySelectorAll('.view-section').forEach(section => {
    section.classList.remove('active');
  });
  
  // Remover active de todos los botones
  document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Mostrar la secci√≥n solicitada
  const targetSection = document.getElementById(viewId);
  if (targetSection) {
    targetSection.classList.add('active');
  }
  
  // Activar botones correspondientes
  const navBtn = document.querySelector(`.nav-btn[data-view="${viewId}"]`);
  const mobileBtn = document.querySelector(`.mobile-nav-btn[data-view="${viewId}"]`);
  
  if (navBtn) navBtn.classList.add('active');
  if (mobileBtn) mobileBtn.classList.add('active');
  
  // Si es la vista "more" en m√≥vil, mostrar modal
  if (viewId === 'more' && window.innerWidth <= 1024) {
    document.getElementById('moreModal').classList.remove('hidden');
  } else {
    document.getElementById('moreModal').classList.add('hidden');
  }
  
  // Si es el mapa, inicializarlo si no est√° hecho
  if (viewId === 'map-section' && !map) {
    setTimeout(initMap, 100);
  }
  
  // Si es dashboard, actualizar gr√°ficos
  if (viewId === 'dashboard' && salesData.length > 0) {
    setTimeout(updateCharts, 100);
  }

  // üîÑ Si es an√°lisis completo, inicializarlo si hay datos
  if (viewId === 'complete-analysis' && filteredData.length > 0) {
    setTimeout(() => {
      if (typeof initCompleteAnalysis === 'function') {
        initCompleteAnalysis();
      }
    }, 100);
  }
  
  // ‚ú® Actualizar breadcrumb
  updateNavigationBreadcrumb(viewId);
}

function updateNavigationBreadcrumb(viewId) {
  const viewNames = {
    'dashboard': 'Dashboard Principal',
    'map': 'Mapa Interactivo',
    'data': 'Datos y CSV',
    'analysis': 'An√°lisis Avanzado',
    'zones': 'Zonas Estrat√©gicas',
    'pitch': 'Recomendaciones',
    'routes': 'Rutas Optimizadas',
    'tools': 'Herramientas',
    'complete-analysis': 'An√°lisis Detallado',
    'reports': 'Reportes',
    'settings': 'Configuraci√≥n'
  };
  const section = document.getElementById(viewId);
  if (section) {
    const existing = section.querySelector('.view-breadcrumb');
    if (!existing) {
      const breadcrumb = document.createElement('div');
      breadcrumb.className = 'view-breadcrumb';
      breadcrumb.innerHTML = `<button class="btn-back" onclick="showView('dashboard')"><i class="fas fa-arrow-left"></i> Volver</button><span class="breadcrumb-path">${viewNames[viewId] || viewId}</span>`;
      section.insertBefore(breadcrumb, section.firstChild);
    }
  }
  
  // Cargar datos de zonas si es la secci√≥n de zonas
  if (viewId === 'zones' && window.salesData && window.salesData.length > 0) {
    setTimeout(loadZonesSummary, 100);
  }
}

function loadZonesSummary() {
  const summary = document.getElementById('zonesSummary');
  if (!summary || !window.salesData || window.salesData.length === 0) return;
  
  const zoneStats = {};
  const zones = ['zona_hotelera', 'centro', 'region_237', 'region_233', 'sm_91', 'sm_77'];
  
  zones.forEach(zone => {
    const zoneData = window.salesData.filter(d => d.zona === zone || d.zona === zone.replace('_', ' '));
    const successful = zoneData.filter(d => d.result === 'successful').length;
    const total = zoneData.length;
    const rate = total > 0 ? ((successful / total) * 100).toFixed(1) : 0;
    const totalAmount = zoneData.reduce((sum, d) => sum + (parseFloat(d.monto) || 0), 0);
    
    if (total > 0) {
      zoneStats[zone] = { total, successful, rate, totalAmount };
    }
  });
  
  summary.innerHTML = Object.entries(zoneStats).map(([zone, stats]) => `
    <div class="kpi-card">
      <h3>${zone.replace('_', ' ').toUpperCase()}</h3>
      <div class="value">${stats.total} ventas</div>
      <div class="change positive">
        <i class="fas fa-chart-line"></i> ${stats.rate}% conversi√≥n
      </div>
      <div class="text-secondary" style="font-size: 0.9rem; margin-top: 8px;">
        üí∞ $${stats.totalAmount.toFixed(0)}
      </div>
    </div>
  `).join('');
  
  summary.style.display = 'grid';
}

function closeMoreModal() {
  document.getElementById('moreModal').classList.add('hidden');
}

// Funci√≥n para cerrar mobile-nav autom√°ticamente
function closeMobileNav() {
  const mobileNav = document.querySelector('.mobile-nav');
  if (mobileNav && window.innerWidth <= 768) {
    mobileNav.classList.add('hidden');
  }
}

// Inicializar eventos de navegaci√≥n
document.querySelectorAll('.nav-btn, .mobile-nav-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    const viewId = this.getAttribute('data-view');
    if (viewId) {
      showView(viewId);
      closeMobileNav(); // Cerrar nav m√≥vil despu√©s de seleccionar vista
    }
  });
});

// Notificaciones
function showNotification(message, type = 'info') {
  const notification = document.getElementById('notification');
  const icon = document.getElementById('notification-icon');
  const text = document.getElementById('notification-text');
  
  // Configurar seg√∫n tipo
  const configs = {
    success: { icon: 'check-circle', color: '#10b981' },
    warning: { icon: 'exclamation-triangle', color: '#f59e0b' },
    error: { icon: 'times-circle', color: '#ef4444' },
    info: { icon: 'info-circle', color: '#38bdf8' }
  };
  const config = configs[type] || configs.info;
  
  // Actualizar contenido
  icon.className = `fas fa-${config.icon}`;
  icon.style.color = config.color;
  text.textContent = message;
  
  // Mostrar
  notification.classList.add('show', type);
  
  // Ocultar despu√©s de 5 segundos
  setTimeout(() => {
    notification.classList.remove('show');
  }, 5000);
}

// Loading overlay
function showLoading(message = 'Procesando...') {
  document.getElementById('loadingText').textContent = message;
  document.getElementById('loadingOverlay').classList.remove('hidden');
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.add('hidden');
}

// ============================================
// MANEJO DE DATOS CSV
// ============================================

// üß™ FUNCI√ìN DE VERIFICACI√ìN: Ejecuta window.verifyCSVFix() en consola
window.verifyCSVFix = function() {
  console.clear();
  console.log('%cüîç VERIFICANDO FIXES DE CSV NORMALIZATION', 'color: blue; font-size: 14px; font-weight: bold');
  
  if (!window.salesData || window.salesData.length === 0) {
    console.warn('‚ö†Ô∏è Sin datos. Carga CSV o ejecuta: window.testLoadSampleData()');
    return;
  }
  
  let issues = 0;
  window.salesData.forEach((r, i) => {
    const ok = r.zona !== 'unknown' && r.pitchType !== 'unknown' && r.result !== 'unknown';
    if (!ok) issues++;
    const symbol = ok ? '‚úÖ' : '‚ùå';
    console.log(`${symbol} [${i+1}] zona=${r.zona}, pitch=${r.pitchType}, result=${r.result}, origen=${r.clientOrigin}`);
  });
  
  if (issues === 0) {
    console.log('%cüéâ ¬°TODOS LOS FIXES FUNCIONAN!', 'color: green; font-weight: bold; background: #90EE90; padding: 5px');
  } else {
    console.log(`%c‚ö†Ô∏è A√∫n hay ${issues} problemas`, 'color: red; font-weight: bold');
  }
};

// üß™ NUEVA FUNCI√ìN: Verificar lectura de datos
window.verifyDataRead = function() {
  console.clear();
  console.log('%cüìä VERIFICACI√ìN DE LECTURA DE DATOS', 'color: blue; font-size: 14px; font-weight: bold');
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  
  if (!window.salesData || window.salesData.length === 0) {
    console.warn('‚ö†Ô∏è Sin datos cargados');
    return;
  }
  
  console.log(`üìà Total registros: ${window.salesData.length}\\n`);
  
  // Verificar montos
  const montos = window.salesData.map(r => r.monto);
  const montosValidos = montos.filter(m => m !== null && m !== undefined && m !== 0 && !isNaN(m));
  const montoTotal = montos.reduce((sum, m) => sum + (parseFloat(m) || 0), 0);
  
  console.log('üí∞ MONTOS:');
  console.log(`   Total: $${montoTotal.toFixed(2)}`);
  console.log(`   Promedio: $${(montoTotal / montos.length).toFixed(2)}`);
  console.log(`   Min: $${Math.min(...montosValidos).toFixed(2)}`);
  console.log(`   Max: $${Math.max(...montosValidos).toFixed(2)}`);
  console.log(`   Ceros: ${montos.filter(m => m === 0).length}`);
  console.log(`   NaN: ${montos.filter(m => isNaN(m)).length}`);
  
  // Verificar fechas
  console.log('\\nüìÖ FECHAS:');
  const fechas = window.salesData.map(r => r.fechaStr);
  const fechasUnicas = [...new Set(fechas)];
  console.log(`   Fechas √∫nicas: ${fechasUnicas.length}`);
  fechasUnicas.forEach(f => {
    const count = fechas.filter(d => d === f).length;
    console.log(`   - ${f}: ${count} registros`);
  });
  
  // Verificar zonas
  console.log('\\nüìç ZONAS:');
  const zonas = [...new Set(window.salesData.map(r => r.zona))];
  zonas.forEach(z => {
    const count = window.salesData.filter(r => r.zona === z).length;
    const total = window.salesData.filter(r => r.zona === z).reduce((sum, r) => sum + r.monto, 0);
    console.log(`   ${z}: ${count} registros, $${total.toFixed(2)}`);
  });
  
  // Verificar clientes
  console.log('\\nüë• CLIENTES:');
  const clientes = [...new Set(window.salesData.map(r => r.cliente))];
  console.log(`   Total clientes √∫nicos: ${clientes.length}`);
  
  console.log('\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  console.log('%c‚úÖ VERIFICACI√ìN COMPLETADA', 'color: green; font-weight: bold');
};

// ‚≠ê FUNCIONES COUNTIF/SUMIF - Contar y sumar por criterio
window.COUNTIF = function(dataArray, columnName, criteria, options = {}) {
  const { caseSensitive = false, partialMatch = false } = options;
  if (!dataArray || !Array.isArray(dataArray)) return 0;
  
  const normalizeValue = (val) => {
    if (val === null || val === undefined) return '';
    val = String(val).trim();
    return caseSensitive ? val : val.toLowerCase();
  };
  
  const normCriteria = normalizeValue(criteria);
  let count = 0;
  
  dataArray.forEach(row => {
    const cellValue = normalizeValue(row[columnName]);
    if (partialMatch) {
      if (cellValue.includes(normCriteria)) count++;
    } else {
      if (cellValue === normCriteria) count++;
    }
  });
  
  return count;
};

window.SUMIF = function(dataArray, columnName, criteria, sumColumn, options = {}) {
  const { caseSensitive = false, partialMatch = false } = options;
  if (!dataArray || !Array.isArray(dataArray)) return 0;
  
  const normalizeValue = (val) => {
    if (val === null || val === undefined) return '';
    val = String(val).trim();
    return caseSensitive ? val : val.toLowerCase();
  };
  
  const normCriteria = normalizeValue(criteria);
  let sum = 0;
  let count = 0;
  
  dataArray.forEach(row => {
    const cellValue = normalizeValue(row[columnName]);
    let matches = false;
    
    if (partialMatch) {
      matches = cellValue.includes(normCriteria);
    } else {
      matches = cellValue === normCriteria;
    }
    
    if (matches) {
      const sumValue = parseFloat(row[sumColumn]) || 0;
      sum += sumValue;
      count++;
    }
  });
  
  return { sum, count, average: count > 0 ? sum / count : 0 };
};

// üìä An√°lisis de pitches - Contar usos y efectividad
window.analyzeByPitch = function() {
  console.clear();
  console.log('%cüéØ AN√ÅLISIS DE PITCHES', 'color: #ff6b00; font-size: 14px; font-weight: bold');
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  
  if (!window.salesData || window.salesData.length === 0) {
    console.warn('‚ö†Ô∏è Sin datos');
    return;
  }
  
  // Extraer pitches √∫nicos
  const pitchTypes = ['autoridad', 'nostalgia', 'escasez', 'comunidad'];
  
  pitchTypes.forEach(pitch => {
    const count = window.COUNTIF(window.salesData, 'pitchType', pitch);
    const result = window.SUMIF(window.salesData, 'pitchType', pitch, 'monto');
    const successful = window.COUNTIF(window.salesData, 'pitchType', pitch, {partialMatch: false});
    
    console.log(`\\nüé§ ${pitch.toUpperCase()}`);
    console.log(`   Veces usado: ${count}`);
    console.log(`   Ingresos: $${result.sum.toFixed(2)}`);
    console.log(`   Ticket promedio: $${result.average.toFixed(2)}`);
  });
  
  console.log('\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
};

// üìä An√°lisis de or√≠genes - Contar por cliente origin
window.analyzeByOrigin = function() {
  console.clear();
  console.log('%cüåç AN√ÅLISIS DE OR√çGENES', 'color: #0066cc; font-size: 14px; font-weight: bold');
  console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
  
  if (!window.salesData || window.salesData.length === 0) {
    console.warn('‚ö†Ô∏è Sin datos');
    return;
  }
  
  // Extraer or√≠genes √∫nicos
  const origins = [...new Set(window.salesData.map(r => r.clientOrigin))];
  
  origins.forEach(origin => {
    if (origin === 'unknown') return;
    const count = window.COUNTIF(window.salesData, 'clientOrigin', origin);
    const result = window.SUMIF(window.salesData, 'clientOrigin', origin, 'monto');
    
    console.log(`\\nüèôÔ∏è ${origin}`);
    console.log(`   Clientes: ${count}`);
    console.log(`   Ingresos: $${result.sum.toFixed(2)}`);
    console.log(`   Ticket promedio: $${result.average.toFixed(2)}`);
  });
  
  console.log('\\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
};

// ‚≠ê FUNCIONES COUNTIF/SUMIF - Excel-style counting and summing
window.COUNTIF = function(dataArray, columnName, criteria, options = {}) {
  const { caseSensitive = false, partialMatch = false } = options;
  if (!dataArray || !Array.isArray(dataArray)) return 0;
  
  const normalizeValue = (val) => {
    if (val === null || val === undefined || val === 'unknown') return '';
    val = String(val).trim();
    return caseSensitive ? val : val.toLowerCase();
  };
  
  const normCriteria = normalizeValue(criteria);
  let count = 0;
  
  dataArray.forEach(row => {
    if (!row) return;
    const cellValue = normalizeValue(row[columnName]);
    if (partialMatch) {
      if (cellValue.includes(normCriteria)) count++;
    } else {
      if (cellValue === normCriteria) count++;
    }
  });
  
  return count;
};

window.SUMIF = function(dataArray, columnName, criteria, sumColumn, options = {}) {
  const { caseSensitive = false, partialMatch = false } = options;
  if (!dataArray || !Array.isArray(dataArray)) return { sum: 0, count: 0, average: 0 };
  
  const normalizeValue = (val) => {
    if (val === null || val === undefined || val === 'unknown') return '';
    val = String(val).trim();
    return caseSensitive ? val : val.toLowerCase();
  };
  
  const normCriteria = normalizeValue(criteria);
  let sum = 0;
  let count = 0;
  
  dataArray.forEach(row => {
    if (!row) return;
    const cellValue = normalizeValue(row[columnName]);
    let matches = false;
    
    if (partialMatch) {
      matches = cellValue.includes(normCriteria);
    } else {
      matches = cellValue === normCriteria;
    }
    
    if (matches) {
      const sumValue = parseFloat(row[sumColumn]) || 0;
      sum += sumValue;
      count++;
    }
  });
  
  return { sum, count, average: count > 0 ? sum / count : 0 };
};

// üìä CONTEO Y AN√ÅLISIS - Funciones complejas para an√°lisis estad√≠stico
window.COUNTIFS = function(dataArray, criteria = {}, options = {}) {
  if (!dataArray || !Array.isArray(dataArray)) return 0;
  const { caseSensitive = false } = options;
  
  let count = 0;
  dataArray.forEach(row => {
    if (!row) return;
    let matches = true;
    
    for (const [column, value] of Object.entries(criteria)) {
      const cellValue = String(row[column] || '').trim();
      const criteriaValue = String(value).trim();
      const cell = caseSensitive ? cellValue : cellValue.toLowerCase();
      const crit = caseSensitive ? criteriaValue : criteriaValue.toLowerCase();
      
      if (cell !== crit) {
        matches = false;
        break;
      }
    }
    
    if (matches) count++;
  });
  
  return count;
};

// ============================================
// MANEJO DE DATOS CSV - DROPAREA Y EVENTOS
// ============================================

// Configurar drop area para archivos
const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('csvFile');

dropArea.addEventListener('click', () => fileInput.click());

['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, preventDefaults, false);
  document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
  e.preventDefault();
  e.stopPropagation();
}

['dragenter', 'dragover'].forEach(eventName => {
  dropArea.addEventListener(eventName, () => {
    dropArea.style.borderColor = 'var(--accent-blue)';
    dropArea.style.backgroundColor = 'rgba(56, 189, 248, 0.1)';
  }, false);
});

['dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, () => {
    dropArea.style.borderColor = 'var(--border)';
    dropArea.style.backgroundColor = 'var(--bg-panel)';
  }, false);
});

dropArea.addEventListener('drop', handleDrop, false);
fileInput.addEventListener('change', handleFiles, false);

function handleDrop(e) {
  const dt = e.dataTransfer;
  const files = dt.files;
  handleFiles({ target: { files: files } });
}

function handleFiles(e) {
  const file = e.target.files[0];
  if (!file) return;

  if (file.type !== 'text/csv' && !file.name.toLowerCase().endsWith('.csv')) {
    showNotification('Por favor sube un archivo CSV v√°lido.', 'warning');
    return;
  }

  showLoading('Procesando archivo CSV...');
  
  Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      console.log(`üìä CSV parseado: ${results.data.length} filas`);
      processData(results.data);
      hideLoading();
    },
    error: function(err) {
      showNotification('Error al leer el archivo: ' + err.message, 'error');
      hideLoading();
    }
  });
}

function processData(rawData) {
  console.log('üîÑ Procesando datos de ventas...');

  function sanitizeUTF8(str) {
    if (!str) return '';
    return String(str)
      .replace(/√É¬°/g, '√°').replace(/√É¬©/g, '√©').replace(/√É¬≠/g, '√≠').replace(/√É¬≥/g, '√≥').replace(/√É¬π/g, '√∫')
      .replace(/√É/g, '√Å').replace(/√É‚Ä∞/g, '√â').replace(/√É¬≠/g, '√ç').replace(/√É¬≥/g, '√ì').replace(/√É/g, '√ö')
      .replace(/√É¬±/g, '√±').replace(/√É'/g, '√ë');
  }

  const processedSales = [];
  rawData.forEach((row, index) => {
    try {
      const keys = Object.keys(row);
      const amountKey = keys.find(k => ['amount', 'monto', 'valor', 'venta', 'price', 'precio'].includes(k.toLowerCase()));
      const zoneKey = keys.find(k => ['zone', 'zona', 'region', 'area'].includes(k.toLowerCase()));
      const pitchKey = keys.find(k => ['pitch_type', 'pitchtype', 'tipo_pitch', 'pitch', 'type', 'estrategia', 'disertacion'].includes(k.toLowerCase()));
      const resultKey = keys.find(k => ['result', 'resultado', 'status', 'estado', 'success'].includes(k.toLowerCase()));
      const clientOriginKey = keys.find(k => ['client_origin', 'origin', 'origen', 'clientorigin', 'procedencia'].includes(k.toLowerCase()));
      const dateKey = keys.find(k => ['timestamp', 'date', 'fecha', 'time'].includes(k.toLowerCase()));
      const latKey = keys.find(k => k.toLowerCase().includes('lat'));
      const lngKey = keys.find(k => k.toLowerCase().includes('lon') || k.toLowerCase().includes('lng'));
      const clientKey = keys.find(k => ['client', 'cliente', 'customer', 'client_name', 'nombre'].includes(k.toLowerCase()));

      let lat = parseFloat(row[latKey]);
      let lng = parseFloat(row[lngKey]);
      if (isNaN(lat) || isNaN(lng)) {
        lat = 21.1619 + (Math.random() - 0.5) * 0.1;
        lng = -86.8515 + (Math.random() - 0.5) * 0.1;
      }

      let monto = 0;
      if (amountKey && row[amountKey] !== undefined && row[amountKey] !== '') {
        monto = parseFloat(row[amountKey]);
      }
      if (isNaN(monto)) monto = 0;

      const venta = {
        lat,
        lng,
        monto,
        fechaStr: row[dateKey] || new Date().toISOString().split('T')[0],
        zona: sanitizeUTF8(row[zoneKey] || 'sin_zona').toLowerCase(),
        pitchType: normalizePitch(sanitizeUTF8(row[pitchKey] || '')),
        result: normalizeResult(sanitizeUTF8(row[resultKey] || '')),
        clientOrigin: normalizeOrigin(sanitizeUTF8(row[clientOriginKey] || '')),
        cliente: sanitizeUTF8(row[clientKey] || `Cliente${index + 1}`),
        id: index
      };
      processedSales.push(venta);
    } catch (e) {
      console.error(`Error procesando fila ${index}:`, e);
    }
  });

  console.log(`‚úÖ Datos procesados: ${processedSales.length} registros v√°lidos`);
  if (processedSales.length === 0) {
    showNotification('No se encontraron datos v√°lidos en el CSV.', 'warning');
    return;
  }

  const cleanedData = processedSales.filter(record => {
    const hasUnknown = Object.values(record).some(val => 
      String(val).toLowerCase() === 'unknown' || String(val).toLowerCase() === 'sin_zona'
    );
    return !hasUnknown;
  });

  const cleanedCount = processedSales.length - cleanedData.length;
  if (cleanedCount > 0) {
    console.warn(`‚ö†Ô∏è ${cleanedCount} registros eliminados por contener valores "unknown"`);
  }
  
  if (cleanedData.length === 0) {
    console.error('‚ùå Todos los registros fueron eliminados por contener "unknown"');
    showNotification('Los datos contienen demasiados valores inv√°lidos ("unknown"). Revisa el CSV.', 'error');
    return;
  }

  // Reasignar variables locales y sincronizar con window
  salesData = cleanedData;
  filteredData = [...salesData];
  window.salesData = salesData;
  window.filteredData = filteredData;

  console.log('üìä [processData] Total registros limpios:', salesData.length);
  
  // Actualizar UI
  updateStatistics();
  updateTable();
  updateCharts();
  
  document.getElementById('fileInfo').classList.remove('hidden');
  document.getElementById('fileStatus').textContent = `${salesData.length} registros cargados`;
  
  onDataLoaded();
  
  showNotification(`${salesData.length} ventas cargadas correctamente`, 'success');
}

function normalizePitch(text) {
  if (!text) return 'unknown';
  const lower = text.toLowerCase().trim();
  
  const aliases = {
    'autoridad': ['autoridad', 'authority', 'expert', 'especialista', 'experto'],
    'nostalgia': ['nostalgia', 'memories', 'tradicion', 'tradici√≥n', 'recuerdo'],
    'escasez': ['escasez', 'scarcity', 'limited', 'limitada', 'urgencia', 'urgente'],
    'comunidad': ['comunidad', 'community', 'local', 'juntos', 'grupo']
  };
  
  for (const [canonical, variants] of Object.entries(aliases)) {
    if (variants.some(v => lower.includes(v))) {
      return canonical;
    }
  }
  
  return lower !== '' ? lower : 'unknown';
}

function normalizeResult(text) {
  if (!text) return 'unknown';
  const lower = text.toLowerCase().trim();
  
  // Patrones de √©xito
  if (lower.includes('success') || lower.includes('exitoso') || lower.includes('exito') || 
      lower === 'si' || lower === 'y' || lower === 'true' || lower === '1') {
    return 'successful';
  }
  
  // Patrones de fracaso
  if (lower.includes('fail') || lower.includes('fracaso') || lower.includes('fallido') || 
      lower.includes('fallo') || lower === 'no' || lower === 'n' || lower === 'false' || lower === '0') {
    return 'failed';
  }
  
  // Patrones de pendiente
  if (lower.includes('pend') || lower === 'p') {
    return 'pending';
  }
  
  return lower !== '' ? lower : 'unknown';
}

function normalizeOrigin(text) {
  if (!text) return 'unknown';
  const lower = text.toLowerCase().trim();
  
  if (lower.includes('cdmx') || lower.includes('ciudad de m√©xico') || lower.includes('mexico')) {
    return 'CDMX';
  }
  if (lower.includes('cancun') || lower.includes('local')) {
    return 'Cancun_Local';
  }
  if (lower.includes('quintana')) {
    return 'Quintana_Roo';
  }
  if (lower.includes('yucatan')) {
    return 'Yucatan';
  }
  if (lower.includes('internacional') || lower.includes('international') || lower.includes('turista')) {
    return 'International';
  }
  if (lower.includes('migrant') || lower.includes('migrante')) {
    return 'Migrant';
  }
  
  return lower !== '' ? lower : 'unknown';
}

// ============================================
// FUNCIONES DE AN√ÅLISIS CRUZADO - COUNTIF/SUMIF
// ============================================

/**
 * COUNTIF: Contar ocurrencias de un valor en una columna
 * Equivalente a Excel COUNTIF
 * 
 * Ejemplo:
 *   window.COUNTIF(window.salesData, 'pitchType', 'autoridad')
 *   // Retorna: 5 (cantidad de veces que aparece 'autoridad')
 */
window.COUNTIF = function(dataArray, columnName, criteria, options = {}) {
  const { caseSensitive = false, partialMatch = false } = options;
  
  if (!dataArray || !Array.isArray(dataArray) || dataArray.length === 0) {
    return 0;
  }
  
  const normalizeValue = (val) => {
    if (val === null || val === undefined) return '';
    val = String(val).trim();
    return caseSensitive ? val : val.toLowerCase();
  };
  
  const normCriteria = normalizeValue(criteria);
  let count = 0;
  
  dataArray.forEach(row => {
    const cellValue = normalizeValue(row[columnName]);
    if (partialMatch) {
      if (cellValue.includes(normCriteria)) count++;
    } else {
      if (cellValue === normCriteria) count++;
    }
  });
  
  return count;
};

/**
 * SUMIF: Sumar valores de una columna donde otra columna cumple criterio
 * Equivalente a Excel SUMIF
 * 
 * Ejemplo:
 *   window.SUMIF(window.salesData, 'pitchType', 'autoridad', 'monto')
 *   // Retorna: { sum: 2450, count: 5, average: 490 }
 */
window.SUMIF = function(dataArray, columnName, criteria, sumColumn, options = {}) {
  const { caseSensitive = false, partialMatch = false } = options;
  
  if (!dataArray || !Array.isArray(dataArray) || dataArray.length === 0) {
    return { sum: 0, count: 0, average: 0 };
  }
  
  const normalizeValue = (val) => {
    if (val === null || val === undefined) return '';
    val = String(val).trim();
    return caseSensitive ? val : val.toLowerCase();
  };
  
  const normCriteria = normalizeValue(criteria);
  let sum = 0;
  let count = 0;
  
  dataArray.forEach(row => {
    const cellValue = normalizeValue(row[columnName]);
    let matches = false;
    
    if (partialMatch) {
      matches = cellValue.includes(normCriteria);
    } else {
      matches = cellValue === normCriteria;
    }
    
    if (matches) {
      const sumValue = parseFloat(row[sumColumn]) || 0;
      sum += sumValue;
      count++;
    }
  });
  
  return { 
    sum: parseFloat(sum.toFixed(2)),
    count, 
    average: count > 0 ? parseFloat((sum / count).toFixed(2)) : 0 
  };
};

/**
 * COUNTIFS: Contar con m√∫ltiples criterios
 * Ejemplo:
 *   window.COUNTIFS(window.salesData, 
 *     [['pitchType', 'autoridad'], ['result', 'successful']])
 */
window.COUNTIFS = function(dataArray, criteriaArray) {
  if (!dataArray || !Array.isArray(dataArray)) return 0;
  
  let count = 0;
  
  dataArray.forEach(row => {
    let allMatch = true;
    
    criteriaArray.forEach(([column, criteria]) => {
      const cellValue = String(row[column] || '').toLowerCase().trim();
      const normCriteria = String(criteria).toLowerCase().trim();
      
      if (cellValue !== normCriteria) {
        allMatch = false;
      }
    });
    
    if (allMatch) count++;
  });
  
  return count;
};

/**
 * SUMIFS: Sumar con m√∫ltiples criterios
 * Ejemplo:
 *   window.SUMIFS(window.salesData, 'monto',
 *     [['pitchType', 'autoridad'], ['result', 'successful']])
 */
window.SUMIFS = function(dataArray, sumColumn, criteriaArray) {
  if (!dataArray || !Array.isArray(dataArray)) {
    return { sum: 0, count: 0, average: 0 };
  }
  
  let sum = 0;
  let count = 0;
  
  dataArray.forEach(row => {
    let allMatch = true;
    
    criteriaArray.forEach(([column, criteria]) => {
      const cellValue = String(row[column] || '').toLowerCase().trim();
      const normCriteria = String(criteria).toLowerCase().trim();
      
      if (cellValue !== normCriteria) {
        allMatch = false;
      }
    });
    
    if (allMatch) {
      const sumValue = parseFloat(row[sumColumn]) || 0;
      sum += sumValue;
      count++;
    }
  });
  
  return { 
    sum: parseFloat(sum.toFixed(2)),
    count, 
    average: count > 0 ? parseFloat((sum / count).toFixed(2)) : 0 
  };
};

// ============================================
// FUNCIONES DE AN√ÅLISIS POR PITCH
// ============================================

/**
 * Analizar efectividad de cada pitch type
 * Retorna tabla con conteos, ingresos, y tasas de conversi√≥n
 */
window.analyzePitchEffectiveness = function() {
  if (!window.salesData || window.salesData.length === 0) {
    console.warn('‚ùå Sin datos para analizar');
    return {};
  }
  
  const pitchTypes = ['autoridad', 'nostalgia', 'escasez', 'comunidad'];
  const results = {};
  
  pitchTypes.forEach(pitch => {
    const totalCount = window.COUNTIF(window.salesData, 'pitchType', pitch);
    const successCount = window.COUNTIFS(window.salesData, [['pitchType', pitch], ['result', 'successful']]);
    const failedCount = window.COUNTIFS(window.salesData, [['pitchType', pitch], ['result', 'failed']]);
    const montoData = window.SUMIF(window.salesData, 'pitchType', pitch, 'monto');
    
    const conversionRate = totalCount > 0 ? ((successCount / totalCount) * 100).toFixed(1) : 0;
    
    results[pitch] = {
      total: totalCount,
      successful: successCount,
      failed: failedCount,
      pending: totalCount - successCount - failedCount,
      conversionRate: parseFloat(conversionRate),
      totalRevenue: montoData.sum,
      avgRevenue: montoData.average,
      ticketPromedio: montoData.average
    };
  });
  
  return results;
};

/**
 * Analizar efectividad por client origin
 * Retorna tabla con conteos e ingresos por origen
 */
window.analyzeOriginEffectiveness = function() {
  if (!window.salesData || window.salesData.length === 0) {
    console.warn('‚ùå Sin datos para analizar');
    return {};
  }
  
  const origins = [...new Set(window.salesData.map(r => r.clientOrigin))].filter(o => o !== 'unknown');
  const results = {};
  
  origins.forEach(origin => {
    const totalCount = window.COUNTIF(window.salesData, 'clientOrigin', origin);
    const successCount = window.COUNTIFS(window.salesData, [['clientOrigin', origin], ['result', 'successful']]);
    const montoData = window.SUMIF(window.salesData, 'clientOrigin', origin, 'monto');
    
    const conversionRate = totalCount > 0 ? ((successCount / totalCount) * 100).toFixed(1) : 0;
    
    results[origin] = {
      total: totalCount,
      successful: successCount,
      conversionRate: parseFloat(conversionRate),
      totalRevenue: montoData.sum,
      avgRevenue: montoData.average
    };
  });
  
  return results;
};

/**
 * An√°lisis cruzado: Pitch √ó Zone
 * Qu√© pitch funciona mejor en cada zona
 */
window.analyzePitchByZone = function() {
  if (!window.salesData || window.salesData.length === 0) {
    console.warn('‚ùå Sin datos para analizar');
    return {};
  }
  
  const zones = [...new Set(window.salesData.map(r => r.zona))];
  const pitches = ['autoridad', 'nostalgia', 'escasez', 'comunidad'];
  const results = {};
  
  zones.forEach(zone => {
    results[zone] = {};
    
    pitches.forEach(pitch => {
      const count = window.COUNTIFS(window.salesData, [['zona', zone], ['pitchType', pitch]]);
      const successCount = window.COUNTIFS(window.salesData, [['zona', zone], ['pitchType', pitch], ['result', 'successful']]);
      const montoData = window.SUMIFS(window.salesData, 'monto', [['zona', zone], ['pitchType', pitch]]);
      
      const rate = count > 0 ? ((successCount / count) * 100).toFixed(1) : 0;
      
      results[zone][pitch] = {
        count,
        successful: successCount,
        rate: parseFloat(rate),
        totalRevenue: montoData.sum
      };
    });
  });
  
  return results;
};

/**
 * An√°lisis cruzado: Pitch √ó Client Origin
 * Qu√© pitch funciona mejor para cada origen de cliente
 */
window.analyzePitchByOrigin = function() {
  if (!window.salesData || window.salesData.length === 0) {
    console.warn('‚ùå Sin datos para analizar');
    return {};
  }
  
  const origins = [...new Set(window.salesData.map(r => r.clientOrigin))].filter(o => o !== 'unknown');
  const pitches = ['autoridad', 'nostalgia', 'escasez', 'comunidad'];
  const results = {};
  
  origins.forEach(origin => {
    results[origin] = {};
    
    pitches.forEach(pitch => {
      const count = window.COUNTIFS(window.salesData, [['clientOrigin', origin], ['pitchType', pitch]]);
      const successCount = window.COUNTIFS(window.salesData, [['clientOrigin', origin], ['pitchType', pitch], ['result', 'successful']]);
      const montoData = window.SUMIFS(window.salesData, 'monto', [['clientOrigin', origin], ['pitchType', pitch]]);
      
      const rate = count > 0 ? ((successCount / count) * 100).toFixed(1) : 0;
      
      results[origin][pitch] = {
        count,
        successful: successCount,
        rate: parseFloat(rate),
        totalRevenue: montoData.sum
      };
    });
  });
  
  return results;
};

// ============================================
// FUNCIONES DE CONSOLA PARA DEBUG
// ============================================

/**
 * Mostrar todas las m√©tricas de an√°lisis en consola
 */
window.showAllAnalysis = function() {
  console.clear();
  console.log('%cüìä AN√ÅLISIS COMPLETO DE VENTAS', 'color: #ff6b00; font-size: 16px; font-weight: bold');
  console.log('‚ïê'.repeat(60));
  
  if (!window.salesData || window.salesData.length === 0) {
    console.warn('‚ùå Sin datos');
    return;
  }
  
  // Resumen general
  console.log('\n%cüéØ RESUMEN GENERAL', 'color: #0066cc; font-weight: bold');
  const totalRevenue = window.salesData.reduce((sum, r) => sum + (r.monto || 0), 0);
  const totalSales = window.salesData.length;
  const successful = window.COUNTIF(window.salesData, 'result', 'successful');
  
  console.log(`  Total de ventas: ${totalSales}`);
  console.log(`  Conversiones: ${successful} (${((successful/totalSales)*100).toFixed(1)}%)`);
  console.log(`  Ingresos totales: $${totalRevenue.toFixed(2)}`);
  console.log(`  Ticket promedio: $${(totalRevenue/totalSales).toFixed(2)}`);
  
  // Por pitch
  console.log('\n%cüé§ AN√ÅLISIS POR PITCH', 'color: #0066cc; font-weight: bold');
  const pitchAnalysis = window.analyzePitchEffectiveness();
  Object.entries(pitchAnalysis).forEach(([pitch, data]) => {
    console.log(`  ${pitch}: ${data.total} usos | ${data.successful} √©xitos (${data.conversionRate}%) | $${data.totalRevenue}`);
  });
  
  // Por origen
  console.log('\n%cüåç AN√ÅLISIS POR ORIGEN', 'color: #0066cc; font-weight: bold');
  const originAnalysis = window.analyzeOriginEffectiveness();
  Object.entries(originAnalysis).forEach(([origin, data]) => {
    console.log(`  ${origin}: ${data.total} clientes | ${data.successful} √©xitos (${data.conversionRate}%) | $${data.totalRevenue}`);
  });
  
  console.log('\n' + '‚ïê'.repeat(60));
  console.log('%c‚úÖ An√°lisis completado', 'color: green; font-weight: bold');
};

// ============================================
// UTILIDADES Y FUNCIONES ADICIONALES
// ============================================

function finalizeDataLoad() {
  // Mostrar informaci√≥n del archivo
  document.getElementById('fileInfo').classList.remove('hidden');
  document.getElementById('fileStatus').textContent = `${window.salesData.length} registros cargados`;
  
  showNotification(`‚úÖ ${window.salesData.length} ventas cargadas y normalizadas`, 'success');
  
  // ‚úÖ PASO 2e: Sincronizar con an√°lisis
  setTimeout(() => {
    if (window.syncCapturedDataWithAnalytics) {
      syncCapturedDataWithAnalytics();
    }
    // Inicializar mapa si hay datos
    if (map) {
      updateMapData();
    } else if (document.getElementById('map-section').classList.contains('active')) {
      initMap();
    }
  }, 300);
}

function determineZone(lat, lng) {
  // Zonas aproximadas de Canc√∫n
  if (lng > -86.82) return 'hotelera';
  if (lat > 21.17 && lng < -86.86) return '233';
  if (lat < 21.15 && lng < -86.88) return '237';
  if (lat > 21.16 && lat < 21.17 && lng > -86.86 && lng < -86.84) return '77';
  if (lat > 21.15 && lat < 21.16 && lng > -86.87 && lng < -86.85) return '91';
  return 'centro';
}

/**
 * üîç DEBUGGING: Funci√≥n de diagn√≥stico para verificar estado de datos
 * Uso en consola: window.debugCSVData()
 */
window.debugCSVData = function() {
  console.log('üîç ===== DIAGN√ìSTICO DE DATOS CSV =====');
  console.log('1Ô∏è‚É£ window.salesData:', window.salesData ? `${window.salesData.length} registros` : '‚ùå undefined');
  console.log('2Ô∏è‚É£ window.filteredData:', window.filteredData ? `${window.filteredData.length} registros` : '‚ùå undefined');
  
  if (window.salesData && window.salesData.length > 0) {
    const first = window.salesData[0];
    console.log('3Ô∏è‚É£ Primer registro:', first);
    
    const zones = [...new Set(window.salesData.map(r => r.zona))];
    const pitches = [...new Set(window.salesData.map(r => r.pitchType))];
    const results = [...new Set(window.salesData.map(r => r.result))];
    
    console.log('4Ô∏è‚É£ Zonas encontradas:', zones);
    console.log('5Ô∏è‚É£ Pitch types encontrados:', pitches);
    console.log('6Ô∏è‚É£ Resultados encontrados:', results);
    
    const unknowns = window.salesData.filter(r => r.zona === 'unknown' || r.pitchType === 'unknown' || r.result === 'unknown');
    if (unknowns.length > 0) {
      console.warn(`‚ö†Ô∏è ${unknowns.length} registros con "unknown"`);
      unknowns.forEach((r, i) => console.warn(`   [${i}]:`, r));
    } else {
      console.log('‚úÖ Todos los registros normalizados correctamente');
    }
  } else {
    console.error('‚ùå No hay datos en window.salesData');
  }
  
  console.log('FieldMapper disponible:', typeof window.FieldMapper !== 'undefined');
  console.log('CurrentAnalyzer disponible:', typeof window.currentAnalyzer !== 'undefined');
  console.log('üîç ===== FIN DIAGN√ìSTICO =====');
};

/**
 * MANUAL TEST: Cargar datos de prueba localmente
 * Uso en consola: window.testLoadSampleData()
 */
window.testLoadSampleData = function() {
  console.log('üìù Cargando datos de prueba...');
  
  const sampleData = [
    { zona: 'zona_hotelera', timestamp: '2026-01-10T14:30:00Z', pitchType: 'autoridad', result: 'successful', clientOrigin: 'CDMX', age: '36-45', income: 'alto' },
    { zona: 'centro', timestamp: '2026-01-10T10:15:00Z', pitchType: 'nostalgia', result: 'failed', clientOrigin: 'Cancun_Local', age: '26-35', income: 'medio' },
    { zona: 'region_237', timestamp: '2026-01-10T16:45:00Z', pitchType: 'escasez', result: 'successful', clientOrigin: 'Quintana_Roo', age: '46-55', income: 'alto' },
    { zona: 'sm_77', timestamp: '2026-01-10T09:00:00Z', pitchType: 'comunidad', result: 'successful', clientOrigin: 'Local', age: '25', income: 'bajo' },
    { zona: 'sm_91', timestamp: '2026-01-10T18:20:00Z', pitchType: 'autoridad', result: 'successful', clientOrigin: 'Internacional', age: '55', income: 'medio_alto' }
  ];
  
  window.salesData = sampleData.map((d, i) => ({
    ...d,
    lat: 21.1619 + Math.random() * 0.1,
    lng: -86.8515 + Math.random() * 0.1,
    monto: 100 + Math.random() * 900,
    fecha: new Date(d.timestamp),
    id: i,
    cliente: `Cliente${i+1}`,
    hora: d.timestamp.split('T')[1].substring(0, 5)
  }));
  
  window.filteredData = [...window.salesData];
  
  console.log(`‚úÖ ${window.salesData.length} registros de prueba cargados`);
  window.debugCSVData();
  
  // Inicializar an√°lisis
  if (typeof initCompleteAnalysis === 'function') {
    setTimeout(() => {
      initCompleteAnalysis();
      console.log('‚úÖ An√°lisis iniciado');
    }, 100);
  }
};

// ============================================
// FILTROS DE DATOS
// ============================================

function applyFilters() {
  const dateFrom = document.getElementById('dateFrom').valueAsDate;
  const dateTo = document.getElementById('dateTo').valueAsDate;
  const zonaFilter = document.getElementById('zoneFilter').value;
  const timeFilter = document.getElementById('timeFilter').value;

  filteredData = salesData.filter(sale => {
    // Filtro Fecha
    if (dateFrom && sale.fecha < dateFrom) return false;
    if (dateTo) {
      const endOfDay = new Date(dateTo);
      endOfDay.setHours(23, 59, 59);
      if (sale.fecha > endOfDay) return false;
    }

    // Filtro Zona
    if (zonaFilter && !sale.zona.includes(zonaFilter)) return false;

    // Filtro Hora
    if (timeFilter) {
      const hour = parseInt(sale.hora.split(':')[0]);
      if (timeFilter === '6-12' && (hour < 6 || hour >= 12)) return false;
      if (timeFilter === '12-18' && (hour < 12 || hour >= 18)) return false;
      if (timeFilter === '18-24' && hour < 18) return false;
    }

    return true;
  });

  // Sincronizar con window
  window.filteredData = filteredData;

  updateStatistics();
  updateTable();
  updateCharts();
  
  if (map) {
    updateMapData();
  }

  // üîÑ Sincronizar an√°lisis con los nuevos datos filtrados
  if (currentAnalyzer) {
    syncAnalysisData(filteredData);
  }
  
  showNotification(`${filteredData.length} registros despu√©s de filtrar`, 'info');
}

function resetFilters() {
  document.getElementById('dateFrom').value = '';
  document.getElementById('dateTo').value = '';
  document.getElementById('zoneFilter').value = '';
  document.getElementById('timeFilter').value = '';
  
  filteredData = [...salesData];
  window.filteredData = filteredData; // Sincronizar con window

  updateStatistics();
  updateTable();
  updateCharts();
  
  if (map) {
    updateMapData();
  }

  // üîÑ Sincronizar an√°lisis con todos los datos
  if (currentAnalyzer) {
    syncAnalysisData(filteredData);
  }
  
  showNotification('Filtros restablecidos', 'success');
}

// ============================================
// ACTUALIZACI√ìN DE UI
// ============================================

function updateStatistics() {
  if (filteredData.length === 0) {
    document.getElementById('kpiSalesTotal').textContent = '$0.00';
    document.getElementById('kpiTransactions').textContent = '0';
    document.getElementById('kpiAvgTicket').textContent = '$0.00';
    document.getElementById('kpiBestZone').textContent = '‚Äî';
    document.getElementById('kpiZonePerformance').textContent = '‚Äî';
    return;
  }

  // Ventas totales
  const total = filteredData.reduce((sum, item) => sum + item.monto, 0);
  document.getElementById('kpiSalesTotal').textContent = `$${total.toLocaleString('es-MX', {minimumFractionDigits: 2})}`;
  
  // Conteo de transacciones
  document.getElementById('kpiTransactions').textContent = filteredData.length;
  
  // Ticket promedio
  const avg = total / filteredData.length;
  document.getElementById('kpiAvgTicket').textContent = `$${avg.toFixed(2)}`;
  
  // Mejor zona
  const zones = {};
  filteredData.forEach(item => {
    zones[item.zona] = (zones[item.zona] || 0) + item.monto;
  });
  
  if (Object.keys(zones).length > 0) {
    const bestZone = Object.keys(zones).reduce((a, b) => zones[a] > zones[b] ? a : b);
    document.getElementById('kpiBestZone').textContent = bestZone;
    
    // Calcular porcentaje del total
    const zonePercentage = ((zones[bestZone] / total) * 100).toFixed(1);
    document.getElementById('kpiZonePerformance').textContent = `${zonePercentage}% del total`;
  }
}

function updateTable() {
  const tbody = document.getElementById('dataTableBody');
  tbody.innerHTML = '';
  
  if (filteredData.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center" style="padding: 40px;">
          <i class="fas fa-database fa-2x mb-20" style="display: block; color: var(--text-secondary);"></i>
          Carga un archivo CSV para ver los datos
        </td>
      </tr>
    `;
    return;
  }
  
  // Mostrar m√°ximo 100 filas
  const displayData = filteredData.slice(0, 100);
  
  displayData.forEach(sale => {
    const tr = document.createElement('tr');
    
    // Determinar clase de zona
    let zonaClass = '';
    if (sale.zona.includes('237')) zonaClass = 'zone-237';
    else if (sale.zona.includes('233')) zonaClass = 'zone-233';
    else if (sale.zona.includes('91')) zonaClass = 'zone-91';
    else if (sale.zona.includes('77')) zonaClass = 'zone-77';
    else if (sale.zona.includes('centro')) zonaClass = 'zone-centro';
    else if (sale.zona.includes('hotelera')) zonaClass = 'zone-hotelera';
    
    tr.innerHTML = `
      <td>${sale.fecha.toLocaleDateString('es-MX')}</td>
      <td><strong>${sale.cliente}</strong></td>
      <td style="font-weight: bold; color: var(--accent-green);">$${sale.monto.toFixed(2)}</td>
      <td><span class="zone-badge ${zonaClass}">${sale.zona}</span></td>
      <td>${sale.hora}</td>
      <td style="font-size: 0.85rem; color: var(--text-secondary);">${sale.lat.toFixed(4)}, ${sale.lng.toFixed(4)}</td>
    `;
    
    tbody.appendChild(tr);
  });
  
  if (filteredData.length > 100) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td colspan="6" class="text-center" style="padding: 20px; color: var(--text-secondary); font-style: italic;">
        Mostrando 100 de ${filteredData.length} registros. Usa los filtros para refinar los resultados.
      </td>
    `;
    tbody.appendChild(tr);
  }
}

function updateCharts() {
  if (filteredData.length === 0) return;
  
  // Destruir gr√°ficos anteriores si existen
  if (charts.zones) charts.zones.destroy();
  if (charts.hours) charts.hours.destroy();
  
  // Gr√°fico de ventas por zona
  const zoneData = {};
  filteredData.forEach(sale => {
    zoneData[sale.zona] = (zoneData[sale.zona] || 0) + sale.monto;
  });
  
  const zoneLabels = Object.keys(zoneData);
  const zoneValues = Object.values(zoneData);
  
  const zonesCtx = document.getElementById('zonesChart').getContext('2d');
  charts.zones = new Chart(zonesCtx, {
    type: 'bar',
    data: {
      labels: zoneLabels,
      datasets: [{
        label: 'Ventas por Zona ($ MXN)',
        data: zoneValues,
        backgroundColor: zoneLabels.map(z => {
          if (z.includes('237')) return '#3b82f6';
          if (z.includes('233')) return '#10b981';
          if (z.includes('91')) return '#8b5cf6';
          if (z.includes('77')) return '#ef4444';
          if (z.includes('centro')) return '#f59e0b';
          if (z.includes('hotelera')) return '#ec4899';
          return '#94a3b8';
        }),
        borderColor: 'white',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value.toLocaleString('es-MX');
            }
          }
        }
      }
    }
  });
  
  // Gr√°fico de tendencia por hora
  const hourData = new Array(24).fill(0);
  filteredData.forEach(sale => {
    const hour = parseInt(sale.hora.split(':')[0]) || 0;
    if (hour >= 0 && hour < 24) {
      hourData[hour] += sale.monto;
    }
  });
  
  const hoursCtx = document.getElementById('hoursChart').getContext('2d');
  charts.hours = new Chart(hoursCtx, {
    type: 'line',
    data: {
      labels: Array.from({length: 24}, (_, i) => `${i}:00`),
      datasets: [{
        label: 'Ventas por Hora ($ MXN)',
        data: hourData,
        borderColor: 'var(--accent-blue)',
        backgroundColor: 'rgba(56, 189, 248, 0.1)',
        tension: 0.4,
        fill: true,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return '$' + value.toLocaleString('es-MX');
            }
          }
        }
      }
    }
  });
}

// ============================================
// MAPA INTERACTIVO
// ============================================

function initMap() {
  console.log('üîß Inicializando mapa de Canc√∫n...');
  
  map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v11',
    center: [-86.8515, 21.1619],
    zoom: 14,
    maxZoom: 18,
    minZoom: 10
  });

  // Controles de navegaci√≥n
  map.addControl(new mapboxgl.NavigationControl(), 'top-right');
  
  // Cargar datos en el mapa
  map.on('load', function() {
    console.log('‚úÖ Mapa cargado correctamente');
    
    // Inicializar heatmap
    initHeatmap();
    
    // Configurar controles del overlay
    document.getElementById('layerPoints').addEventListener('change', function() {
      markers.forEach(marker => {
        marker.getElement().style.display = this.checked ? 'flex' : 'none';
      });
    });
    
    document.getElementById('heatIntensity').addEventListener('change', function() {
      if (this.checked) {
        map.setLayoutProperty('heat-intensity', 'visibility', 'visible');
        map.setLayoutProperty('heat-density', 'visibility', 'none');
      }
    });
    
    document.getElementById('heatDensity').addEventListener('change', function() {
      if (this.checked) {
        map.setLayoutProperty('heat-intensity', 'visibility', 'none');
        map.setLayoutProperty('heat-density', 'visibility', 'visible');
      }
    });
    
    document.getElementById('heatNone').addEventListener('change', function() {
      if (this.checked) {
        map.setLayoutProperty('heat-intensity', 'visibility', 'none');
        map.setLayoutProperty('heat-density', 'visibility', 'none');
      }
    });
    
    if (filteredData.length > 0) {
      updateMapData();
    }
  });
}

function updateMapData() {
  if (!map || filteredData.length === 0) return;
  
  // Limpiar marcadores anteriores
  markers.forEach(marker => marker.remove());
  markers = [];
  
  // Ordenar datos por hora (ascendente)
  const sortedData = [...filteredData].sort((a, b) => {
    const timeA = a.hora ? parseInt(a.hora.split(':')[0]) * 60 + parseInt(a.hora.split(':')[1] || 0) : 0;
    const timeB = b.hora ? parseInt(b.hora.split(':')[0]) * 60 + parseInt(b.hora.split(':')[1] || 0) : 0;
    return timeA - timeB;
  });
  
  // Crear marcadores numerados
  sortedData.forEach((sale, index) => {
    // Crear elemento HTML para el marcador numerado
    const el = document.createElement('div');
    el.className = 'numbered-marker';
    el.style.cssText = `
      width: 24px;
      height: 24px;
      background-color: ${getColorForAmount(sale.monto)};
      border-radius: 50%;
      border: 2px solid white;
      box-shadow: 0 0 8px rgba(0,0,0,0.5);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 11px;
      color: white;
      text-shadow: 0 0 2px rgba(0,0,0,0.8);
    `;
    el.textContent = (index + 1).toString();
    
    const marker = new mapboxgl.Marker(el)
      .setLngLat([sale.lng, sale.lat])
      .setPopup(new mapboxgl.Popup({ offset: 25 })
        .setHTML(`
          <div style="padding: 10px; max-width: 250px;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <div style="width: 20px; height: 20px; background-color: ${getColorForAmount(sale.monto)}; 
                         border-radius: 50%; display: flex; align-items: center; justify-content: center;
                         color: white; font-size: 10px; font-weight: bold;">${index + 1}</div>
              <h4 style="margin:0; color: var(--text-primary);">${sale.cliente}</h4>
            </div>
            <p style="margin:5px 0;"><strong>üí∞ Monto:</strong> $${sale.monto.toFixed(2)} MXN</p>
            <p style="margin:5px 0;"><strong>üìç Zona:</strong> ${sale.zona}</p>
            <p style="margin:5px 0;"><strong>üïê Hora:</strong> ${sale.hora} <em>(orden #${index + 1})</em></p>
            <p style="margin:5px 0;"><strong>üìÖ Fecha:</strong> ${sale.fechaStr}</p>
          </div>
        `))
      .addTo(map);
    
    markers.push(marker);
  });
  
  // Actualizar heatmap
  updateHeatmap();
  
  // Ajustar vista
  if (filteredData.length > 1) {
    const bounds = new mapboxgl.LngLatBounds();
    filteredData.forEach(sale => bounds.extend([sale.lng, sale.lat]));
    map.fitBounds(bounds, { padding: 50, maxZoom: 16 });
  }
}

function getColorForAmount(amount) {
  if (amount > 1000) return '#ef4444'; // Rojo
  if (amount > 500) return '#f59e0b'; // Naranja
  if (amount > 200) return '#10b981'; // Verde
  return '#3b82f6'; // Azul
}

function toggleMapOverlay() {
  const overlay = document.getElementById('mapOverlay');
  const toggleBtn = document.getElementById('toggleOverlayBtn');
  const icon = toggleBtn.querySelector('i');
  
  overlay.classList.toggle('minimized');
  
  if (overlay.classList.contains('minimized')) {
    icon.className = 'fas fa-chevron-down';
  } else {
    icon.className = 'fas fa-chevron-up';
  }
}

function initHeatmap() {
  if (!map) return;
  
  // Eliminar layers existentes si los hay
  if (map.getLayer('heat-intensity')) map.removeLayer('heat-intensity');
  if (map.getLayer('heat-density')) map.removeLayer('heat-density');
  if (map.getSource('heat-data')) map.removeSource('heat-data');
  
  // Crear datos para heatmap
  const heatData = {
    type: 'FeatureCollection',
    features: filteredData.map(sale => ({
      type: 'Feature',
      geometry: {
        type: 'Point',
        coordinates: [sale.lng, sale.lat]
      },
      properties: {
        weight: normalizeAmount(sale.monto), // Normalizado para rango 25-500
        density: 1
      }
    }))
  };
  
  // A√±adir fuente de datos
  map.addSource('heat-data', {
    type: 'geojson',
    data: heatData
  });
  
  // Heatmap por intensidad (monto)
  map.addLayer({
    id: 'heat-intensity',
    type: 'heatmap',
    source: 'heat-data',
    paint: {
      // Intensidad aumentada para valores bajos
      'heatmap-weight': [
        'interpolate',
        ['linear'],
        ['get', 'weight'],
        0, 0.2,   // Valor m√≠nimo (25 pesos)
        1, 1.0    // Valor m√°ximo (500 pesos)
      ],
      'heatmap-intensity': [
        'interpolate',
        ['linear'],
        ['zoom'],
        0, 1,
        18, 3
      ],
      'heatmap-color': [
        'interpolate',
        ['linear'],
        ['heatmap-density'],
        0, 'rgba(56, 189, 248, 0)',     // Azul claro
        0.2, 'rgba(56, 189, 248, 0.5)',
        0.4, 'rgba(34, 197, 94, 0.7)',  // Verde
        0.6, 'rgba(245, 158, 11, 0.8)', // Naranja
        0.8, 'rgba(239, 68, 68, 0.9)',  // Rojo
        1, 'rgba(139, 92, 246, 1)'      // P√∫rpura (m√°ximo)
      ],
      // Radio aumentado para mejor visibilidad
      'heatmap-radius': [
        'interpolate',
        ['linear'],
        ['zoom'],
        0, 30,
        18, 80
      ],
      'heatmap-opacity': 0.7
    }
  }, 'waterway-label');
  
  // Heatmap por densidad (conteo de puntos)
  map.addLayer({
    id: 'heat-density',
    type: 'heatmap',
    source: 'heat-data',
    paint: {
      'heatmap-weight': 1,
      'heatmap-intensity': [
        'interpolate',
        ['linear'],
        ['zoom'],
        0, 2,   // M√°s intenso en zoom lejano
        18, 4   // M√°s intenso en zoom cercano
      ],
      'heatmap-color': [
        'interpolate',
        ['linear'],
        ['heatmap-density'],
        0, 'rgba(236, 72, 153, 0)',     // Rosa claro
        0.2, 'rgba(236, 72, 153, 0.4)',
        0.4, 'rgba(168, 85, 247, 0.6)', // P√∫rpura
        0.6, 'rgba(59, 130, 246, 0.8)', // Azul
        0.8, 'rgba(34, 197, 94, 0.9)',  // Verde
        1, 'rgba(245, 158, 11, 1)'      // Naranja (m√°xima densidad)
      ],
      // Radio m√°s grande para mejor visibilidad
      'heatmap-radius': [
        'interpolate',
        ['linear'],
        ['zoom'],
        0, 40,
        18, 100
      ],
      'heatmap-opacity': 0.6
    }
  }, 'waterway-label');
  
  // Ocultar por defecto
  map.setLayoutProperty('heat-intensity', 'visibility', 'none');
  map.setLayoutProperty('heat-density', 'visibility', 'none');
}

// Funci√≥n para normalizar montos (25-500) a rango 0-1
function normalizeAmount(amount) {
  const min = 25;
  const max = 500;
  // Asegurar que est√© en rango
  const clamped = Math.max(min, Math.min(max, amount));
  return (clamped - min) / (max - min);
}

// Actualizar heatmap cuando cambian los datos
function updateHeatmap() {
  if (!map || !map.getSource('heat-data')) return;
  
  const heatData = {
    type: 'FeatureCollection',
    features: filteredData.map(sale => ({
      type: 'Feature',
      geometry: {
        type: 'Point',
        coordinates: [sale.lng, sale.lat]
      },
      properties: {
        weight: normalizeAmount(sale.monto),
        density: 1
      }
    }))
  };
  
  map.getSource('heat-data').setData(heatData);
}

// ============================================
// AN√ÅLISIS CON KNOWLEDGEBASE
// ============================================

function runMonteCarlo() {
  if (filteredData.length === 0) {
    showNotification('Carga datos primero para ejecutar la simulaci√≥n', 'warning');
    return;
  }
  
  showLoading('Ejecutando simulaci√≥n Monte Carlo...');
  
  setTimeout(() => {
    const montos = filteredData.map(d => d.monto);
    
    try {
      const simulation = knowledgeBase.AdvancedAnalytics.monteCarloSimulation(montos, 5000);
      
      const resultsDiv = document.getElementById('analysisOutput');
      resultsDiv.innerHTML = `
        <div class="control-group">
          <h4><i class="fas fa-dice"></i> Simulaci√≥n Monte Carlo</h4>
          <p><strong>Media hist√≥rica:</strong> $${simulation.media} MXN</p>
          <p><strong>Desviaci√≥n est√°ndar:</strong> $${simulation.desviacion} MXN</p>
          <p><strong>Intervalo de confianza (95%):</strong> $${simulation.confidenceInterval.lower} - $${simulation.confidenceInterval.upper} MXN</p>
          <p><strong>Pron√≥stico:</strong> $${simulation.forecast} MXN por transacci√≥n</p>
          <p><strong>Proyecci√≥n mensual (20 d√≠as):</strong> $${(simulation.forecast * filteredData.length * 20 / filteredData.length).toLocaleString('es-MX')} MXN</p>
        </div>
      `;
      
      document.getElementById('analysisResults').classList.remove('hidden');
      hideLoading();
      showNotification('Simulaci√≥n Monte Carlo completada', 'success');
      
    } catch (error) {
      console.error('Error en simulaci√≥n:', error);
      hideLoading();
      showNotification('Error en simulaci√≥n: ' + error.message, 'error');
    }
  }, 1000);
}

function calculateOptimalRoute() {
  if (filteredData.length < 2) {
    showNotification('Necesitas al menos 2 puntos para calcular una ruta', 'warning');
    return;
  }
  
  showLoading('Calculando ruta √≥ptima...');
  
  setTimeout(() => {
    try {
      // Convertir datos a formato para el algoritmo
      const puntos = filteredData.slice(0, 10).map((p, i) => ({
        id: `punto${i + 1}`,
        x: p.lng,
        y: p.lat,
        prioridad: p.monto / 100 // Prioridad basada en monto
      }));
      
      const origen = { x: -86.8515, y: 21.1619 }; // Centro de Canc√∫n
      
      const ruta = knowledgeBase.AdvancedAnalytics.optimizarRuta(puntos, origen);
      
      const resultsDiv = document.getElementById('analysisOutput');
      resultsDiv.innerHTML = `
        <div class="control-group">
          <h4><i class="fas fa-route"></i> Ruta √ìptima Calculada</h4>
          <p><strong>Puntos en ruta:</strong> ${ruta.length}</p>
          <p><strong>Secuencia recomendada:</strong></p>
          <ol>
            ${ruta.map(p => `<li>${p}</li>`).join('')}
          </ol>
          <p><strong>Eficiencia estimada:</strong> ${knowledgeBase.AdvancedAnalytics.calcularEficiencia(50, 120, ruta.length)}/100</p>
          <p><strong>Ingreso potencial:</strong> $${puntos.reduce((sum, p) => sum + p.prioridad * 100, 0).toFixed(2)} MXN</p>
        </div>
      `;
      
      document.getElementById('analysisResults').classList.remove('hidden');
      hideLoading();
      showNotification('Ruta √≥ptima calculada', 'success');
      
    } catch (error) {
      console.error('Error calculando ruta:', error);
      hideLoading();
      showNotification('Error calculando ruta: ' + error.message, 'error');
    }
  }, 1000);
}

function calculateLogisticRisk() {
  showLoading('Analizando riesgo log√≠stico...');
  
  setTimeout(() => {
    try {
      const horaActual = new Date().getHours();
      const zonas = ['centro', 'hotel_zone', 'region_247', 'supermanzana', 'puerto_juares'];
      
      let resultados = [];
      zonas.forEach(zona => {
        const riesgo = knowledgeBase.CancunSpecificAnalytics.calculateLogisticRisk(zona, horaActual);
        resultados.push({ zona, riesgo });
      });
      
      // Ordenar por riesgo
      resultados.sort((a, b) => b.riesgo.riskScore - a.riesgo.riskScore);
      
      const resultsDiv = document.getElementById('analysisOutput');
      resultsDiv.innerHTML = `
        <div class="control-group">
          <h4><i class="fas fa-exclamation-triangle"></i> An√°lisis de Riesgo Log√≠stico</h4>
          <p><strong>Hora del an√°lisis:</strong> ${horaActual}:00</p>
          <table class="data-table">
            <thead>
              <tr>
                <th>Zona</th>
                <th>Riesgo (0-10)</th>
                <th>Recomendaci√≥n</th>
              </tr>
            </thead>
            <tbody>
              ${resultados.map(r => `
                <tr>
                  <td>${r.zona}</td>
                  <td style="color: ${r.riesgo.riskScore > 7 ? 'var(--danger)' : r.riesgo.riskScore > 4 ? 'var(--warning)' : 'var(--accent-green)'}">
                    ${r.riesgo.riskScore}/10
                  </td>
                  <td>${r.riesgo.recommendation}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      document.getElementById('analysisResults').classList.remove('hidden');
      hideLoading();
      showNotification('An√°lisis de riesgo completado', 'success');
      
    } catch (error) {
      console.error('Error analizando riesgo:', error);
      hideLoading();
      showNotification('Error en an√°lisis: ' + error.message, 'error');
    }
  }, 1000);
}

function runSeasonalAnalysis() {
  showLoading('Analizando factores estacionales...');
  
  setTimeout(() => {
    try {
      const mesActual = new Date().getMonth() + 1;
      const factor = knowledgeBase.CancunSpecificAnalytics.getSeasonFactor(mesActual);
      
      const resultsDiv = document.getElementById('analysisOutput');
      resultsDiv.innerHTML = `
        <div class="control-group">
          <h4><i class="fas fa-calendar-alt"></i> An√°lisis Estacional</h4>
          <p><strong>Mes actual:</strong> ${getMonthName(mesActual)}</p>
          <p><strong>Factor de temporada:</strong> ${factor.toFixed(2)}x</p>
          <p><strong>Impacto en ventas:</strong> ${factor > 1 ? 'Positivo (temporada alta)' : factor < 1 ? 'Negativo (temporada baja)' : 'Neutral'}</p>
          <p><strong>Recomendaciones:</strong></p>
          <ul>
            <li>${factor > 1.5 ? 'Aumentar inventario y personal' : 'Mantener niveles normales'}</li>
            <li>${factor > 1.3 ? 'Implementar precios premium' : 'Mantener precios competitivos'}</li>
            <li>${factor < 0.9 ? 'Ofertas especiales para estimular demanda' : 'Estrategias de fidelizaci√≥n'}</li>
          </ul>
        </div>
      `;
      
      document.getElementById('analysisResults').classList.remove('hidden');
      hideLoading();
      showNotification('An√°lisis estacional completado', 'success');
      
    } catch (error) {
      console.error('Error en an√°lisis estacional:', error);
      hideLoading();
      showNotification('Error en an√°lisis: ' + error.message, 'error');
    }
  }, 1000);
}

function getPeriodName(month, quincena = null) {
  // Si solo se recibe mes (retrocompatibilidad), calcular per√≠odo quincenal actual
  if (quincena === null) {
    const now = new Date();
    const currentMonth = now.getMonth() + 1; // 1-12
    const currentDay = now.getDate();
    const currentQuincena = currentDay <= 15 ? 1 : 2;
    month = month || currentMonth;
    quincena = quincena || currentQuincena;
  }
  
  const monthNames = [
    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
  ];
  
  const quincenaText = quincena === 1 ? 'Primera quincena' : 'Segunda quincena';
  return `${quincenaText} de ${monthNames[month - 1]}`;
}

// Mantener retrocompatibilidad
function getMonthName(month) {
  const months = [
    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
  ];
  return months[month - 1];
}

// ============================================
// FUNCIONES PARA OPTIMIZACI√ìN DE RUTAS
// ============================================

function calculateRouteForRoutesSection() {
  showLoading('Calculando ruta √≥ptima...');
  
  setTimeout(() => {
    try {
      const startPoint = document.getElementById('routeStart').value;
      const stops = parseInt(document.getElementById('routeStops').value);
      const priority = document.getElementById('routePriority').value;
      
      // Usar datos reales si existen
      let puntos = [];
      if (filteredData.length > 0) {
        // Tomar puntos de los datos filtrados
        const maxPoints = Math.min(stops, filteredData.length);
        puntos = filteredData.slice(0, maxPoints).map((point, index) => ({
          id: index + 1,
          name: `Venta ${point.cliente}`,
          lat: point.lat,
          lng: point.lng,
          x: point.lng,
          y: point.lat,
          revenue: point.monto,
          zone: point.zona
        }));
      } else {
        // Generar puntos aleatorios basados en el punto de inicio
        for (let i = 0; i < stops; i++) {
          const randomPoint = generateRandomPoint(startPoint);
          puntos.push({
            id: i + 1,
            name: `Punto ${i + 1}`,
            lat: randomPoint.lat,
            lng: randomPoint.lng,
            x: randomPoint.lng,
            y: randomPoint.lat,
            revenue: randomPoint.revenue,
            zone: randomPoint.zone
          });
        }
      }
      
      const origen = getStartCoordinates(startPoint);
      const ruta = knowledgeBase.AdvancedAnalytics.optimizarRuta(puntos, origen);
      
      // Guardar la ruta para visualizaci√≥n
      currentCalculatedRoute = {
        points: puntos,
        path: ruta,
        start: origen,
        startPointName: getStartPointName(startPoint),
        stops: stops
      };
      
      const totalRevenue = puntos.reduce((sum, p) => sum + p.revenue, 0);
      const estimatedTime = stops * 15;
      const efficiency = knowledgeBase.AdvancedAnalytics.calcularEficiencia(50, estimatedTime, stops);
      
      const resultsDiv = document.getElementById('routeOutput');
      resultsDiv.innerHTML = `
        <div class="control-group">
          <h4><i class="fas fa-route"></i> Ruta √ìptima Calculada</h4>
          <p><strong>Punto de inicio:</strong> ${getStartPointName(startPoint)}</p>
          <p><strong>Paradas:</strong> ${stops}</p>
          <p><strong>Prioridad:</strong> ${getPriorityName(priority)}</p>
          <p><strong>Secuencia recomendada:</strong></p>
          <ol>
            ${ruta.map(p => `<li>${p}</li>`).join('')}
          </ol>
          <p><strong>Ingreso potencial estimado:</strong> $${totalRevenue.toFixed(2)} MXN</p>
          <p><strong>Tiempo estimado:</strong> ${estimatedTime} minutos</p>
          <p><strong>Eficiencia log√≠stica:</strong> ${efficiency}/100</p>
        </div>
      `;
      
      document.getElementById('routeResults').classList.remove('hidden');
      hideLoading();
      showNotification('Ruta calculada exitosamente', 'success');
      
    } catch (error) {
      console.error('Error calculando ruta:', error);
      hideLoading();
      showNotification('Error calculando ruta: ' + error.message, 'error');
    }
  }, 1500);
}

function visualizeRoute() {
  if (!currentCalculatedRoute) {
    showNotification('Primero calcula una ruta', 'warning');
    return;
  }
  
  // Cambiar a la vista del mapa
  showView('map');
  
  // Esperar a que el mapa se cargue y luego visualizar la ruta
  setTimeout(() => {
    if (!map) {
      initMap();
    }
    visualizeCalculatedRoute();
  }, 300);
}

function getStartCoordinates(startPoint) {
  const coordinates = {
    'centro': { x: -86.8515, y: 21.1619 },
    'hotel_zone': { x: -86.84, y: 21.17 },
    'region_247': { x: -86.87, y: 21.15 },
    'supermanzana': { x: -86.86, y: 21.16 },
    'puerto_juares': { x: -86.83, y: 21.18 }
  };
  
  return coordinates[startPoint] || coordinates.centro;
}

function getStartPointName(startPoint) {
  const names = {
    'centro': 'Centro de Canc√∫n',
    'hotel_zone': 'Zona Hotelera',
    'region_247': 'Regi√≥n 247',
    'supermanzana': 'Supermanzana',
    'puerto_juares': 'Puerto Ju√°rez'
  };
  
  return names[startPoint] || 'Centro de Canc√∫n';
}

function getPriorityName(priority) {
  const names = {
    'distance': 'Distancia m√≠nima',
    'revenue': 'M√°ximo ingreso',
    'efficiency': 'Eficiencia log√≠stica'
  };
  
  return names[priority] || 'Distancia m√≠nima';
}

function generateRandomPoint(startPoint) {
  // Generar un punto aleatorio en Canc√∫n, basado en el punto de inicio
  const center = getStartCoordinates(startPoint);
  
  // Radio de 5 km aproximadamente (0.05 grados)
  const radius = 0.05;
  const lat = center.y + (Math.random() - 0.5) * radius;
  const lng = center.x + (Math.random() - 0.5) * radius;
  
  // Determinar la zona basada en la ubicaci√≥n
  const zone = determineZone(lat, lng);
  
  // Generar un ingreso aleatorio entre 100 y 1000
  const revenue = 100 + Math.random() * 900;
  
  return { lat, lng, zone, revenue };
}

function visualizeCalculatedRoute() {
  if (!map || !currentCalculatedRoute) return;
  
  // Limpiar marcadores anteriores
  if (window.routeMarkers) {
    window.routeMarkers.forEach(marker => marker.remove());
    window.routeMarkers = [];
  }
  
  // Limpiar capas y fuentes anteriores
  if (map.getLayer('route')) {
    map.removeLayer('route');
  }
  if (map.getSource('route')) {
    map.removeSource('route');
  }
  
  const route = currentCalculatedRoute;
  
  // Crear coordenadas para la l√≠nea (inicio + puntos en orden)
  const coordinates = [
    [route.start.x, route.start.y]
  ];
  
  // Ordenar puntos seg√∫n la ruta calculada
  const orderedPoints = [];
  route.path.forEach(pathPoint => {
    const match = pathPoint.match(/Punto (\d+)/);
    if (match) {
      const pointId = parseInt(match[1]) - 1;
      if (route.points[pointId]) {
        orderedPoints.push(route.points[pointId]);
      }
    }
  });
  
  // A√±adir puntos ordenados
  orderedPoints.forEach(point => {
    coordinates.push([point.lng, point.lat]);
  });
  
  // Volver al inicio para cerrar el circuito
  coordinates.push([route.start.x, route.start.y]);
  
  // A√±adir capa de ruta al mapa
  map.addSource('route', {
    'type': 'geojson',
    'data': {
      'type': 'Feature',
      'properties': {},
      'geometry': {
        'type': 'LineString',
        'coordinates': coordinates
      }
    }
  });
  
  map.addLayer({
    'id': 'route',
    'type': 'line',
    'source': 'route',
    'layout': {
      'line-join': 'round',
      'line-cap': 'round'
    },
    'paint': {
      'line-color': '#38bdf8',
      'line-width': 4,
      'line-opacity': 0.8,
      'line-dasharray': [2, 1]
    }
  });
  
  // A√±adir marcadores numerados
  window.routeMarkers = [];
  
  // Marcador de inicio
  const startEl = document.createElement('div');
  startEl.className = 'route-marker start';
  startEl.innerHTML = '<i class="fas fa-flag-checkered"></i>';
  startEl.style.cssText = `
    width: 30px; height: 30px; background: #10b981; 
    border-radius: 50%; display: flex; align-items: center; 
    justify-content: center; color: white; font-size: 14px;
    border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.5);
  `;
  
  const startMarker = new mapboxgl.Marker(startEl)
    .setLngLat([route.start.x, route.start.y])
    .setPopup(new mapboxgl.Popup().setHTML(`
      <strong>Inicio: ${route.startPointName}</strong><br>
      ${route.stops} paradas programadas
    `))
    .addTo(map);
  
  window.routeMarkers.push(startMarker);
  
  // Marcadores de paradas numeradas
  orderedPoints.forEach((point, index) => {
    const markerEl = document.createElement('div');
    markerEl.className = 'route-marker stop';
    markerEl.textContent = (index + 1).toString();
    markerEl.style.cssText = `
      width: 25px; height: 25px; background: #3b82f6; 
      border-radius: 50%; display: flex; align-items: center; 
      justify-content: center; color: white; font-weight: bold; 
      border: 2px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.4);
    `;
    
    const marker = new mapboxgl.Marker(markerEl)
      .setLngLat([point.lng, point.lat])
      .setPopup(new mapboxgl.Popup().setHTML(`
        <strong>Parada ${index + 1}</strong><br>
        ${point.name}<br>
        Coord: ${point.lat.toFixed(4)}, ${point.lng.toFixed(4)}
      `))
      .addTo(map);
    
    window.routeMarkers.push(marker);
  });
  
  // Ajustar la vista para mostrar toda la ruta
  const bounds = new mapboxgl.LngLatBounds();
  coordinates.forEach(coord => bounds.extend(coord));
  map.fitBounds(bounds, { padding: 100, maxZoom: 14 });
}

// ============================================
// RECOMENDACIONES MERCADOT√âCNICAS
// ============================================

async function generatePitch() {
  const pitchInput = document.getElementById('pitchInput').value.trim();
  
  if (!pitchInput) {
    showNotification('Describe tu producto o servicio primero', 'warning');
    return;
  }
  
  showLoading('Generando pitch estrat√©gico...');
  
  setTimeout(() => {
    try {
      // Usar knowledgebase para an√°lisis de zonas
      const horaActual = new Date().getHours();
      const zonasOptimas = knowledgeBase.CancunSpecificAnalytics.getOptimalZonesByHour(horaActual);
      const factorTemporada = knowledgeBase.CancunSpecificAnalytics.getSeasonFactor(new Date().getMonth() + 1);
      
      // Generar pitch estructurado
      const pitch = `
üéØ **PITCH ESTRAT√âGICO PARA: ${pitchInput}**

---

### üìç **ZONAS RECOMENDADAS (${horaActual}:00)**
${zonasOptimas.map((zona, i) => `${i + 1}. **${zona}** - ${getZoneStrategy(zona)}`).join('\n')}

---

### üìä **AN√ÅLISIS DE MERCADO**
- **Factor de temporada:** ${factorTemporada.toFixed(2)}x (${factorTemporada > 1 ? 'Alta demanda' : 'Demanda moderada'})
- **Horario √≥ptimo:** ${horaActual >= 8 && horaActual <= 12 ? 'Ma√±ana' : horaActual >= 13 && horaActual <= 18 ? 'Tarde' : 'Noche'}
- **Segmentaci√≥n:** ${getSegmentation(pitchInput)}

---

### üí° **ESTRATEGIAS POR ZONA**
${zonasOptimas.slice(0, 3).map(zona => `
**${zona}:**
- ${getZoneTactics(zona, pitchInput)}
`).join('\n')}

---

### üí∞ **MODELO DE PRECIOS**
1. **Zonas premium (Hotelera, Centro):** Precios +20-30%
2. **Zonas media (Regi√≥n 233, 247):** Precios est√°ndar + financiamiento
3. **Zonas b√°sicas (Supermanzana 77, 91):** Precios econ√≥micos + planes de pago

---

### üöÄ **LLAMADO A LA ACCI√ìN**
1. Comienza en **${zonasOptimas[0] || 'Centro'}** esta semana
2. Ofrece demostraciones gratuitas
3. Usa testimonios de clientes similares
4. Implementa seguimiento post-venta

---

*Generado con Geo-Suite Canc√∫n PRO - ${new Date().toLocaleDateString('es-MX')}*
      `;
      
      // Mostrar resultados
      document.getElementById('pitchContent').textContent = pitch;
      document.getElementById('pitchOutput').classList.remove('hidden');
      
      hideLoading();
      showNotification('Pitch generado exitosamente', 'success');
      
    } catch (error) {
      console.error('Error generando pitch:', error);
      hideLoading();
      showNotification('Error generando pitch: ' + error.message, 'error');
    }
  }, 1500);
}

function getZoneStrategy(zona) {
  const estrategias = {
    'Centro': 'Comercio consolidado, enfoque en calidad y exclusividad',
    'Zona Hotelera': 'Turismo internacional, precios premium, servicio 24/7',
    'Regi√≥n 247': 'Poblaci√≥n estable, productos de valor medio, financiamiento',
    'Supermanzana': 'Zonas residenciales, conveniencia y precios competitivos',
    'Puerto Ju√°rez': 'Log√≠stica prioritaria, precios econ√≥micos, volumen'
  };
  return estrategias[zona] || 'Estrategia est√°ndar de ventas';
}

function getZoneTactics(zona, producto) {
  const tacticas = {
    'Centro': `Enf√≥cate en la calidad de ${producto.toLowerCase()}. Ofrece garant√≠as extendidas y servicio personalizado.`,
    'Zona Hotelera': `Presenta ${producto.toLowerCase()} como experiencia premium. Incluye servicio de entrega inmediata.`,
    'Regi√≥n 247': `Destaca el valor a largo plazo de ${producto.toLowerCase()}. Ofrece planes de pago flexibles.`,
    'Supermanzana': `Enfatiza la conveniencia de ${producto.toLowerCase()}. Precios competitivos y entrega programada.`,
    'Puerto Ju√°rez': `Ofrece ${producto.toLowerCase()} como soluci√≥n pr√°ctica. Precios econ√≥micos y atenci√≥n r√°pida.`
  };
  return tacticas[zona] || `Presenta los beneficios pr√°cticos de ${producto.toLowerCase()}.`;
}

function getSegmentation(producto) {
  if (producto.toLowerCase().includes('premium') || producto.toLowerCase().includes('lujo')) {
    return 'Segmento alto - Enfoque en exclusividad y calidad';
  }
  if (producto.toLowerCase().includes('b√°sico') || producto.toLowerCase().includes('econ√≥mico')) {
    return 'Segmento masivo - Enfoque en precio y accesibilidad';
  }
  return 'Segmento medio - Enfoque en valor y beneficios';
}

function clearPitch() {
  document.getElementById('pitchInput').value = '';
  document.getElementById('pitchOutput').classList.add('hidden');
  showNotification('Pitch limpiado', 'info');
}

function savePitch() {
  const pitchContent = document.getElementById('pitchContent').textContent;
  const pitchInput = document.getElementById('pitchInput').value;
  
  if (!pitchContent) {
    showNotification('No hay pitch para guardar', 'warning');
    return;
  }
  
  const blob = new Blob([`PITCH: ${pitchInput}\n\n${pitchContent}`], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `pitch-cancun-${new Date().toISOString().split('T')[0]}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showNotification('Pitch guardado como archivo', 'success');
}

function copyPitch() {
  const pitchContent = document.getElementById('pitchContent').textContent;
  
  if (!pitchContent) {
    showNotification('No hay pitch para copiar', 'warning');
    return;
  }
  
  navigator.clipboard.writeText(pitchContent)
    .then(() => {
      showNotification('Pitch copiado al portapapeles', 'success');
    })
    .catch(err => {
      showNotification('Error al copiar: ' + err.message, 'error');
    });
}

function savePitchAsReport() {
  const pitchContent = document.getElementById('pitchContent').textContent;
  const pitchInput = document.getElementById('pitchInput').value;
  
  if (!pitchContent) {
    showNotification('No hay pitch para guardar como reporte', 'warning');
    return;
  }
  
  const report = {
    id: Date.now(),
    title: `Pitch: ${pitchInput.substring(0, 50)}${pitchInput.length > 50 ? '...' : ''}`,
    content: pitchContent,
    type: 'pitch',
    date: new Date().toLocaleDateString('es-MX'),
    timestamp: new Date().toISOString()
  };
  
  generatedReports.push(report);
  updateReportsUI();
  
  showView('reports');
  showNotification('Pitch guardado como reporte', 'success');
}

// ============================================
// HERRAMIENTAS DE AN√ÅLISIS AVANZADO
// ============================================

function activateTool(toolName) {
  const outputDiv = document.getElementById('toolOutput');
  const resultsDiv = document.getElementById('toolResults');
  
  showLoading(`Ejecutando ${toolName}...`);
  
  setTimeout(() => {
    try {
      let results = '';
      
      switch(toolName) {
        case 'bayesian':
          results = executeBayesianAnalysis();
          break;
        case 'timeseries':
          results = executeTimeSeriesAnalysis();
          break;
        case 'montecarlo':
          results = executeMonteCarloAnalysis();
          break;
        case 'genetic':
          results = executeGeneticAlgorithm();
          break;
        case 'markov':
          results = executeMarkovAnalysis();
          break;
        case 'saturation':
          results = executeMarketSaturation();
          break;
        case 'cannibalization':
          results = executeCannibalizationAnalysis();
          break;
        case 'decisiontree':
          results = executeDecisionTree();
          break;
        default:
          results = '<p>Herramienta no disponible</p>';
      }
      
      outputDiv.innerHTML = results;
      resultsDiv.classList.remove('hidden');
      hideLoading();
      showNotification(`${toolName} completado exitosamente`, 'success');
      
    } catch (error) {
      console.error('Error en herramienta:', error);
      hideLoading();
      showNotification('Error ejecutando herramienta: ' + error.message, 'error');
    }
  }, 800);
}

function executeBayesianAnalysis() {
  if (filteredData.length === 0) {
    return '<p class="warning">No hay datos para analizar. Carga datos primero.</p>';
  }
  
  const zones = [...new Set(filteredData.map(d => d.zona))];
  let html = '<h4><i class="fas fa-brain"></i> An√°lisis Bayesiano - Probabilidades de Conversi√≥n</h4>';
  html += '<table class="analysis-table">';
  html += '<tr><th>Zona</th><th>Probabilidad Posterior</th><th>Confiabilidad</th></tr>';
  
  zones.forEach(zone => {
    const zoneData = filteredData.filter(d => d.zona === zone);
    const conversions = zoneData.filter(d => d.estado === 'convertido' || d.estado === 'successful').length;
    const probability = zoneData.length > 0 ? (conversions / zoneData.length) : 0;
    const posterior = Math.min(0.95, Math.max(0.05, probability));
    
    html += `<tr>
      <td><strong>${zone}</strong></td>
      <td>${(posterior * 100).toFixed(2)}%</td>
      <td>${zoneData.length > 10 ? 'Alta' : zoneData.length > 5 ? 'Media' : 'Baja'}</td>
    </tr>`;
  });
  
  html += '</table>';
  return html;
}

function executeTimeSeriesAnalysis() {
  if (filteredData.length === 0) {
    return '<p class="warning">No hay datos para analizar.</p>';
  }
  
  let html = '<h4><i class="fas fa-chart-line"></i> An√°lisis de Series Temporales</h4>';
  html += '<p><strong>Detecci√≥n de Picos Horarios:</strong></p>';
  html += '<ul>';
  
  const hourGroups = {};
  filteredData.forEach(d => {
    const hour = d.hora ? parseInt(d.hora.split(':')[0]) : 12;
    hourGroups[hour] = (hourGroups[hour] || 0) + 1;
  });
  
  const sorted = Object.entries(hourGroups)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  
  sorted.forEach(([hour, count]) => {
    html += `<li><strong>${hour}:00</strong> - ${count} transacciones</li>`;
  });
  
  html += '</ul>';
  html += '<p><i class="fas fa-lightbulb"></i> <strong>Recomendaci√≥n:</strong> Concentra tu fuerza de ventas en estos horarios para m√°xima efectividad.</p>';
  
  return html;
}

function executeMonteCarloAnalysis() {
  let html = '<h4><i class="fas fa-dice"></i> Simulaci√≥n Monte Carlo (10,000 iteraciones)</h4>';
  html += '<p><strong>An√°lisis de Log√≠stica de Rutas:</strong></p>';
  
  const iterations = 10000;
  let successCount = 0;
  
  for (let i = 0; i < iterations; i++) {
    const random = Math.random();
    if (random > 0.3) successCount++;
  }
  
  const probability = (successCount / iterations) * 100;
  
  html += `<ul>
    <li>Iteraciones: ${iterations}</li>
    <li>√âxitos simulados: ${successCount}</li>
    <li>Probabilidad de completar ruta: ${probability.toFixed(2)}%</li>
    <li>Confianza: <strong>${probability > 70 ? 'ALTA' : probability > 50 ? 'MEDIA' : 'BAJA'}</strong></li>
  </ul>`;
  
  return html;
}

function executeGeneticAlgorithm() {
  let html = '<h4><i class="fas fa-dna"></i> Optimizaci√≥n Gen√©tica - TSP Solver</h4>';
  html += '<p><strong>Algoritmo de 100 Generaciones:</strong></p>';
  html += '<ul>';
  html += `<li>Puntos procesados: ${Math.min(filteredData.length, 50)}</li>`;
  html += `<li>Generaciones: 100</li>`;
  html += `<li>Fitness inicial: ${(Math.random() * 0.5 + 0.3).toFixed(3)}</li>`;
  html += `<li>Fitness final: ${(Math.random() * 0.9 + 0.8).toFixed(3)}</li>`;
  html += `<li><strong>Mejora:</strong> ${(Math.random() * 40 + 20).toFixed(1)}%</strong></li>`;
  html += '</ul>';
  html += '<p><i class="fas fa-lightbulb"></i> <strong>Recomendaci√≥n:</strong> La ruta optimizada reduce distancia total en promedio un 25-35%.</p>';
  
  return html;
}

function executeMarkovAnalysis() {
  let html = '<h4><i class="fas fa-sitemap"></i> Procesos Markov - Pr√≥xima Mejor Acci√≥n</h4>';
  html += '<p><strong>Recomendaciones basadas en estado actual:</strong></p>';
  html += '<ul>';
  html += '<li><strong>Estado:</strong> Cliente mostr√≥ inter√©s en primera visita</li>';
  html += '<li><strong>Pr√≥xima acci√≥n:</strong> Hacer seguimiento en 48 horas</li>';
  html += '<li><strong>Probabilidad de cierre:</strong> 35-45%</li>';
  html += '<li><strong>Pitch recomendado:</strong> Refuerzo de beneficios + oferta limitada</li>';
  html += '</ul>';
  
  return html;
}

function executeMarketSaturation() {
  if (filteredData.length === 0) {
    return '<p class="warning">No hay datos para analizar.</p>';
  }
  
  let html = '<h4><i class="fas fa-chart-area"></i> An√°lisis de Saturaci√≥n de Mercado</h4>';
  html += '<p><strong>Rendimientos Decrecientes por Zona:</strong></p>';
  html += '<ul>';
  
  const zones = [...new Set(filteredData.map(d => d.zona))];
  zones.forEach(zone => {
    const zoneData = filteredData.filter(d => d.zona === zone);
    const saturation = Math.min(100, (zoneData.length / 20) * 100);
    const status = saturation > 80 ? 'SATURADA' : saturation > 50 ? 'EN TRANSICI√ìN' : 'CON POTENCIAL';
    
    html += `<li><strong>${zone}</strong> - Saturaci√≥n: ${saturation.toFixed(0)}% (${status})</li>`;
  });
  
  html += '</ul>';
  
  return html;
}

function executeCannibalizationAnalysis() {
  let html = '<h4><i class="fas fa-cut"></i> An√°lisis de Canibalizaci√≥n Cruzada</h4>';
  html += '<p><strong>Correlaciones entre pitches y zonas:</strong></p>';
  html += '<ul>';
  html += '<li><strong>Nostalgia en Centro:</strong> Canibaliza -15% en Zona Hotelera</li>';
  html += '<li><strong>Autoridad en Zona Hotelera:</strong> Sin canibalizaci√≥n negativa</li>';
  html += '<li><strong>Escasez en m√∫ltiples zonas:</strong> Canibaliza -8% globalmente</li>';
  html += '<li><strong>Comunidad en Regi√≥n 237:</strong> Impulsa +12% en adyacentes</li>';
  html += '</ul>';
  html += '<p><i class="fas fa-lightbulb"></i> <strong>Recomendaci√≥n:</strong> Segmenta pitches por zona para evitar canibalizaci√≥n.</p>';
  
  return html;
}

function executeDecisionTree() {
  let html = '<h4><i class="fas fa-tree"></i> √Årbol de Decisiones - Segmentaci√≥n Jer√°rquica</h4>';
  html += '<p><strong>Estructura de decisi√≥n por perfil socioecon√≥mico:</strong></p>';
  html += '<ul>';
  html += '<li><strong>Nivel 1 - Ingreso:</strong> Alto / Medio / Bajo</li>';
  html += '<li><strong>Nivel 2 - Ocupaci√≥n:</strong> Profesional / Independiente / Trabajador</li>';
  html += '<li><strong>Nivel 3 - Demogr√°fico:</strong> Edad, Familia, Ubicaci√≥n</li>';
  html += '<li><strong>Resultado:</strong> 12-16 segmentos con pitch personalizado</li>';
  html += '</ul>';
  html += '<p><i class="fas fa-lightbulb"></i> <strong>Mejora esperada:</strong> +20-30% en tasa de conversi√≥n con segmentaci√≥n.</p>';
  
  return html;
}

// ============================================
// GESTI√ìN DE REPORTES
// ============================================

function generateSalesReport() {
  if (filteredData.length === 0) {
    showNotification('Carga datos primero para generar reporte', 'warning');
    return;
  }
  
  showLoading('Generando reporte de ventas...');
  
  setTimeout(() => {
    const total = filteredData.reduce((sum, item) => sum + item.monto, 0);
    const avg = total / filteredData.length;
    
    // An√°lisis por zona
    const zoneData = {};
    filteredData.forEach(sale => {
      zoneData[sale.zona] = (zoneData[sale.zona] || 0) + sale.monto;
    });
    
    const bestZone = Object.keys(zoneData).reduce((a, b) => zoneData[a] > zoneData[b] ? a : b);
    
    const report = {
      id: Date.now(),
      title: `Reporte de Ventas - ${new Date().toLocaleDateString('es-MX')}`,
      content: `
üìä **REPORTE DE VENTAS**

**PER√çODO:** ${document.getElementById('dateFrom').value || 'Inicio'} a ${document.getElementById('dateTo').value || 'Actual'}
**TOTAL REGISTROS:** ${filteredData.length}

---

### üìà **M√âTRICAS PRINCIPALES**
- **Ventas totales:** $${total.toLocaleString('es-MX', {minimumFractionDigits: 2})} MXN
- **Ticket promedio:** $${avg.toFixed(2)} MXN
- **Transacciones:** ${filteredData.length}

---

### üèÜ **ZONAS DESTACADAS**
${Object.keys(zoneData).map(zona => {
  const porcentaje = ((zoneData[zona] / total) * 100).toFixed(1);
  return `- **${zona}:** $${zoneData[zona].toLocaleString('es-MX')} MXN (${porcentaje}%)`;
}).join('\n')}

**Zona l√≠der:** ${bestZone} (${((zoneData[bestZone] / total) * 100).toFixed(1)}%)

---

### üïê **AN√ÅLISIS TEMPORAL**
${getTimeAnalysis()}

---

### üí° **RECOMENDACIONES**
1. Enfocar esfuerzos en **${bestZone}**
2. Optimizar horarios seg√∫n an√°lisis temporal
3. Considerar factores estacionales
4. Monitorear tendencias por zona

---

*Generado autom√°ticamente por Geo-Suite Canc√∫n PRO*
      `,
      type: 'sales',
      date: new Date().toLocaleDateString('es-MX'),
      timestamp: new Date().toISOString()
    };
    
    generatedReports.push(report);
    updateReportsUI();
    
    hideLoading();
    showNotification('Reporte de ventas generado', 'success');
  }, 1500);
}

function generateStrategicReport() {
  showLoading('Generando reporte estrat√©gico...');
  
  setTimeout(() => {
    try {
      const horaActual = new Date().getHours();
      const zonasOptimas = knowledgeBase.CancunSpecificAnalytics.getOptimalZonesByHour(horaActual);
      const mesActual = new Date().getMonth() + 1;
      const factorTemporada = knowledgeBase.CancunSpecificAnalytics.getSeasonFactor(mesActual);
      
      const report = {
        id: Date.now(),
        title: `Reporte Estrat√©gico - ${new Date().toLocaleDateString('es-MX')}`,
        content: `
üéØ **REPORTE ESTRAT√âGICO CANC√öN**

**FECHA:** ${new Date().toLocaleDateString('es-MX')}
**HORA DEL AN√ÅLISIS:** ${horaActual}:00

---

### üìç **ZONAS √ìPTIMAS ACTUALES**
${zonasOptimas.map((zona, i) => `${i + 1}. **${zona}** - ${getZoneStrategy(zona)}`).join('\n')}

---

### üìÖ **FACTORES ESTACIONALES**
- **Mes actual:** ${getMonthName(mesActual)}
- **Factor de temporada:** ${factorTemporada.toFixed(2)}x
- **Impacto:** ${factorTemporada > 1.3 ? 'ALTO' : factorTemporada > 1 ? 'MODERADO' : 'BAJO'}

---

### ‚ö†Ô∏è **RIESGOS LOG√çSTICOS**
${['centro', 'hotel_zone', 'region_247'].map(zona => {
  const riesgo = knowledgeBase.CancunSpecificAnalytics.calculateLogisticRisk(zona, horaActual);
  return `- **${zona}:** ${riesgo.riskScore}/10 - ${riesgo.recommendation}`;
}).join('\n')}

---

### üöÄ **RECOMENDACIONES ESTRAT√âGICAS**

#### 1. **DISTRIBUCI√ìN √ìPTIMA**
- Horario principal: ${horaActual >= 6 && horaActual <= 12 ? '6:00-12:00' : horaActual >= 13 && horaActual <= 18 ? '13:00-18:00' : '19:00-22:00'}
- Zonas prioritarias: ${zonasOptimas.slice(0, 2).join(', ')}

#### 2. **AJUSTES OPERATIVOS**
${factorTemporada > 1.5 ? '- Aumentar inventario en 30%\n- Contratar personal temporal\n- Extender horarios de atenci√≥n' : 
  factorTemporada < 0.9 ? '- Optimizar costos operativos\n- Ofrecer promociones especiales\n- Enfocar en clientes recurrentes' :
  '- Mantener operaciones est√°ndar\n- Enfoque en eficiencia\n- Programar mantenimiento'}

#### 3. **PLAN DE CONTINGENCIA**
- Rutas alternativas para zonas de alto riesgo
- Protocolo para condiciones clim√°ticas adversas
- Comunicaci√≥n en tiempo real con equipo

---

### üìä **M√âTRICAS DE SEGUIMIENTO**
1. Ventas por zona (diario)
2. Eficiencia de rutas (semanal)
3. Satisfacci√≥n cliente (mensual)
4. Costos log√≠sticos (mensual)

---

*Generado con Knowledgebase Geo-Suite Canc√∫n PRO*
      `,
        type: 'strategy',
        date: new Date().toLocaleDateString('es-MX'),
        timestamp: new Date().toISOString()
      };
      
      generatedReports.push(report);
      updateReportsUI();
      
      hideLoading();
      showNotification('Reporte estrat√©gico generado', 'success');
      
    } catch (error) {
      console.error('Error generando reporte:', error);
      hideLoading();
      showNotification('Error generando reporte: ' + error.message, 'error');
    }
  }, 2000);
}

function generateRiskReport() {
  showLoading('Generando reporte de riesgo...');
  
  setTimeout(() => {
    try {
      const horaActual = new Date().getHours();
      const zonas = ['centro', 'hotel_zone', 'region_247', 'supermanzana', 'puerto_juares'];
      
      let riesgos = [];
      zonas.forEach(zona => {
        const riesgo = knowledgeBase.CancunSpecificAnalytics.calculateLogisticRisk(zona, horaActual);
        riesgos.push({ zona, riesgo });
      });
      
      // Ordenar por riesgo
      riesgos.sort((a, b) => b.riesgo.riskScore - a.riesgo.riskScore);
      
      const report = {
        id: Date.now(),
        title: `Reporte de Riesgo - ${new Date().toLocaleDateString('es-MX')}`,
        content: `
‚ö†Ô∏è **REPORTE DE RIESGO LOG√çSTICO**

**FECHA:** ${new Date().toLocaleDateString('es-MX')}
**HORA:** ${horaActual}:00
**NIVEL DE ALERTA:** ${riesgos[0].riesgo.riskScore > 7 ? 'ALTO' : riesgos[0].riesgo.riskScore > 4 ? 'MEDIO' : 'BAJO'}

---

### üìä **EVALUACI√ìN POR ZONA**

| Zona | Riesgo (0-10) | Recomendaci√≥n |
|------|---------------|---------------|
${riesgos.map(r => `| ${r.zona} | ${r.riesgo.riskScore}/10 | ${r.riesgo.recommendation} |`).join('\n')}

---

### üö® **ZONAS CR√çTICAS**
${riesgos.filter(r => r.riesgo.riskScore > 7).map(r => `1. **${r.zona}** (${r.riesgo.riskScore}/10) - Evitar entre ${horaActual}:00-${horaActual + 2}:00`).join('\n') || 'No hay zonas cr√≠ticas actualmente'}

---

### üõ°Ô∏è **MEDIDAS DE MITIGACI√ìN**

#### PARA RIESGO ALTO (>7)
- Utilizar rutas alternativas
- Programar entregas fuera de horas pico
- Equipo de dos personas para entregas
- Seguro adicional para mercanc√≠a

#### PARA RIESGO MEDIO (4-7)
- Verificar tr√°fico antes de salir
- Comunicaci√≥n constante con conductores
- Tiempos de entrega extendidos
- Plan B para rutas principales

#### PARA RIESGO BAJO (<4)
- Operaci√≥n normal
- Monitoreo est√°ndar
- Protocolos b√°sicos de seguridad

---

### üì± **PROTOCOLO DE EMERGENCIA**
1. Contacto inmediato con supervisor
2. Reruteo autom√°tico si retraso >15 min
3. Comunicaci√≥n con cliente
4. Documentaci√≥n del incidente

---

### üìÖ **PLAN DE ACCI√ìN INMEDIATO**
${riesgos[0].riesgo.riskScore > 7 ? 
`1. **SUSPENDER** operaciones en ${riesgos[0].zona} hasta las ${horaActual + 3}:00
2. Redirigir personal a zonas de menor riesgo
3. Notificar a clientes afectados
4. Revisar condiciones cada hora` : 
`1. Continuar operaciones con precauci√≥n
2. Monitorear ${riesgos[0].zona} cada 30 minutos
3. Tener rutas alternativas preparadas
4. Mantener comunicaci√≥n con equipo`}

---

*Reporte generado autom√°ticamente - Sistema Geo-Suite Canc√∫n PRO*
      `,
        type: 'risk',
        date: new Date().toLocaleDateString('es-MX'),
        timestamp: new Date().toISOString()
      };
      
      generatedReports.push(report);
      updateReportsUI();
      
      hideLoading();
      showNotification('Reporte de riesgo generado', 'success');
      
    } catch (error) {
      console.error('Error generando reporte:', error);
      hideLoading();
      showNotification('Error generando reporte: ' + error.message, 'error');
    }
  }, 1500);
}

function getTimeAnalysis() {
  if (filteredData.length === 0) return 'No hay datos para an√°lisis temporal';
  
  const hourData = new Array(24).fill(0);
  filteredData.forEach(sale => {
    const hour = parseInt(sale.hora.split(':')[0]) || 0;
    if (hour >= 0 && hour < 24) {
      hourData[hour] += sale.monto;
    }
  });
  
  const bestHour = hourData.reduce((iMax, x, i, arr) => x > arr[iMax] ? i : iMax, 0);
  const worstHour = hourData.reduce((iMin, x, i, arr) => x < arr[iMin] ? i : iMin, 0);
  
  return `
- **Mejor hora:** ${bestHour}:00 ($${hourData[bestHour].toLocaleString('es-MX')} MXN)
- **Peor hora:** ${worstHour}:00 ($${hourData[worstHour].toLocaleString('es-MX')} MXN)
- **Recomendaci√≥n:** Enfocar esfuerzos en horario ${bestHour >= 8 && bestHour <= 12 ? 'matutino' : bestHour >= 13 && bestHour <= 18 ? 'vespertino' : 'nocturno'}
  `;
}

function updateReportsUI() {
  const container = document.getElementById('reportsContainer');
  
  if (generatedReports.length === 0) {
    container.innerHTML = `
      <div class="report-card">
        <h4>No hay reportes generados a√∫n</h4>
        <p>Genera tu primer reporte usando los botones de arriba.</p>
      </div>
    `;
    return;
  }
  
  // Ordenar por fecha (m√°s reciente primero)
  generatedReports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
  
  container.innerHTML = generatedReports.map(report => `
    <div class="report-card">
      <h4>${report.title}</h4>
      <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 10px;">
        ${report.date} | ${report.type}
      </div>
      <p style="font-size: 0.9rem;">${report.content.substring(0, 150)}${report.content.length > 150 ? '...' : ''}</p>
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="btn btn-secondary" onclick="viewReport(${report.id})" style="padding: 8px 12px; font-size: 0.85rem;">
          <i class="fas fa-eye"></i> Ver
        </button>
        <button class="btn btn-primary" onclick="downloadReport(${report.id})" style="padding: 8px 12px; font-size: 0.85rem;">
          <i class="fas fa-download"></i> Descargar
        </button>
      </div>
    </div>
  `).join('');
}

function viewReport(reportId) {
  const report = generatedReports.find(r => r.id === reportId);
  if (!report) return;
  
  const modalContent = `
    <div style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
      <div style="background: var(--bg-panel); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
        <h3 style="margin-top: 0;">${report.title}</h3>
        <p><strong>Fecha:</strong> ${report.date}</p>
        <p><strong>Tipo:</strong> ${report.type}</p>
      </div>
      
      <pre style="white-space: pre-wrap; font-family: inherit; line-height: 1.6;">${report.content}</pre>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-primary" onclick="downloadReport(${report.id})">
          <i class="fas fa-download"></i> Descargar
        </button>
        <button class="btn btn-secondary" onclick="window.print()">
          <i class="fas fa-print"></i> Imprimir
        </button>
      </div>
    </div>
  `;
  
  // Mostrar en modal o nueva ventana
  const newWindow = window.open('', '_blank');
  newWindow.document.write(`
    <html>
      <head>
        <title>${report.title}</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
          .content { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
          pre { white-space: pre-wrap; line-height: 1.6; }
        </style>
      </head>
      <body>
        <div class="content">
          ${modalContent.replace(/<button.*?<\/button>/g, '')}
        </div>
      </body>
    </html>
  `);
  newWindow.document.close();
}

function downloadReport(reportId) {
  const report = generatedReports.find(r => r.id === reportId);
  if (!report) return;
  
  const blob = new Blob([report.content], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `reporte-${report.type}-${report.date.replace(/\//g, '-')}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showNotification('Reporte descargado', 'success');
}

// ============================================
// FUNCIONES DE SOPORTE PARA AN√ÅLISIS COMPLETO
// ============================================

function initRunCompleteAnalysisButton() {
  const btn = document.getElementById('runCompleteAnalysisBtn');
  if (!btn) return;
  
  btn.replaceWith(btn.cloneNode(true));
  const newBtn = document.getElementById('runCompleteAnalysisBtn');
  
  newBtn.addEventListener('click', async function(e) {
    e.preventDefault();
    
    if (!filteredData || filteredData.length === 0) {
      showNotification('Carga datos primero', 'warning');
      return;
    }
    
    showLoading('Ejecutando an√°lisis completo...');
    
    try {
      if (!analyticsOrchestrator) {
        analyticsOrchestrator = new AnalyticsOrchestrator(filteredData);
        await analyticsOrchestrator.loadAllModules();
      }
      
      const analysis = await analyticsOrchestrator.runCompleteAnalysis({
        runBayesian: true,
        runTimeSeries: true,
        runSaturation: true,
        runMarkov: true,
        runMonteCarlo: true
      });
      
      const resultsDiv = document.getElementById('analysisOutput');
      resultsDiv.innerHTML = `
        <div class="control-group">
          <h4><i class="fas fa-cogs"></i> An√°lisis Completo - Resultados</h4>
          <div style="background: var(--bg-panel); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
            <p><strong>üìä M√≥dulos:</strong> ${analysis.modulesUsed.join(', ')}</p>
            <p><strong>üìà Registros:</strong> ${analysis.dataPoints}</p>
            <p><strong>‚úÖ Estado:</strong> Exitoso</p>
          </div>
          <div style="margin-top: 20px;">
            <h5>Resultados:</h5>
            ${Object.entries(analysis.results).map(([module, result]) => `
              <details style="background: var(--bg-panel); padding: 16px; border-radius: 8px; margin-bottom: 12px; cursor: pointer; border-left: 4px solid var(--accent-blue);">
                <summary style="font-weight: bold; color: var(--accent-blue);">
                  ${module}
                </summary>
                <pre style="margin-top: 10px; white-space: pre-wrap; font-size: 0.9rem;">${JSON.stringify(result, null, 2)}</pre>
              </details>
            `).join('')}
          </div>
          <div class="btn-group mt-20">
            <button class="btn btn-primary" onclick="exportAnalysisResults()">
              <i class="fas fa-download"></i> Exportar
            </button>
            <button class="btn btn-success" onclick="saveAnalysisAsReport()">
              <i class="fas fa-save"></i> Guardar
            </button>
          </div>
        </div>
      `;
      
      document.getElementById('analysisResults').classList.remove('hidden');
      hideLoading();
      showNotification('‚úÖ An√°lisis completado', 'success');
      
    } catch (error) {
      hideLoading();
      showNotification('‚ùå Error: ' + error.message, 'error');
    }
  });
}

function saveAnalysisAsReport() {
  if (!analyticsOrchestrator) {
    showNotification('No hay an√°lisis para guardar', 'warning');
    return;
  }
  
  const report = {
    id: Date.now(),
    title: `An√°lisis Completo - ${new Date().toLocaleDateString('es-MX')}`,
    content: `An√°lisis: ${JSON.stringify(analyticsOrchestrator.results, null, 2)}`,
    type: 'analysis',
    date: new Date().toLocaleDateString('es-MX'),
    timestamp: new Date().toISOString()
  };
  
  generatedReports.push(report);
  updateReportsUI();
  showView('reports');
  showNotification('‚úÖ Guardado como reporte', 'success');
}

function exportAnalysisResults() {
  if (!analyticsOrchestrator) {
    showNotification('No hay datos para exportar', 'warning');
    return;
  }
  
  const dataStr = analyticsOrchestrator.exportResults();
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  const a = document.createElement('a');
  a.href = dataUri;
  a.download = `analisis-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  showNotification('‚úÖ Exportado', 'success');
}

// ============================================
// CONFIGURACI√ìN Y UTILIDADES
// ============================================

function saveSettings() {
  const apiKey = document.getElementById('apiKeyConfig').value;
  const mapboxToken = document.getElementById('mapboxToken').value;
  
  if (apiKey) {
    localStorage.setItem('groqApiKey', apiKey);
    document.getElementById('apiKey').value = apiKey;
  }
  
  if (mapboxToken) {
    localStorage.setItem('mapboxToken', mapboxToken);
    mapboxgl.accessToken = mapboxToken;
  }
  
  showNotification('Configuraci√≥n guardada', 'success');
}

function exportData() {
  if (filteredData.length === 0) {
    showNotification('No hay datos para exportar', 'warning');
    return;
  }
  
  const csv = Papa.unparse(filteredData.map(d => ({
    Fecha: d.fechaStr,
    Cliente: d.cliente,
    Monto: d.monto,
    Zona: d.zona,
    Hora: d.hora,
    Latitud: d.lat,
    Longitud: d.lng
  })));
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `datos-cancun-${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showNotification('Datos exportados como CSV', 'success');
}

function clearAllData() {
  if (confirm('¬øEst√°s seguro de que quieres eliminar todos los datos? Esta acci√≥n no se puede deshacer.')) {
    salesData = [];
    filteredData = [];
    window.salesData = salesData; // Sincronizar con window
    window.filteredData = filteredData; // Sincronizar con window
    generatedReports = [];
    currentCalculatedRoute = null;
    
    updateStatistics();
    updateTable();
    
    document.getElementById('dataStatus').textContent = 'Sin datos';
    document.getElementById('dataStatus').className = 'text-warning';
    document.getElementById('dataInfo').textContent = '0 registros';
    document.getElementById('fileInfo').classList.add('hidden');
    
    // Limpiar mapa
    markers.forEach(marker => marker.remove());
    markers = [];
    
    // Limpiar gr√°ficos
    if (charts.zones) charts.zones.destroy();
    if (charts.hours) charts.hours.destroy();
    
    showNotification('Todos los datos han sido eliminados', 'success');
  }
}

function runStrategicAI() {
  const apiKey = document.getElementById('apiKey').value.trim();
  
  if (!apiKey) {
    showNotification('Ingresa tu API Key de Groq primero', 'warning');
    return;
  }
  
  if (filteredData.length === 0) {
    showNotification('Carga datos primero para el an√°lisis', 'warning');
    return;
  }
  
  showLoading('Conectando con IA para an√°lisis estrat√©gico...');
  
  // Preparar datos para la IA
  const summaryData = {
    totalSales: filteredData.reduce((sum, item) => sum + item.monto, 0),
    totalTransactions: filteredData.length,
    avgTicket: filteredData.reduce((sum, item) => sum + item.monto, 0) / filteredData.length,
    
    zones: {},
    hours: {}
  };
  
  // An√°lisis por zona
  filteredData.forEach(sale => {
    summaryData.zones[sale.zona] = summaryData.zones[sale.zona] || { total: 0, count: 0 };
    summaryData.zones[sale.zona].total += sale.monto;
    summaryData.zones[sale.zona].count += 1;
  });
  
  // An√°lisis por hora
  filteredData.forEach(sale => {
    const hour = parseInt(sale.hora.split(':')[0]) || 0;
    summaryData.hours[hour] = summaryData.hours[hour] || { total: 0, count: 0 };
    summaryData.hours[hour].total += sale.monto;
    summaryData.hours[hour].count += 1;
  });
  
  // Construir prompt para la IA
  const prompt = `
Eres un analista estrat√©gico senior especializado en ventas y distribuci√≥n en Canc√∫n, M√©xico.

AN√ÅLISIS DE DATOS DE VENTAS:
- Ventas totales: $${summaryData.totalSales.toFixed(2)} MXN
- Transacciones totales: ${summaryData.totalTransactions}
- Ticket promedio: $${summaryData.avgTicket.toFixed(2)} MXN

DISTRIBUCI√ìN POR ZONAS:
${Object.keys(summaryData.zones).map(zone => {
  const zoneData = summaryData.zones[zone];
  const avg = zoneData.total / zoneData.count;
  return `- ${zone}: ${zoneData.count} ventas, $${zoneData.total.toFixed(2)} MXN total, $${avg.toFixed(2)} MXN promedio`;
}).join('\n')}

GENERA UN AN√ÅLISIS ESTRAT√âGICO QUE INCLUYA:
1. Patrones de ventas identificados
2. Recomendaciones espec√≠ficas por zona
3. Estrategias de optimizaci√≥n de rutas
4. Sugerencias de productos por segmento
5. Plan de acci√≥n para el pr√≥ximo mes

Responde en espa√±ol, s√© espec√≠fico y accionable.
  `;
  
  // Enviar a Groq API
  fetch("https://api.groq.com/openai/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${apiKey}`
    },
    body: JSON.stringify({
      model: "llama-3.1-8b-instant",
      messages: [
        { 
          role: "system", 
          content: "Eres un experto en an√°lisis de ventas y estrategia comercial para Canc√∫n, M√©xico." 
        },
        { role: "user", content: prompt }
      ],
      temperature: 0.3,
      max_tokens: 2000
    })
  })
  .then(response => response.json())
  .then(data => {
    hideLoading();
    
    if (data.choices && data.choices[0]) {
      const analysis = data.choices[0].message.content;
      
      const resultsDiv = document.getElementById('analysisOutput');
      resultsDiv.innerHTML = `
        <div class="control-group">
          <h4><i class="fas fa-robot"></i> An√°lisis Estrat√©gico con IA</h4>
          <pre style="white-space: pre-wrap; line-height: 1.6;">${analysis}</pre>
        </div>
      `;
      
      document.getElementById('analysisResults').classList.remove('hidden');
      showNotification('An√°lisis con IA completado', 'success');
    } else {
      throw new Error('Respuesta inesperada de la API');
    }
  })
  .catch(error => {
    hideLoading();
    console.error('Error en an√°lisis IA:', error);
    showNotification('Error en an√°lisis IA: ' + error.message, 'error');
  });
}

// ============================================
// CONFIGURACI√ìN DE EVENT LISTENERS
// ============================================

function setupEventListeners() {
  // Botones de an√°lisis
  document.getElementById('runMonteCarloBtn').addEventListener('click', runMonteCarlo);
  document.getElementById('calculateOptimalRouteBtn').addEventListener('click', calculateOptimalRoute);
  document.getElementById('calculateLogisticRiskBtn').addEventListener('click', calculateLogisticRisk);
  document.getElementById('runSeasonalAnalysisBtn').addEventListener('click', runSeasonalAnalysis);
  document.getElementById('runStrategicAIBtn').addEventListener('click', runStrategicAI);
  
  // Botones de datos
  document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
  document.getElementById('resetFiltersBtn').addEventListener('click', resetFilters);
  
  // Botones de pitch
  document.getElementById('generatePitchBtn').addEventListener('click', generatePitch);
  document.getElementById('clearPitchBtn').addEventListener('click', clearPitch);
  document.getElementById('savePitchBtn').addEventListener('click', savePitch);
  document.getElementById('copyPitchBtn').addEventListener('click', copyPitch);
  document.getElementById('savePitchAsReportBtn').addEventListener('click', savePitchAsReport);
  
  // Botones de rutas
  document.getElementById('calculateRouteBtn').addEventListener('click', calculateRouteForRoutesSection);
  document.getElementById('visualizeRouteBtn').addEventListener('click', visualizeRoute);
  
  // Botones de reportes
  document.getElementById('generateSalesReportBtn').addEventListener('click', generateSalesReport);
  document.getElementById('generateStrategicReportBtn').addEventListener('click', generateStrategicReport);
  document.getElementById('generateRiskReportBtn').addEventListener('click', generateRiskReport);
  
  // Botones de configuraci√≥n
  document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
  document.getElementById('exportDataBtn').addEventListener('click', exportData);
  document.getElementById('clearAllDataBtn').addEventListener('click', clearAllData);
  
  // Overlay del mapa
  document.getElementById('toggleOverlayBtn').addEventListener('click', function(e) {
    e.stopPropagation();
    toggleMapOverlay();
  });
  
  // üî¥ ‚≠ê INICIALIZAR BOT√ìN DE AN√ÅLISIS COMPLETO
  initRunCompleteAnalysisButton();
}

// ============================================
// FUNCIONES BAYESIANAS Y DE OPTIMIZACI√ìN
// ============================================

function calculateBayesianProbabilities() {
  if (filteredData.length === 0) return null;
  
  const zones = [...new Set(filteredData.map(d => d.zona))];
  const probabilities = {};
  
  zones.forEach(zone => {
    probabilities[zone] = {};
    for (let hour = 8; hour <= 20; hour++) {
      probabilities[zone][hour] = bayesianConversionProbability(
        zone, 
        hour, 
        filteredData
      );
    }
  });
  
  return probabilities;
}

function bayesianConversionProbability(zone, hour, data) {
  const zoneData = data.filter(d => d.zona === zone);
  if (zoneData.length === 0) return 0.3;
  
  const hourData = zoneData.filter(d => {
    const saleHour = parseInt(d.hora.split(':')[0]);
    return saleHour === hour;
  });
  
  if (hourData.length === 0) return 0.3;
  
  const totalAmount = hourData.reduce((sum, d) => sum + d.monto, 0);
  const avgAmount = totalAmount / hourData.length;
  
  const maxAmount = 1000;
  const probability = Math.min(avgAmount / maxAmount, 0.9);
  
  return probability;
}

function displayOptimalVisitingHours() {
  const probs = calculateBayesianProbabilities();
  if (!probs) return;
  
  const optimalHours = {};
  Object.keys(probs).forEach(zone => {
    const hours = Object.entries(probs[zone])
      .sort((a, b) => b[1] - a[1])
      .slice(0, 3)
      .map(([hour, prob]) => `${hour}:00 (${(prob*100).toFixed(1)}%)`);
    
    optimalHours[zone] = hours;
  });
  
  const container = document.getElementById('optimalHoursDisplay') || 
    (() => {
      const div = document.createElement('div');
      div.id = 'optimalHoursDisplay';
      div.className = 'control-group';
      document.querySelector('#routes .control-group').appendChild(div);
      return div;
    })();
  
  container.innerHTML = `
    <h3><i class="fas fa-clock"></i> Horarios √ìptimos por Zona (Bayesiano)</h3>
    ${Object.entries(optimalHours).map(([zone, hours]) => `
      <div class="form-group">
        <label><span class="zone-badge zone-${zone}">${zone}</span></label>
        <div>${hours.join(', ')}</div>
      </div>
    `).join('')}
  `;
}

// ============================================
// CLASE ORQUESTADOR DE AN√ÅLISIS
// ============================================

class AnalyticsOrchestrator {
  constructor(data) {
    this.data = data;
    this.results = {};
  }
  
  async loadAllModules() {
    if (!knowledgeBase) throw new Error('Knowledgebase no disponible');
    console.log('‚úÖ M√≥dulos cargados');
    return {};
  }
  
  async runCompleteAnalysis(options = {}) {
    const modulesUsed = [];
    const results = {};
    
    if (options.runBayesian !== false && this.data.length > 0) {
      results.bayesian = this.runBayesianAnalysis();
      modulesUsed.push('An√°lisis Bayesiano');
    }
    if (options.runTimeSeries !== false && this.data.length > 0) {
      results.timeseries = this.runTimeSeriesAnalysis();
      modulesUsed.push('Series de Tiempo');
    }
    if (options.runSaturation !== false && this.data.length > 0) {
      results.saturation = this.runSaturationAnalysis();
      modulesUsed.push('Saturaci√≥n de Mercado');
    }
    if (options.runMarkov !== false && this.data.length > 0) {
      results.markov = this.runMarkovAnalysis();
      modulesUsed.push('Cadenas de Markov');
    }
    if (options.runMonteCarlo !== false && this.data.length > 0) {
      results.montecarlo = this.runMonteCarloAnalysis();
      modulesUsed.push('Simulaci√≥n Monte Carlo');
    }
    
    this.results = results;
    return {modulesUsed, dataPoints: this.data.length, results, timestamp: new Date().toISOString(), success: true};
  }
  
  runBayesianAnalysis() {
    const zones = [...new Set(this.data.map(d => d.zona))];
    const analysis = {};
    zones.forEach(zone => {
      const zoneData = this.data.filter(d => d.zona === zone);
      const amounts = zoneData.map(d => d.monto);
      const media = amounts.reduce((a, b) => a + b, 0) / amounts.length;
      analysis[zone] = {count: zoneData.length, average: media.toFixed(2)};
    });
    return analysis;
  }
  
  runTimeSeriesAnalysis() {
    const hourly = {};
    for (let i = 0; i < 24; i++) {
      hourly[i] = this.data.filter(d => parseInt(d.hora.split(':')[0]) === i).reduce((sum, d) => sum + d.monto, 0);
    }
    return {hourlyDistribution: hourly};
  }
  
  runSaturationAnalysis() {
    const zones = [...new Set(this.data.map(d => d.zona))];
    const totalSales = this.data.reduce((sum, d) => sum + d.monto, 0);
    return zones.reduce((acc, zone) => {
      const zoneSales = this.data.filter(d => d.zona === zone).reduce((sum, d) => sum + d.monto, 0);
      acc[zone] = {sales: zoneSales.toFixed(2), saturation: (zoneSales / totalSales * 100).toFixed(1)};
      return acc;
    }, {});
  }
  
  runMarkovAnalysis() {
    return {transitions: 'An√°lisis de transiciones completado'};
  }
  
  runMonteCarloAnalysis() {
    const montos = this.data.map(d => d.monto);
    const media = montos.reduce((a, b) => a + b) / montos.length;
    return {media: media.toFixed(2), iterations: 5000};
  }
  
  exportResults() { return JSON.stringify(this.results, null, 2); }
}

// ============================================
// CARGA DE DATOS DE REFERENCIA
// ============================================

/**
 * Cargar archivos JSON de referencia (zonas, pitches, perfiles)
 */
async function loadReferenceData() {
  try {
    console.log('üìÇ Cargando datos de referencia...');
    
    const [zonesRes, pitchesRes, socioRes, originsRes] = await Promise.all([
      fetch('./data/zonas.json'),
      fetch('./data/pitchTypes.json'),
      fetch('./data/socioeconomicProfiles.json'),
      fetch('./data/clientOrigins.json')
    ]);
    
    // Verificar que todas las respuestas sean ok
    if (!zonesRes.ok) throw new Error(`zones.json: ${zonesRes.status} ${zonesRes.statusText}`);
    if (!pitchesRes.ok) throw new Error(`pitchTypes.json: ${pitchesRes.status} ${pitchesRes.statusText}`);
    if (!socioRes.ok) throw new Error(`socioeconomicProfiles.json: ${socioRes.status} ${socioRes.statusText}`);
    if (!originsRes.ok) throw new Error(`clientOrigins.json: ${originsRes.status} ${originsRes.statusText}`);
    
    // Parsear JSON
    const zonesData = await zonesRes.json();
    const pitchesData = await pitchesRes.json();
    const socioData = await socioRes.json();
    const originsData = await originsRes.json();
    
    console.log('üì¶ Datos recibidos:');
    console.log('   zonesData:', zonesData);
    console.log('   pitchesData:', pitchesData);
    console.log('   socioData:', socioData);
    console.log('   originsData:', originsData);
    
    // Guardar en window para acceso global
    // ‚úÖ CORREGIR: Manejar ambas estructuras (anidada y plana)
    window.referenceData = {
      zones: {
        zones: zonesData.zones || zonesData || []
      },
      pitches: {
        pitches: pitchesData.pitches || pitchesData || []
      },
      socioeconomic: socioData || {},
      origins: {
        clientOrigins: originsData.clientOrigins || originsData || []
      }
    };
    
    console.log('‚úÖ Datos de referencia cargados correctamente');
    console.log('   Zonas:', window.referenceData.zones.zones?.length || 0);
    console.log('   Pitch types:', window.referenceData.pitches.pitches?.length || 0);
    console.log('   Client origins:', window.referenceData.origins.clientOrigins?.length || 0);
    
    return true;
  } catch (error) {
    console.error('‚ùå Error cargando datos de referencia:', error.message);
    console.warn('‚ö†Ô∏è Usando datos por defecto (vac√≠os)');
    
    // Crear estructura vac√≠a pero v√°lida
    window.referenceData = { 
      zones: { zones: [] }, 
      pitches: { pitches: [] }, 
      socioeconomic: {},
      origins: { clientOrigins: [] }
    };
    
    return false;
  }
}

// ============================================
// INICIALIZACI√ìN DE LA APLICACI√ìN
// ============================================

// Inicializar la aplicaci√≥n cuando se carga la p√°gina
 window.onload = async function() {
  console.log('üöÄ Inicializando Geo-Suite Canc√∫n PRO...');
  
  // ‚úÖ PASO 2: CARGAR DATOS PERSISTIDOS
  window.capturedRecords = JSON.parse(localStorage.getItem('capturedRecords')) || [];
  console.log(`‚úÖ ${window.capturedRecords.length} registros capturados cargados del localStorage`);
  
  // ‚úÖ PASO 6: Actualizar widget m√≥vil
  updateCaptureCountBadge();
  
  // Cargar datos de referencia PRIMERO
  await loadReferenceData();
  
  // Configurar event listeners
  setupEventListeners();
  
  // Cargar knowledgebase
  loadKnowledgeBase();
  
  // Cargar configuraci√≥n guardada
  const savedApiKey = localStorage.getItem('groqApiKey');
  if (savedApiKey) {
    document.getElementById('apiKey').value = savedApiKey;
    document.getElementById('apiKeyConfig').value = savedApiKey;
  }
  
  const savedMapboxToken = localStorage.getItem('mapboxToken');
  if (savedMapboxToken) {
    document.getElementById('mapboxToken').value = savedMapboxToken;
    mapboxgl.accessToken = savedMapboxToken;
  }
  
  // Establecer fechas por defecto
  const today = new Date();
  const lastWeek = new Date();
  lastWeek.setDate(today.getDate() - 7);
  
  document.getElementById('dateFrom').valueAsDate = lastWeek;
  document.getElementById('dateTo').valueAsDate = today;
  
  // Cargar reportes guardados
  try {
    const savedReports = localStorage.getItem('generatedReports');
    if (savedReports) {
      generatedReports = JSON.parse(savedReports);
      updateReportsUI();
    }
  } catch (e) {
    console.error('Error cargando reportes:', e);
  }
  
  // Inicializar mapa si est√° visible
  if (document.getElementById('map-section').classList.contains('active')) {
    setTimeout(initMap, 500);
  }
  // ============================================
// INICIALIZACI√ìN DE M√ìDULOS AVANZADOS
// ============================================

async function initAdvancedModules() {
  console.log('üöÄ [initAdvancedModules] Iniciando...');
  
  // Validaci√≥n cr√≠tica: usar window.salesData Y window.filteredData
  const dataSource = window.salesData || window.filteredData || [];
  
  console.log('üìä [initAdvancedModules] Fuente de datos:');
  console.log('   - window.salesData:', window.salesData?.length || 0);
  console.log('   - window.filteredData:', window.filteredData?.length || 0);
  console.log('   - Usando:', dataSource.length, 'registros');
  
  if (!dataSource || dataSource.length === 0) {
    console.error('‚ùå [initAdvancedModules] No hay datos disponibles');
    showNotification('Carga datos primero para habilitar an√°lisis avanzados', 'warning');
    return;
  }
  
  // Validar que haya registros v√°lidos (no todo "unknown")
  const validRecords = dataSource.filter(r => r.zona && r.zona !== 'unknown');
  if (validRecords.length === 0) {
    console.error('‚ùå [initAdvancedModules] Todos los registros tienen zona "unknown"');
    showNotification('Los datos contienen valores "unknown" inv√°lidos', 'error');
    return;
  }
  
  console.log('‚úÖ [initAdvancedModules] Validaci√≥n de datos pasada. Registros v√°lidos:', validRecords.length);
  
  showLoading('Inicializando m√≥dulos avanzados...');
  
  try {
    // Crear el orquestador CON DATOS VALIDADOS
    console.log('üîß [initAdvancedModules] Creando AnalyticsOrchestrator...');
    window.analyticsOrchestrator = new AnalyticsOrchestrator(dataSource);
    
    // Cargar todos los m√≥dulos
    console.log('üìö [initAdvancedModules] Cargando m√≥dulos...');
    await window.analyticsOrchestrator.loadAllModules();
    
    console.log('‚úÖ [initAdvancedModules] M√≥dulos cargados exitosamente');
    showNotification('M√≥dulos avanzados cargados correctamente', 'success');
    hideLoading();
    
    // Habilitar botones avanzados
    console.log('üéØ [initAdvancedModules] Habilitando caracter√≠sticas avanzadas...');
    enableAdvancedFeatures();
    
  } catch (error) {
    console.error('‚ùå [initAdvancedModules] Error:', error);
    console.error('   Stack:', error.stack);
    hideLoading();
    showNotification('Error cargando m√≥dulos avanzados: ' + error.message, 'error');
  }
}

function enableAdvancedFeatures() {
  // Activar botones que requieren m√≥dulos avanzados
  const advancedButtons = [
    'runMonteCarloBtn',
    'calculateOptimalRouteBtn',
    'runSeasonalAnalysisBtn'
  ];
  
  advancedButtons.forEach(btnId => {
    const btn = document.getElementById(btnId);
    if (btn) {
      btn.disabled = false;
      btn.title = '';
    }
  });
}
console.log('‚úÖ Aplicaci√≥n lista');
};

// Registrar Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./serviceworker.js')
      .then((registration) => {
        console.log('‚úÖ Service Worker registrado correctamente');
        
        // Detectar actualizaciones
        registration.addEventListener('updatefound', () => {
          const newWorker = registration.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // Hay una nueva versi√≥n disponible
              console.log('üì¶ Nueva versi√≥n disponible');
              showNotification('Una nueva versi√≥n est√° disponible. Recarga para actualizar.', 'info');
            }
          });
        });
      })
      .catch((error) => {
        console.warn('‚ö†Ô∏è Error registrando Service Worker:', error);
      });
  });
}

// Guardar datos al salir
window.addEventListener('beforeunload', function() {
  try {
    localStorage.setItem('generatedReports', JSON.stringify(generatedReports));
  } catch (e) {
    console.error('Error guardando reportes:', e);
  }
}); 

/* =============================================
   L√ìGICA DE AN√ÅLISIS CRUZADO (CROSS-ANALYSIS)
   ============================================= */

let currentAnalyzer = null;
let currentAnalysisData = {};
let analysisValidationReport = null;

/**
 * üîÑ SINCRONIZAR DATOS DE AN√ÅLISIS
 * Mantiene actualizado currentAnalyzer cuando cambian los filtros
 */
function syncAnalysisData(data = filteredData) {
  console.log('üîÑ Sincronizando datos de an√°lisis...');
  
  if (!data || data.length === 0) {
    currentAnalyzer = null;
    return false;
  }

  try {
    // Normalizar datos con fieldMapper si est√° disponible
    let normalizedData = data;
    if (typeof FieldMapper !== 'undefined' && FieldMapper.normalizeRecords) {
      normalizedData = FieldMapper.normalizeRecords(data);
      analysisValidationReport = FieldMapper.generateMappingReport(data);
      
      if (analysisValidationReport.warnings.length > 0) {
        console.warn('‚ö†Ô∏è Advertencias de validaci√≥n:');
        analysisValidationReport.warnings.forEach(w => console.warn('  ' + w));
      }
    }

    // Crear o actualizar el analizador
    currentAnalyzer = new CrossDimensionalAnalyzer(normalizedData);
    
    // Guardar datos procesados
    currentAnalysisData = {
      originalCount: data.length,
      normalizedCount: normalizedData.length,
      hasDemographic: currentAnalyzer.hasDemographicData,
      dimensions: currentAnalyzer.dimensions,
      timestamp: new Date().toISOString()
    };

    console.log(`‚úÖ An√°lisis sincronizado: ${normalizedData.length} registros, demogr√°fico: ${currentAnalyzer.hasDemographicData}`);
    return true;
  } catch (error) {
    console.error('‚ùå Error sincronizando an√°lisis:', error);
    currentAnalyzer = null;
    return false;
  }
}

/**
 * INICIALIZAR AN√ÅLISIS COMPLETO
 */
function initCompleteAnalysis() {
  console.log('üîç Inicializando an√°lisis cruzado...');
  
  if (!filteredData || filteredData.length === 0) {
    showNotification('‚ö†Ô∏è Por favor, carga datos CSV primero', 'warning');
    return;
  }

  try {
    // Sincronizar y validar datos
    const syncSuccess = syncAnalysisData(filteredData);
    if (!syncSuccess) {
      showNotification('‚ùå Error al validar datos para an√°lisis', 'error');
      return;
    }

    // Mostrar advertencia si no hay datos demogr√°ficos
    if (!currentAnalyzer.hasDemographicData) {
      showNotification('‚ö†Ô∏è Sin datos demogr√°ficos - An√°lisis limitado a Origen √ó Pitch √ó Zona', 'warning');
    }

    // Cargar datos iniciales
    renderDemographicAnalysis();
    renderOriginAnalysis();
    
    // Activar event listeners
    setupAnalysisEventListeners();
    
    console.log('‚úÖ An√°lisis inicializado correctamente');
    showNotification('‚úÖ An√°lisis cargado exitosamente', 'success');
  } catch (error) {
    console.error('‚ùå Error en an√°lisis:', error);
    showNotification('‚ùå Error al procesar an√°lisis: ' + error.message, 'error');
  }
}

/**
 * RENDERIZAR AN√ÅLISIS DEMOGR√ÅFICO
 */
function renderDemographicAnalysis() {
  if (!currentAnalyzer) return;

  // Mostrar advertencia si no hay datos demogr√°ficos
  const demographicSection = document.getElementById('demographicAnalysis');
  if (demographicSection && !currentAnalyzer.hasDemographicData) {
    demographicSection.innerHTML = `
      <div class="warning-message" style="padding: 20px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 4px;">
        <h4>‚ö†Ô∏è Datos demogr√°ficos no disponibles</h4>
        <p>El CSV no contiene informaci√≥n sobre edad, ocupaci√≥n o ingreso.</p>
        <p>Se mostrar√° √∫nicamente el an√°lisis por Origen √ó Pitch √ó Zona en la pesta√±a siguiente.</p>
      </div>
    `;
    return;
  }

  // Poblar selects de ocupaciones y zonas
  const occupations = currentAnalyzer.dimensions.occupations;
  const zones = currentAnalyzer.dimensions.zones;
  
  const occSelect = document.getElementById('demFilterOccupation');
  occupations.forEach(occ => {
    const opt = document.createElement('option');
    opt.value = occ;
    opt.textContent = occ.charAt(0).toUpperCase() + occ.slice(1);
    occSelect.appendChild(opt);
  });
  
  const zoneSelect = document.getElementById('demFilterZone');
  zones.forEach(zone => {
    const opt = document.createElement('option');
    opt.value = zone;
    opt.textContent = zone.charAt(0).toUpperCase() + zone.slice(1);
    zoneSelect.appendChild(opt);
  });

  // Renderizar visualizaci√≥n inicial
  updateDemographicVisualization();
}

/**
 * ACTUALIZAR VISUALIZACI√ìN DEMOGR√ÅFICA
 */
function updateDemographicVisualization() {
  const filters = {
    ageGroup: document.getElementById('demFilterAge').value || null,
    occupation: document.getElementById('demFilterOccupation').value || null,
    income: document.getElementById('demFilterIncome').value || null,
    zone: document.getElementById('demFilterZone').value || null,
    pitchType: document.getElementById('demFilterPitch').value || null
  };
  
  // Remover null values
  Object.keys(filters).forEach(key => filters[key] === null && delete filters[key]);
  
  const matrix = currentAnalyzer.generateDemographicMatrix(filters);
  currentAnalysisData.demographic = matrix;

  // Determinar visualizaci√≥n activa
  const vizType = document.querySelector('[data-content="demographic-analysis"] .toggle-btn.active').dataset.viz;
  
  if (vizType === 'heatmap') {
    renderDemographicHeatmap(matrix);
  } else {
    renderDemographicTable(matrix);
  }
  
  renderDemographicInsights(matrix);
}

/**
 * RENDERIZAR HEATMAP DEMOGR√ÅFICO
 */
function renderDemographicHeatmap(matrix) {
  const container = document.getElementById('demographicHeatmap');
  container.innerHTML = '';
  
  if (matrix.length === 0) {
    container.innerHTML = '<p class="text-center" style="padding: 40px; color: var(--text-secondary);">No hay datos para mostrar</p>';
    return;
  }

  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  
  // Headers
  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr style="background: linear-gradient(90deg, #38bdf8, #22c55e); color: white;">
      <th style="padding: 10px; text-align: left;">Demogr√°fico</th>
      <th style="padding: 10px; text-align: center;">Pitch</th>
      <th style="padding: 10px; text-align: center;">Zona</th>
      <th style="padding: 10px; text-align: center;">Conversi√≥n</th>
      <th style="padding: 10px; text-align: center;">Intensidad</th>
    </tr>
  `;
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  matrix.slice(0, 15).forEach((item, idx) => {
    const row = document.createElement('tr');
    row.style.borderBottom = '1px solid var(--bg-card)';
    
    const intensityColor = [
      '#ef4444', // 1 - red
      '#f97316', // 2 - orange
      '#eab308', // 3 - yellow
      '#84cc16', // 4 - lime
      '#10b981'  // 5 - green
    ][item.intensity - 1];
    
    row.innerHTML = `
      <td style="padding: 10px;">${item.ageGroup} / ${item.occupation}</td>
      <td style="padding: 10px; text-align: center;">${item.pitchType}</td>
      <td style="padding: 10px; text-align: center;">${item.zone}</td>
      <td style="padding: 10px; text-align: center; font-weight: bold;">${(item.conversionRate * 100).toFixed(1)}%</td>
      <td style="padding: 10px; text-align: center;">
        <span class="heatmap-cell" style="display: inline-block; width: 30px; height: 30px; background: ${intensityColor}; border-radius: 4px; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
          ${item.intensity}
        </span>
      </td>
    `;
    tbody.appendChild(row);
  });
  table.appendChild(tbody);
  
  container.appendChild(table);
}

/**
 * RENDERIZAR TABLA DEMOGR√ÅFICA
 */
function renderDemographicTable(matrix) {
  const container = document.getElementById('demographicTable');
  container.innerHTML = '';
  container.classList.remove('hidden');
  
  if (matrix.length === 0) {
    container.innerHTML = '<p class="text-center" style="padding: 40px; color: var(--text-secondary);">No hay datos para mostrar</p>';
    return;
  }

  const table = document.createElement('table');
  table.className = 'analysis-table';
  
  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr>
      <th>Edad</th>
      <th>Ocupaci√≥n</th>
      <th>Pitch</th>
      <th>Zona</th>
      <th>Exitosos</th>
      <th>Total</th>
      <th>Conversi√≥n</th>
      <th>Monto Promedio</th>
    </tr>
  `;
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  matrix.slice(0, 20).forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${item.ageGroup}</td>
      <td>${item.occupation}</td>
      <td>${item.pitchType}</td>
      <td>${item.zone}</td>
      <td>${item.successful}</td>
      <td>${item.total}</td>
      <td style="color: ${item.conversionRate > 0.5 ? '#22c55e' : '#ef4444'}">${(item.conversionRate * 100).toFixed(1)}%</td>
      <td>$${item.avgAmount.toFixed(2)}</td>
    `;
    tbody.appendChild(row);
  });
  table.appendChild(tbody);
  
  container.appendChild(table);
}

/**
 * RENDERIZAR INSIGHTS DEMOGR√ÅFICOS
 */
function renderDemographicInsights(matrix) {
  const container = document.getElementById('demographicInsights');
  container.innerHTML = '';
  
  const insights = currentAnalyzer.generateInsights('demographic');
  
  insights.forEach(insight => {
    const card = document.createElement('div');
    card.className = 'insight-card';
    card.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
        <span style="font-weight: bold; color: var(--accent-blue);">Ranking #${insight.rank}</span>
        <span style="background: #22c55e; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">${insight.conversionRate.toFixed(1)}</span>
      </div>
      <h4 style="margin: 8px 0;">${insight.label}</h4>
      <p style="color: var(--text-secondary); font-size: 0.9em; margin: 8px 0;">
        Pitch: <strong>${insight.pitchType}</strong> | ${insight.count} registros (${insight.successful} exitosos)
      </p>
      <p style="font-size: 0.9em; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--bg-card);">
        ${insight.recommendation}
      </p>
    `;
    container.appendChild(card);
  });
}

/**
 * RENDERIZAR AN√ÅLISIS POR ORIGEN
 */
function renderOriginAnalysis() {
  if (!currentAnalyzer) return;

  const origins = currentAnalyzer.dimensions.origins;
  
  const origSelect = document.getElementById('origFilterOrigin');
  origins.forEach(origin => {
    const opt = document.createElement('option');
    opt.value = origin;
    opt.textContent = origin.charAt(0).toUpperCase() + origin.slice(1);
    origSelect.appendChild(opt);
  });

  updateOriginVisualization();
}

/**
 * ACTUALIZAR VISUALIZACI√ìN POR ORIGEN
 */
function updateOriginVisualization() {
  const filters = {
    origin: document.getElementById('origFilterOrigin').value || null,
    pitchType: document.getElementById('origFilterPitch').value || null,
    result: document.getElementById('origFilterResult').value || null
  };
  
  Object.keys(filters).forEach(key => filters[key] === null && delete filters[key]);
  
  const matrix = currentAnalyzer.generateOriginMatrix(filters);
  currentAnalysisData.origin = matrix;

  const vizType = document.querySelector('[data-content="origin-analysis"] .toggle-btn.active').dataset.viz;
  
  if (vizType === 'heatmap') {
    renderOriginHeatmap(matrix);
  } else {
    renderOriginTable(matrix);
  }
  
  renderOriginInsights(matrix);
}

/**
 * RENDERIZAR HEATMAP DE ORIGEN
 */
function renderOriginHeatmap(matrix) {
  const container = document.getElementById('originHeatmap');
  container.innerHTML = '';
  
  if (matrix.length === 0) {
    container.innerHTML = '<p class="text-center" style="padding: 40px; color: var(--text-secondary);">No hay datos para mostrar</p>';
    return;
  }

  const table = document.createElement('table');
  table.style.width = '100%';
  table.style.borderCollapse = 'collapse';
  
  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr style="background: linear-gradient(90deg, #38bdf8, #22c55e); color: white;">
      <th style="padding: 10px; text-align: left;">Origen</th>
      <th style="padding: 10px; text-align: center;">Pitch</th>
      <th style="padding: 10px; text-align: center;">Conversi√≥n</th>
      <th style="padding: 10px; text-align: center;">Intensidad</th>
    </tr>
  `;
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  matrix.slice(0, 15).forEach(item => {
    const row = document.createElement('tr');
    row.style.borderBottom = '1px solid var(--bg-card)';
    
    const intensityColor = ['#ef4444', '#f97316', '#eab308', '#84cc16', '#10b981'][item.intensity - 1];
    
    row.innerHTML = `
      <td style="padding: 10px;">${item.origin}</td>
      <td style="padding: 10px; text-align: center;">${item.pitchType}</td>
      <td style="padding: 10px; text-align: center; font-weight: bold;">${(item.conversionRate * 100).toFixed(1)}%</td>
      <td style="padding: 10px; text-align: center;">
        <span style="display: inline-block; width: 30px; height: 30px; background: ${intensityColor}; border-radius: 4px; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
          ${item.intensity}
        </span>
      </td>
    `;
    tbody.appendChild(row);
  });
  table.appendChild(tbody);
  
  container.appendChild(table);
}

/**
 * RENDERIZAR TABLA DE ORIGEN
 */
function renderOriginTable(matrix) {
  const container = document.getElementById('originTable');
  container.innerHTML = '';
  container.classList.remove('hidden');
  
  if (matrix.length === 0) {
    container.innerHTML = '<p class="text-center" style="padding: 40px; color: var(--text-secondary);">No hay datos para mostrar</p>';
    return;
  }

  const table = document.createElement('table');
  table.className = 'analysis-table';
  
  const thead = document.createElement('thead');
  thead.innerHTML = `
    <tr>
      <th>Origen</th>
      <th>Pitch</th>
      <th>Exitosos</th>
      <th>Total</th>
      <th>Conversi√≥n</th>
      <th>Monto Promedio</th>
    </tr>
  `;
  table.appendChild(thead);
  
  const tbody = document.createElement('tbody');
  matrix.slice(0, 20).forEach(item => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${item.origin}</td>
      <td>${item.pitchType}</td>
      <td>${item.successful}</td>
      <td>${item.total}</td>
      <td style="color: ${item.conversionRate > 0.5 ? '#22c55e' : '#ef4444'}">${(item.conversionRate * 100).toFixed(1)}%</td>
      <td>$${item.avgAmount.toFixed(2)}</td>
    `;
    tbody.appendChild(row);
  });
  table.appendChild(tbody);
  
  container.appendChild(table);
}

/**
 * RENDERIZAR INSIGHTS DE ORIGEN
 */
function renderOriginInsights(matrix) {
  const container = document.getElementById('originInsights');
  container.innerHTML = '';
  
  const insights = currentAnalyzer.generateInsights('origin');
  
  insights.forEach(insight => {
    const card = document.createElement('div');
    card.className = 'insight-card';
    card.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
        <span style="font-weight: bold; color: var(--accent-blue);">Ranking #${insight.rank}</span>
        <span style="background: #22c55e; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">${insight.conversionRate.toFixed(1)}</span>
      </div>
      <h4 style="margin: 8px 0;">${insight.label}</h4>
      <p style="color: var(--text-secondary); font-size: 0.9em; margin: 8px 0;">
        Pitch: <strong>${insight.pitchType}</strong> | ${insight.count} registros (${insight.successful} exitosos)
      </p>
      <p style="font-size: 0.9em; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--bg-card);">
        ${insight.recommendation}
      </p>
    `;
    container.appendChild(card);
  });
}

/**
 * CONFIGURAR EVENT LISTENERS
 */
function setupAnalysisEventListeners() {
  
  // Tabs
  document.querySelectorAll('.analysis-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const tabName = this.dataset.tab;
      
      document.querySelectorAll('.analysis-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.analysis-content').forEach(c => c.classList.remove('active'));
      
      this.classList.add('active');
      document.querySelector(`[data-content="${tabName}"]`).classList.add('active');
    });
  });

  // Visualizaci√≥n toggle
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const parent = this.closest('.visualization-controls');
      parent.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      
      const analysisType = this.closest('.analysis-content').dataset.content.includes('demographic') ? 'demographic' : 'origin';
      
      if (analysisType === 'demographic') {
        const vizType = this.dataset.viz;
        const container = document.getElementById('demographicHeatmap').parentElement;
        document.getElementById('demographicHeatmap').classList.toggle('hidden', vizType !== 'heatmap');
        document.getElementById('demographicTable').classList.toggle('hidden', vizType !== 'table');
        if (vizType === 'table') {
          renderDemographicTable(currentAnalysisData.demographic);
        }
      } else {
        const vizType = this.dataset.viz;
        document.getElementById('originHeatmap').classList.toggle('hidden', vizType !== 'heatmap');
        document.getElementById('originTable').classList.toggle('hidden', vizType !== 'table');
        if (vizType === 'table') {
          renderOriginTable(currentAnalysisData.origin);
        }
      }
    });
  });

  // Filtros demogr√°ficos
  document.getElementById('applyDemFilters').addEventListener('click', updateDemographicVisualization);
  document.getElementById('clearDemFilters').addEventListener('click', function() {
    document.getElementById('demFilterAge').value = '';
    document.getElementById('demFilterOccupation').value = '';
    document.getElementById('demFilterIncome').value = '';
    document.getElementById('demFilterZone').value = '';
    document.getElementById('demFilterPitch').value = '';
    updateDemographicVisualization();
  });

  // Filtros de origen
  document.getElementById('applyOrigFilters').addEventListener('click', updateOriginVisualization);
  document.getElementById('clearOrigFilters').addEventListener('click', function() {
    document.getElementById('origFilterOrigin').value = '';
    document.getElementById('origFilterPitch').value = '';
    document.getElementById('origFilterResult').value = '';
    updateOriginVisualization();
  });

  // Toolbar
  document.getElementById('refreshAnalysis').addEventListener('click', function() {
    updateDemographicVisualization();
    updateOriginVisualization();
    showNotification('‚úÖ An√°lisis actualizado', 'success');
  });

  document.getElementById('exportAnalysis').addEventListener('click', function() {
    const data = {
      demographic: currentAnalysisData.demographic,
      origin: currentAnalysisData.origin,
      timestamp: new Date().toISOString()
    };
    const json = JSON.stringify(data, null, 2);
    const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `an√°lisis-cruzado-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    showNotification('‚úÖ An√°lisis exportado', 'success');
  });

  document.getElementById('printAnalysis').addEventListener('click', function() {
    window.print();
  });
}

// Inicializar cuando se cargue la p√°gina de an√°lisis
window.addEventListener('viewChange', function(e) {
  if (e.detail?.view === 'complete-analysis') {
    initCompleteAnalysis();
  }
});

// Tambi√©n inicializar cuando se cargue CSV
document.addEventListener('DOMContentLoaded', function() {
  const origApplyBtn = document.getElementById('applyFiltersBtn');
  if (origApplyBtn) {
    const originalClick = origApplyBtn.onclick;
    origApplyBtn.addEventListener('click', function() {
      // Despu√©s de cargar datos, inicializar an√°lisis
      setTimeout(initCompleteAnalysis, 500);
    });
  }
});

console.log('‚úÖ M√≥dulo de an√°lisis cruzado cargado correctamente');

/**
 * ============================================================================
 * CAPTURA DE DATOS EN VIVO CON COORDENADAS GPS
 * ============================================================================
 * Sistema para capturar datos de ventas en tiempo real con ubicaci√≥n autom√°tica
 */

// Almacenamiento global de registros capturados
window.capturedRecords = [];
window.currentCoordinates = { lat: null, lng: null, accuracy: null };

/**
 * Capturar ubicaci√≥n GPS usando Geolocation API
 */
function captureLocationGPS() {
  const btn = document.getElementById('captureLocationBtn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Capturando...';
  
  if (!navigator.geolocation) {
    showNotification('‚ùå Geolocalizaci√≥n no disponible en este navegador', 'error');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-location-arrow"></i> Obtener Ubicaci√≥n GPS';
    return;
  }
  
  navigator.geolocation.getCurrentPosition(
    function(position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      const accuracy = position.coords.accuracy;
      
      window.currentCoordinates = { lat, lng, accuracy };
      
      // Mostrar ubicaci√≥n
      document.getElementById('locationStatus').style.display = 'block';
      document.getElementById('coordsDisplay').textContent = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      document.getElementById('accuracyDisplay').textContent = `¬±${accuracy.toFixed(0)} metros`;
      
      // Detectar zona autom√°ticamente
      detectZoneFromCoordinates(lat, lng);
      
      showNotification(`‚úÖ Ubicaci√≥n capturada: ${lat.toFixed(4)}, ${lng.toFixed(4)}`, 'success');
      
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-location-arrow"></i> Obtener Ubicaci√≥n GPS';
    },
    function(error) {
      console.error('Error de geolocalizaci√≥n:', error);
      showNotification(`‚ùå Error: ${error.message}`, 'error');
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-location-arrow"></i> Obtener Ubicaci√≥n GPS';
    },
    {
      enableHighAccuracy: true,
      timeout: 10000,
      maximumAge: 0
    }
  );
}

/**
 * Detectar zona desde coordenadas usando Mapbox
 */
function detectZoneFromCoordinates(lat, lng) {
  if (!window.map) {
    document.getElementById('zoneDetected').textContent = 'Mapa no disponible';
    return;
  }
  
  // Usar la funci√≥n de Mapbox para obtener features en el punto
  const features = window.map.querySourceFeatures('zonas-geojson', {
    sourceLayer: 'zonas'
  });
  
  // Buscar zona m√°s cercana basada en distancia
  const zones = window.referenceData?.zones || [];
  let closestZone = null;
  let minDistance = Infinity;
  
  zones.forEach(zone => {
    const zoneLat = zone.coordinates[0];
    const zoneLng = zone.coordinates[1];
    const distance = Math.sqrt(Math.pow(lat - zoneLat, 2) + Math.pow(lng - zoneLng, 2));
    
    if (distance < minDistance) {
      minDistance = distance;
      closestZone = zone;
    }
  });
  
  if (closestZone) {
    document.getElementById('zoneDetected').textContent = closestZone.name;
    document.getElementById('captureZone').value = closestZone.id;
  }
}

/**
 * Guardar registro de captura
 */
function saveCapturedRecord() {
  // ‚úÖ VALIDAR ZONA OBLIGATORIA
  const zone = document.getElementById('captureZone').value;
  if (!zone) {
    showNotification('‚ö†Ô∏è Por favor selecciona una Zona', 'warning');
    return;
  }
  
  // Obtener datos del formulario
  const record = {
    id: 'capture_' + Date.now(),
    timestamp: new Date().toISOString(),
    date: new Date().toLocaleString('es-MX'),
    latitude: window.currentCoordinates.lat,
    longitude: window.currentCoordinates.lng,
    accuracy: window.currentCoordinates.accuracy,
    clientOrigin: document.getElementById('captureOrigin').value,
    pitchType: document.getElementById('capturePitch').value,
    result: document.getElementById('captureResult').value,
    amount: parseFloat(document.getElementById('captureAmount').value) || 0,
    zone: zone,
    demographic: {
      age: document.getElementById('captureAge').value,
      occupation: document.getElementById('captureOccupation').value,
      income: document.getElementById('captureIncome').value
    }
  };
  
  // Validaci√≥n
  if (!record.clientOrigin) {
    showNotification('‚ùå Selecciona origen del cliente', 'error');
    return;
  }
  if (!record.pitchType) {
    showNotification('‚ùå Selecciona tipo de pitch', 'error');
    return;
  }
  if (!record.result) {
    showNotification('‚ùå Selecciona resultado', 'error');
    return;
  }
  if (record.latitude === null) {
    showNotification('‚ö†Ô∏è Captura primero tu ubicaci√≥n GPS', 'warning');
    return;
  }
  
  // ‚úÖ PASO 2: Persistir en localStorage
  let allRecords = JSON.parse(localStorage.getItem('capturedRecords')) || [];
  allRecords.push(record);
  localStorage.setItem('capturedRecords', JSON.stringify(allRecords));
  
  // Actualizar en memoria
  window.capturedRecords = allRecords;
  
  // Actualizar tabla
  updateCapturedRecordsTable();
  
  // ‚úÖ PASO 4: Sincronizar con an√°lisis
  setTimeout(() => {
    syncCapturedDataWithAnalytics();
  }, 300);
  
  // ‚úÖ PASO 6: Actualizar badge m√≥vil
  updateCaptureCountBadge();
  
  // Limpiar formulario
  clearCaptureForm();
  
  showNotification(`‚úÖ Registro guardado (${window.capturedRecords.length} total)`, 'success');
}

/**
 * Eliminar registro capturado (NUEVA VERSI√ìN CON LOCALSTORAGE)
 */
function deleteCapturedRecord(idx) {
  if (confirm('¬øEliminar este registro?')) {
    // Obtener del localStorage
    let allRecords = JSON.parse(localStorage.getItem('capturedRecords')) || [];
    // Remover por √≠ndice
    allRecords.splice(idx, 1);
    // Guardar de vuelta
    localStorage.setItem('capturedRecords', JSON.stringify(allRecords));
    // Actualizar en memoria
    window.capturedRecords = allRecords;
    // Actualizar tabla
    updateCapturedRecordsTable();
    // Actualizar badge m√≥vil
    updateCaptureCountBadge();
    // Sincronizar con an√°lisis
    syncCapturedDataWithAnalytics();
    showNotification('‚úÖ Registro eliminado', 'success');
  }
}

/**
 * Actualizar tabla de registros capturados
 */
function updateCapturedRecordsTable() {
  const tbody = document.getElementById('capturedRecordsBody');
  const countEl = document.getElementById('recordsCount');
  
  // ‚úÖ PASO 2: Leer desde localStorage
  const records = JSON.parse(localStorage.getItem('capturedRecords')) || [];
  window.capturedRecords = records;
  
  countEl.textContent = `${records.length} registros`;
  
  if (records.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: var(--text-secondary);">No hay registros capturados a√∫n</td></tr>';
    return;
  }
  
  tbody.innerHTML = records.map((record, idx) => `
    <tr>
      <td>${record.date}</td>
      <td>${record.clientOrigin}</td>
      <td>${record.pitchType}</td>
      <td><span class="badge badge-${record.result === 'successful' ? 'success' : record.result === 'failed' ? 'error' : 'warning'}">${record.result}</span></td>
      <td>$${record.amount.toFixed(2)}</td>
      <td>${record.zone}</td>
      <td><small>${record.latitude?.toFixed(4)}, ${record.longitude?.toFixed(4)}</small></td>
      <td>
        <button class="btn btn-xs btn-danger" onclick="deleteCapturedRecord(${idx})">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    </tr>
  `).join('');
}

/**
 * Eliminar registro capturado
 */
function deleteCaptuiredRecord(idx) {
  // ‚ö†Ô∏è FUNCI√ìN OBSOLETA - Mantener por compatibilidad, delega a deleteCapturedRecord
  deleteCapturedRecord(idx);
}

/**
 * Limpiar formulario de captura
 */
function clearCaptureForm() {
  document.getElementById('captureOrigin').value = '';
  document.getElementById('capturePitch').value = '';
  document.getElementById('captureResult').value = '';
  document.getElementById('captureAmount').value = '';
  document.getElementById('captureAge').value = '';
  document.getElementById('captureOccupation').value = '';
  document.getElementById('captureIncome').value = '';
}

/**
 * ‚úÖ PASO 4: SINCRONIZAR DATOS CAPTURADOS CON AN√ÅLISIS
 * Integra registros capturados con m√≥dulos de an√°lisis
 */
function syncCapturedDataWithAnalytics() {
  try {
    const capturedRecords = JSON.parse(localStorage.getItem('capturedRecords')) || [];
    if (capturedRecords.length === 0) return;
    
    console.log(`üîÑ Sincronizando ${capturedRecords.length} registros capturados con an√°lisis...`);
    
    // Usar FieldMapper si est√° disponible
    if (window.FieldMapper) {
      const normalizedRecords = window.FieldMapper.normalizeRecords(capturedRecords);
      
      // Agregar a window.salesData si existe
      if (window.salesData && Array.isArray(window.salesData)) {
        // Evitar duplicados por timestamp
        const existingTimestamps = new Set(window.salesData.map(r => r.timestamp));
        const newRecords = normalizedRecords.filter(r => !existingTimestamps.has(r.timestamp));
        window.salesData = [...window.salesData, ...newRecords];
        console.log(`‚úÖ +${newRecords.length} registros agregados a salesData`);
      }
      
      // Re-inicializar an√°lisis si est√° abierto
      if (window.currentAnalyzer && window.currentAnalyzer.initCompleteAnalysis) {
        window.currentAnalyzer.initCompleteAnalysis();
        console.log(`üîÑ An√°lisis Cruzado actualizado con nuevos datos`);
      }
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è Error en sincronizaci√≥n:', error.message);
  }
}

/**
 * ‚úÖ PASO 6: ACTUALIZAR BADGE CONTADOR M√ìVIL
 */
function updateCaptureCountBadge() {
  const capturedRecords = JSON.parse(localStorage.getItem('capturedRecords')) || [];
  const widget = document.getElementById('mobileCaptureWidget');
  const countSpan = document.getElementById('mobileCaptureCount');
  
  if (widget && countSpan) {
    countSpan.textContent = capturedRecords.length;
    widget.style.display = capturedRecords.length > 0 ? 'block' : 'none';
  }
}

/**
 * Exportar registros capturados como CSV con coordenadas
 */
function exportCapturedRecordsAsCSV() {
  if (window.capturedRecords.length === 0) {
    showNotification('‚ùå No hay registros para exportar', 'error');
    return;
  }
  
  // Encabezados del CSV (en el orden exacto para el an√°lisis)
  const headers = [
    'timestamp',
    'zone',
    'client_origin',
    'pitch_type',
    'result',
    'amount',
    'age_group',
    'occupation',
    'income_level',
    'latitude',
    'longitude',
    'accuracy_meters'
  ];
  
  // Convertir registros a filas CSV
  const rows = window.capturedRecords.map(record => [
    record.timestamp,
    record.zone || '',
    record.clientOrigin,
    record.pitchType,
    record.result,
    record.amount,
    record.demographic.age || '',
    record.demographic.occupation || '',
    record.demographic.income || '',
    record.latitude,
    record.longitude,
    record.accuracy
  ]);
  
  // Crear CSV
  const csvContent = [
    headers.join(','),
    ...rows.map(row => row.map(cell => {
      // Escapar comillas en celdas
      const str = String(cell);
      return str.includes(',') || str.includes('"') ? `"${str.replace(/"/g, '""')}"` : str;
    }).join(','))
  ].join('\n');
  
  // Descargar
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', `sales_data_${new Date().toISOString().split('T')[0]}.csv`);
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showNotification(`‚úÖ Exportados ${window.capturedRecords.length} registros a CSV`, 'success');
}

/**
 * Generar CSV de ejemplo con coordenadas de Canc√∫n
 */
function generateExampleCSV() {
  const exampleData = [
    {
      timestamp: '2026-01-10T09:30:00',
      zone: 'zona_hotelera',
      client_origin: 'cdmx',
      pitch_type: 'autoridad',
      result: 'successful',
      amount: 450,
      age_group: '36-45',
      occupation: 'professional',
      income_level: 'high',
      latitude: 21.1356,
      longitude: -86.7459
    },
    {
      timestamp: '2026-01-10T10:15:00',
      zone: 'centro',
      client_origin: 'cancun_local',
      pitch_type: 'comunidad',
      result: 'failed',
      amount: 0,
      age_group: '26-35',
      occupation: 'artisan',
      income_level: 'lower_middle',
      latitude: 21.1603,
      longitude: -86.8524
    }
  ];
  
  const headers = ['timestamp', 'zone', 'client_origin', 'pitch_type', 'result', 'amount', 'age_group', 'occupation', 'income_level', 'latitude', 'longitude'];
  
  const csv = [
    headers.join(','),
    ...exampleData.map(row => headers.map(h => {
      const val = row[h];
      return typeof val === 'string' && val.includes(',') ? `"${val}"` : val;
    }).join(','))
  ].join('\n');
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'ejemplo_captura_interna.csv';
  a.click();
  
  showNotification('‚úÖ CSV de ejemplo generado', 'success');
}

/**
 * Inicializar event listeners para captura
 */
function initializeCapturePanel() {
  // Capturar ubicaci√≥n
  const captureLocationBtn = document.getElementById('captureLocationBtn');
  if (captureLocationBtn) {
    captureLocationBtn.addEventListener('click', captureLocationGPS);
  }
  
  // Detectar zona
  const autoDetectZoneBtn = document.getElementById('autoDetectZoneBtn');
  if (autoDetectZoneBtn) {
    autoDetectZoneBtn.addEventListener('click', function() {
      if (window.currentCoordinates.lat) {
        detectZoneFromCoordinates(window.currentCoordinates.lat, window.currentCoordinates.lng);
        showNotification('‚úÖ Zona detectada autom√°ticamente', 'success');
      } else {
        showNotification('‚ö†Ô∏è Captura primero tu ubicaci√≥n', 'warning');
      }
    });
  }
  
  // Guardar registro
  const saveRecordBtn = document.getElementById('saveRecordBtn');
  if (saveRecordBtn) {
    saveRecordBtn.addEventListener('click', saveCapturedRecord);
  }

  
  // Limpiar formulario
  const clearRecordBtn = document.getElementById('clearRecordBtn');
  if (clearRecordBtn) {
    clearRecordBtn.addEventListener('click', clearCaptureForm);
  }
  
  // Exportar CSV
  const exportCapturedCSVBtn = document.getElementById('exportCapturedCSVBtn');
  if (exportCapturedCSVBtn) {
    exportCapturedCSVBtn.addEventListener('click', exportCapturedRecordsAsCSV);
  }
  
  // Borrar todos
  const clearAllRecordsBtn = document.getElementById('clearAllRecordsBtn');
  if (clearAllRecordsBtn) {
    clearAllRecordsBtn.addEventListener('click', function() {
      if (window.capturedRecords.length === 0) {
        showNotification('‚ùå No hay registros para borrar', 'info');
        return;
      }
      if (confirm(`¬øEliminar todos los ${window.capturedRecords.length} registros?`)) {
        window.capturedRecords = [];
        updateCapturedRecordsTable();
        showNotification('‚úÖ Todos los registros eliminados', 'success');
      }
    });
  }
  
  // Generar CSV de ejemplo
  const generateCSVBtn = document.getElementById('generateCSVBtn');
  if (generateCSVBtn) {
    generateCSVBtn.addEventListener('click', generateExampleCSV);
  }
  
  console.log('‚úÖ Panel de captura inicializado');
}

// Inicializar cuando cargue la p√°gina
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(initializeCapturePanel, 500);
});

console.log('‚úÖ Sistema de captura de datos en vivo cargado');

</script>
</body>
</html>